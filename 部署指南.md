# POS 系統部署指南

本文檔提供「吃雞排找不早 POS 系統」的詳細部署步驟，涵蓋後端 Firebase Cloud Functions、Firestore 資料庫、顧客 PWA 以及管理後台 PWA。

## 1. 環境準備

在開始部署之前，請確保您的開發環境已安裝以下工具：

*   **Node.js**: 建議使用 LTS 版本 (例如 18.x 或更高版本)。您可以從 [Node.js 官網](https://nodejs.org/) 下載並安裝。
*   **Firebase CLI**: Google 提供的 Firebase Command Line Interface。安裝 Node.js 後，可以通過 npm 全局安裝：
    ```bash
    npm install -g firebase-tools
    ```
    安裝完成後，登入您的 Google 帳戶：
    ```bash
    firebase login
    ```
*   **Git**: 用於獲取原始碼。您可以從 [Git 官網](https://git-scm.com/) 下載並安裝。

### Firebase 專案設定

1.  確保您已經在 [Firebase 控制台](https://console.firebase.google.com/) 創建了一個 Firebase 專案。
2.  在本專案的根目錄下，使用 Firebase CLI 初始化您的本地環境以連接到您的 Firebase 專案：
    ```bash
    firebase use --add
    ```
    然後從列表中選擇您的 Firebase 專案 ID，並為其設定一個本地別名（例如 `default` 或您的專案名稱）。
3.  確保您的專案已啟用 **Firestore** 資料庫和 **Firebase Authentication** (包括電話號碼登入方法)。
4.  記下您的 Firebase 專案 ID，後續配置中可能會用到。

## 2. 後端部署 (Firebase Cloud Functions)

後端服務基於 Firebase Cloud Functions，使用 TypeScript 編寫。

### 2.1 獲取原始碼

如果您尚未獲取原始碼，請通過 Git clone：
```bash
# 假設您已在專案根目錄
cd functions
```
或者確保您位於專案的 `functions` 目錄下。

### 2.2 環境變數配置

Cloud Functions 需要配置一些環境變數才能正常運行，特別是與 LINE Pay 等外部服務對接的密鑰。

**重要**: 切勿將密鑰等敏感資訊直接硬編碼到原始碼中或提交到版本控制系統。
請使用 Firebase Functions 的環境配置功能。

在 `functions` 目錄下，執行以下命令設置環境變數。請將 `<PLACEHOLDER>`替換為您的實際值：

```bash
firebase functions:config:set linepay.channel_id="2007360636"
firebase functions:config:set linepay.secret_key="f9a8788af9226442a183bb903f6af627"
firebase functions:config:set linepay.api_url="https://sandbox-api-pay.line.me" # 或正式環境 URL
firebase functions:config:set linepay.confirm_base_url="https://us-central1-friedg.cloudfunctions.net/paymentsApiV2/line" # 例如 https://<region>-<project-id>.cloudfunctions.net/paymentsApiV2/line
firebase functions:config:set linepay.cancel_base_url="https://friedg.web.app/checkout/cancel" # 例如 https://your-project-id.web.app/checkout/cancel

firebase functions:config:set customer_pwa.base_url="https://friedg.web.app" # 例如 https://your-project-id.web.app
firebase functions:config:set cloud_function.base_url="https://us-central1-friedg.cloudfunctions.net" # 例如 https://<region>-<project-id>.cloudfunctions.net

# 其他可能的配置 (根據實際需求調整)
# firebase functions:config:set some_service.api_key="ANOTHER_KEY"
```

*   `LINE_PAY_CHANNEL_ID`: 您的 LINE Pay Channel ID。
*   `LINE_PAY_CHANNEL_SECRET_KEY`: 您的 LINE Pay Channel Secret Key。
*   `CLOUD_FUNCTION_BASE_URL`: 您部署後 Cloud Functions 的基礎 URL。通常格式為 `https://<region>-<your-project-id>.cloudfunctions.net` (此處範例使用 `https://us-central1-friedg.cloudfunctions.net`)。
*   `CUSTOMER_PWA_BASE_URL`: 您部署後顧客 PWA 的基礎 URL (此處範例使用 `https://friedg.web.app`)。
*   `CUSTOMER_PWA_CHECKOUT_CANCEL_URL`: 顧客 PWA 中用於 LINE Pay 取消支付後跳轉的頁面 URL (此處範例使用 `https://friedg.web.app/checkout/cancel`)。

配置完成後，可以通過以下命令查看已配置的環境變數：
```bash
firebase functions:config:get
```
這些配置會在部署時應用到您的 Cloud Functions 環境中。

### 2.3 安裝依賴

在 `functions` 目錄下，安裝 Node.js 依賴：
```bash
npm install
```

### 2.4 TypeScript 編譯

由於原始碼是 TypeScript (`.ts`)，需要先編譯成 JavaScript (`.js`)才能部署。
在 `functions` 目錄下，執行編譯命令 (通常在 `package.json` 的 `scripts` 中定義，例如 `build`):

```bash
npm run build
```
此命令會執行 `tsc` (TypeScript Compiler)，將 `src` 目錄下的 `.ts` 檔案編譯到 `lib` 目錄（或 `tsconfig.json` 中 `outDir` 指定的目錄）。**請確保 `firebase.json` 中 `functions.source` 指向這個編譯輸出的目錄 (例如 `functions/lib`)，或者如果 `firebase.json` 中 `functions.predeploy` 鉤子已經包含了編譯步驟，則 `functions.source` 應指向包含 `package.json` 和源碼的目錄 (例如 `functions`)。**

*檢視 `snapshot_new.md`，其中 `functions` 目錄結構已不包含 `lib`。這表示 `functions.source` 在 `firebase.json` 中應為 `"functions"` (指向包含 `package.json` 和 `src` 的目錄)，並且部署前會執行編譯。如果 `firebase.json` 中沒有 `predeploy` 編譯鉤子，則需要手動編譯，且 `functions.source` 應指向編譯輸出目錄。為通用性，此處假設需要手動編譯後，部署指向 `lib`。用戶需根據其 `firebase.json` 的 `functions` 配置調整。*

**標準做法建議**：在 `firebase.json` 的 `functions` 部分配置 `predeploy` 腳本來自動執行編譯，例如：
```json
{
  "functions": {
    "source": "functions", // 指向包含 package.json 和 src 的目錄
    "predeploy": [
      "npm --prefix \"$RESOURCE_DIR\" run build"
    ]
    // ... 其他配置
  }
}
```
如果採用此 `predeploy` 方式，則手動執行 `npm run build` 雖然無害，但已包含在部署流程中。如果沒有 `predeploy`，則手動編譯是必須的，且 `functions.source` 應指向編譯後的 `lib` 目錄。

### 2.5 部署 Cloud Functions

完成以上步驟後，在專案根目錄下（或任何有 `firebase.json` 的地方）執行部署命令：
```bash
firebase deploy --only functions
```
這會將您 `functions/lib` (或根據 `firebase.json` 配置的源目錄) 中的 JavaScript 檔案和相關配置部署到 Firebase。

部署過程可能需要幾分鐘。成功後，Firebase CLI 會顯示已部署的函數 URL。 

## 3. Firestore 設定

Firestore 資料庫需要配置安全規則和索引才能確保數據安全及查詢效率。

### 3.1 安全規則部署

專案根目錄下的 `firestore.rules` 檔案定義了資料庫的存取權限。

在專案根目錄下執行以下命令部署安全規則：
```bash
firebase deploy --only firestore:rules
```

### 3.2 索引部署

專案根目錄下的 `firestore.indexes.json` 檔案定義了 Firestore 查詢所需的複合索引。

在專案根目錄下執行以下命令部署索引：
```bash
firebase deploy --only firestore:indexes
```
部署索引可能需要一些時間，具體取決於索引的數量和數據量。

### 3.3 (可選) 初始數據設定

如果專案包含用於設定初始數據的腳本 (例如 `setup_test_data.js`, `couponTemplates.json`, `loyaltyTiers.json` 等)，您可以根據腳本的說明執行它們。這些腳本通常用於填充必要的基礎數據，如優惠券模板、會員等級、預設菜單分類等。

**注意**: 在生產環境中執行此類腳本前，請務必仔細檢查其內容，確保不會覆蓋或修改現有重要數據。

## 4. 顧客 PWA 部署 (ceg-customer-pwa)

顧客端漸進式網頁應用 (PWA) 使用 React, TypeScript 和 Vite 構建。

### 4.1 獲取原始碼與目錄

確保您在 `ceg-customer-pwa` 目錄下操作：
```bash
cd ceg-customer-pwa 
# 如果不在專案根目錄，請先 cd 到專案根目錄，再 cd ceg-customer-pwa
```

### 4.2 環境變數配置

顧客 PWA 通常需要 Firebase SDK 的初始化配置以及後端 API 的 URL。
這些配置通常通過 `.env` 檔案在本地開發時設置，並在建構過程中嵌入到應用中。

創建 (或檢查) `ceg-customer-pwa/.env.production` 檔案，並填入生產環境所需的配置。例如：

```env
VITE_FIREBASE_API_KEY="YOUR_FIREBASE_API_KEY"
VITE_FIREBASE_AUTH_DOMAIN="YOUR_FIREBASE_AUTH_DOMAIN" # your-project-id.firebaseapp.com
VITE_FIREBASE_PROJECT_ID="YOUR_FIREBASE_PROJECT_ID"
VITE_FIREBASE_STORAGE_BUCKET="YOUR_FIREBASE_STORAGE_BUCKET" # your-project-id.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID="YOUR_FIREBASE_MESSAGING_SENDER_ID"
VITE_FIREBASE_APP_ID="YOUR_FIREBASE_APP_ID"
VITE_FIREBASE_MEASUREMENT_ID="YOUR_FIREBASE_MEASUREMENT_ID" # 可選，用於 Analytics

VITE_API_BASE_URL="YOUR_CLOUD_FUNCTION_BASE_URL" # 例如 https://<region>-<project-id>.cloudfunctions.net
```

*   `YOUR_FIREBASE_*`: 這些值可以從 Firebase 控制台的專案設定中找到 (Project Settings > General > Your apps > Firebase SDK snippet > Config)。
*   `YOUR_CLOUD_FUNCTION_BASE_URL`: 與後端部署時配置的 Cloud Functions 基礎 URL 相同。

### 4.3 安裝依賴

在 `ceg-customer-pwa` 目錄下，安裝 Node.js 依賴：
```bash
npm install
```

### 4.4 建構應用

在 `ceg-customer-pwa` 目錄下，執行建構命令：
```bash
npm run build
```
此命令會使用 Vite 將應用程式編譯並打包到 `dist` 目錄 (或 `vite.config.ts` 中指定的輸出目錄)。

### 4.5 部署到 Firebase Hosting

假設您的 `firebase.json` 已配置好 Firebase Hosting 以服務 `ceg-customer-pwa`。通常會為不同的前端應用設置不同的 hosting target。

例如，`firebase.json` 中可能有類似配置：
```json
{
  "hosting": [
    {
      "target": "customer-pwa", // 或其他您定義的 target 名稱
      "public": "ceg-customer-pwa/dist",
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        {
          "source": "**",
          "destination": "/index.html"
        }
      ]
    },
    // ... 其他 hosting 配置，例如 web-admin
  ]
}
```

在專案根目錄下執行部署命令 (請將 `customer-pwa` 替換為您在 `firebase.json` 中定義的實際 target 名稱，如果只有一個 hosting 配置，則不需要指定 target)：

```bash
firebase deploy --only hosting:customer-pwa 
# 如果只有一個 hosting site 或者想部署所有 hosting sites，可以使用：
# firebase deploy --only hosting
```

## 5. 管理後台 PWA 部署 (web-admin)

管理後台 PWA 同樣使用 React, TypeScript 和 Vite 構建。部署步驟與顧客 PWA 非常相似。

### 5.1 獲取原始碼與目錄

確保您在 `web-admin` 目錄下操作：
```bash
cd web-admin 
# 如果不在專案根目錄，請先 cd 到專案根目錄，再 cd web-admin
```

### 5.2 環境變數配置

與顧客 PWA 類似，創建 (或檢查) `web-admin/.env.production` 檔案，並填入 Firebase SDK 配置和後端 API URL。
內容通常與顧客 PWA 的 `.env.production` 中的 Firebase 配置相同，但 `VITE_API_BASE_URL` 也指向同一個 Cloud Functions 基礎 URL。

```env
VITE_FIREBASE_API_KEY="YOUR_FIREBASE_API_KEY"
VITE_FIREBASE_AUTH_DOMAIN="YOUR_FIREBASE_AUTH_DOMAIN"
VITE_FIREBASE_PROJECT_ID="YOUR_FIREBASE_PROJECT_ID"
VITE_FIREBASE_STORAGE_BUCKET="YOUR_FIREBASE_STORAGE_BUCKET"
VITE_FIREBASE_MESSAGING_SENDER_ID="YOUR_FIREBASE_MESSAGING_SENDER_ID"
VITE_FIREBASE_APP_ID="YOUR_FIREBASE_APP_ID"
VITE_FIREBASE_MEASUREMENT_ID="YOUR_FIREBASE_MEASUREMENT_ID"

VITE_API_BASE_URL="YOUR_CLOUD_FUNCTION_BASE_URL"
```

### 5.3 安裝依賴

在 `web-admin` 目錄下：
```bash
npm install
```

### 5.4 建構應用

在 `web-admin` 目錄下：
```bash
npm run build
```
此命令會將應用程式編譯並打包到 `dist` 目錄。

### 5.5 部署到 Firebase Hosting

假設您的 `firebase.json` 也為 `web-admin` 配置了 Firebase Hosting target。

例如，`firebase.json` 中可能有類似配置：
```json
{
  "hosting": [
    // ... customer-pwa 配置 ...
    {
      "target": "admin-pwa", // 或其他您定義的 target 名稱
      "public": "web-admin/dist",
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        {
          "source": "**",
          "destination": "/index.html"
        }
      ]
    }
  ]
}
```

在專案根目錄下執行部署命令 (請將 `admin-pwa` 替換為您定義的實際 target 名稱)：
```bash
firebase deploy --only hosting:admin-pwa
```

## 6. 部署後驗證步驟

部署完成後，進行以下基本驗證：

1.  **Cloud Functions**: 
    *   檢查 Firebase 控制台的 Functions 部分，確認所有函數都已成功部署且狀態正常。
    *   嘗試調用一個簡單的健康檢查端點 (如果有的話) 或一個不需要認證的 API 端點，確認服務可達。
2.  **顧客 PWA**: 
    *   在瀏覽器中打開顧客 PWA 的 URL (部署後 Firebase CLI 會顯示，或在 Firebase 控制台 Hosting 部分找到)。
    *   測試核心流程：用戶註冊/登入、瀏覽菜單、加購物車、下單 (如果可以測試支付流程，則測試支付)。
    *   檢查訂單狀態是否能正確顯示。
3.  **管理後台 PWA**: 
    *   在瀏覽器中打開管理後台 PWA 的 URL。
    *   使用管理員帳號登入。
    *   測試核心功能：查看訂單、管理用戶角色 (如果已有用戶數據)。
4.  **LINE Pay 整合 (如果適用)**:
    *   在顧客 PWA 中嘗試使用 LINE Pay 進行支付。
    *   驗證是否能成功跳轉到 LINE Pay 頁面，以及支付成功/失敗後是否能正確跳轉回 PWA 並更新訂單狀態。
    *   檢查 Firestore `linePayTransactions` 集合是否有相應的交易記錄。
5.  **檢查日誌**: 
    *   在 Firebase 控制台查看 Cloud Functions 的日誌，排查部署或運行時可能出現的錯誤。

部署過程中遇到任何問題，請仔細檢查 Firebase CLI 的輸出信息、Firebase 控制台的日誌，以及各組件的環境變數配置是否正確。 