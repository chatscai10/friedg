?遢?勗??詨??游??冽?靘?靘?鞈?嚗??怠?蝟餌絞?詨??艙??銵瑽??璅∠??底蝝唳?餈啜??冽扯??蝵脩雁?遣霅啜歇?亦????◢?迎?隞亙??芯??撅??遢?勗??璅霈遙雿??梯??遢?勗???砍嚗?賣??啣?圾?游?獢??瘙???刻???
隞乩??舀???瘙????????箸?渡????游?獢?銵??澆?嚗?
---

**?????曆??押OS ???啁恣?頂蝯?- 撠??銵??澆?**

**?交?嚗?* 2024 撟?05 ??30 ??
**?辣?嚗?* V1.0

**靘??辣靘?嚗?* ?砍?靽??隞賢?獢????銵?隞嗆?楊撖怨?嚗??恬?
*   ?冽雿?POS 蝟餌絞璅∠????身閮?*   銝 ??? 蝺?閮? (?典??批捆)
*   撌脰票銝?摮?(?銵??潭?阮??憿耨敺抵????祈??銵ㄖ撱箄降蝑?
*   ?賊??OS敺蝟餌絞蝪∪

---

**1. 撠?璁膩 (Project Overview)**

**1.1. 撠??詨??艙?璅?*

?砍?獢??詨??艙?舀???憟????閮嚗?賡????瑯????嗚?“摰ａ?靽?雿????祉???嫣???摨血恥鋆賢??箸擗ㄡ閫?捱?寞??璅?摨振???之?艾??憭乩撈?頂蝯梯身閮??**憭???(Multi-Tenant) SaaS ?嗆?**嚗?曉??函?摨振嚗??塚???????詨?蝑?舀?靘玨蝢???鞎餌頂蝯梁?鞈芣??楛摨血??踝?雿誑 **?祥閮餃?雿輻** 雿?詨?嚗撘誨憭抒?嗅蝷???憓潭???撟喳???脣?頂蝯梢??瑕?擃漲?暑?扯??游??改?隞仿??銵?璆剔??瘙?銝衣Ⅱ靽??嗆???摨衣??芯蜓閮剖?甈雿踹?∪??函′擃?憒?格?嚗??啣?銝?銋瘚雿輻??
撠??琿??格??嚗?*   ??????嚗???雿??亙虜??瘚?嚗??～??准鞎具鞈?蝞?嚗?*   撖衣?豢??游???嚗?銝剔恣??靘??豢?嚗??柴澈摮?柴蜀???寧?嚗???瘙箇??舀??*   撘瑕??折蝞∠?嚗?皞??∪極??蝔澈摮?皞恣??*   ?孵??折皞????砍??霅澈??蟡函?撌亙??*   ?舀銵???嚗撌乩蜓閬??賣??臬??銝???(?? PWA)??*   撱箇?瞈?菜??塚??Ⅱ?????恣??*   ?芸?鈭箏?鞈?嚗?湔????芸????
**1.2. 撠?蝭?**

?祉頂蝯望項??銝餉??璅∠?????銝?
*   頞?蝞∠?敺 (Super Admin)
*   蝘敺 (摨振蝞∠?敺)
*   蝺?暺? & ?銝剖? & 蝘?Ｙ揣撟喳
*   蝺?暺?璅∠? (?∪極蝡?- PWA)
*   頨思遢隤??雿?甈?蝞∠?
*   GPS 摰??蝟餌絞
*   摨怠?蝞∠?蝟餌絞 (?漲?日???典鞎?
*   ????頂蝯?*   ?瑕?蝟餌絞
*   ?芾????頂蝯?*   蝮暹????????蝟餌絞
*   憿批恥閰蝟餌絞
*   ?折皞頂蝯?(?砍??霅澈??蟡?
*   蝟餌絞蝞∠?? (撖拇???貉身摰隤?砍???
*   ??蝺刻?蝞∠?璅∠?
*   蝖祇??券??游?璅∠? (?脩垢?箏璅∪?)
*   ?刻閮餃?????菜???*   撱????恣?頂蝯?*   蝘?Ｙ揣撟喳
*   蝟餌絞摰獢

**?祉頂蝯梁???? (Out of Scope) ???桀???*嚗?*   摰??脤摮恣??(?桀???折?怨疏??摨衣暺?銝?閮?)??*   摰?“摰ａ?靽恣?頂蝯?(CRM)??*   摰??銝?POS 蝖祇??游? (撠釣??PWA ?蝡臬?格芋撘???*   ?券?瓷??閮頂蝯望??*   ??銵? App ? (?桀?銝餉???Web App / PWA)??*   閰喟敦???????銵冽 (?桀????箸?豢??亦????芾?/蝮暹??賊???璅???
**1.3. ?格?雿輻??*

蝟餌絞???潔誑銝嗾憿蝙?刻?
*   **????頞?蝞∠???(Super Admin):** ???擃???蝞∠?????嗚撅閮剖??像?啣誨???刻蝟餌絞蝑?
*   **蝘蝞∠???(摨振蝞∠???/??蝬?:** 蝞∠??嗆?撅砍?摰嗥??∪極???柴??柴?銵函?.
*   **???∪極/憭乩撈:** ???亙虜暺???柴?柴??～??准?鞈?.
*   **憿批恥:** 蝺?暺?????柴恣???∟???鈭方??嫘?Ｙ揣撟喳撠摨振.

**1.4. ?辣?桃?**

?砍??典?Ⅱ摰儔蝟餌絞?瑽?銵???潭?皞PI 閬????刻?瘙蝵脩雁???亙?撌脩憸券?靘????粹??澆????勗?靘儐皞?嚗Ⅱ靽?獢?鞈芥??湔扯??舐雁霅瑟扼遢?勗??孵???潭?靘雲憭?蝝啁??釣????雿踵???澆??憭??拇??獢?
---

**2. ?嗆?閮剛? (Architectural Design)**

**2.1. 摰??嗆?**

蝟餌絞?∠?箸 Firebase ??**?∩撩? (Serverless)** ??**憭???(Multi-Tenant) SaaS ?嗆?**??*   **?垢 (PWA):** ?函蔡??Firebase Hosting嚗??蝙?刻??Ｚ?鈭??摩?? Firebase Client SDK ??蝡舀?????*   **敺垢 (Firebase Functions):** ??璆剖??摩 API嚗??洵銝???游?嚗?瘚??嚗銵澈隞賡?霅??抬?LINE Login Token 鈭斗?嚗銵?蝔遙???隞餃??撠?撠?Ｘ??Cloud Functions **蝚砌?隞?(2nd gen)** ?脰???蝵莎??拍?嗡蒂銵????雿???辣?脯?*   **鞈?摨?(Firestore):** ?脣????瑽??豢?嚗?閮??嗚??柴?摨?閮??撥隤?**?曹澈鞈?摨怒鈭?Schema嚗蒂??撘瑕 TenantID ??StoreID ?蕪** 靘祕?曉?蝘鞈????*   **頨思遢撽? (Authentication):** 銝餉??游? LINE Login嚗? Cloud Function ?Ｙ? Firebase ?芸?蝢?Token ?脰?撽??撌亙?賭蝙??Email/Password ?隞撘?敺?蝢抬??irebase Authentication ?脣??冽?箸頨思遢鞈?銝西? LINE 撣唾?蝬???*   **閮?券?(Cloud Messaging):** ?冽??蝡?PWA ?? Cloud Functions 閫貊??LINE/Telegram ?潮???
**摰??嗆???* (璁艙蝷箸?嚗底蝝啗???皞?隞?嚗?[憿批恥/?∪極 PWA @ Firebase Hosting] <--> [Firebase Client SDK] <--> [Firebase Services]
                                                    |/|\
                                                    | | (Auth, Firestore, FCM)
                                                    +---------------------> [Firebase Cloud Functions v2] <-------+
                                                    (API Logic, Node.js 20) |
                                                                            |
                                                    +-------------------------+-------------------------+
                                                    |                         |                         |
                                                [LINE Pay API] [Delivery Platform API] [Notification API]
                                                (Uber Eats, Foodpanda) (LINE Notify, Telegram)


**2.2. ?垢?嗆? (PWA)**

*   **?銵?** 璅? HTML/CSS/JavaScript?????孵??垢獢 (憒?Vue, React)??*   **?詨??嚗?* Service Worker 撖衣?Ｙ?敹怠???PWA 摰?嚗anifest file 摰儔?蝔??寞扼?*   **Firebase ?游?嚗?* 敹?雿輻 Firebase Client SDK v9.x.x (Compat) ?嚗?????亦? SDK 蝯辣敹?雿輻摰?詨????祈? (?桀?撱箄降 v9.22.2)????蝘餉 v9+ 璅∠???SDK (撱箄降 v11.6.1+) 隞交?撠???蝛?*   **UI/UX嚗?* 隞??雿?蝔?擃漲?渲?銝?蔭 (撠文蝺?暺?璅∠?)?釣???閮剛? (RWD) ??閬箏?擖?*銝???菟◢?芣蝻箔? UI/UX 閮剛?蝔?*嚗?賢??游??之?矽?氬?
**2.3. 敺垢?嗆? (Firebase Functions)**

*   **?銵?** Node.js 20 LTS?蝙??Cloud Functions for Firebase (蝚砌?隞?- 2nd gen)??*   **閫貊?券???** HTTPS 閫貊?函??API 隢?嚗uthentication 閫貊?函?潛?嗅撱箏?憪?嚗ub/Sub 閫貊?典? Cloud Scheduler 閫貊?函?潸????遙???唳郊?寞活隞餃???*   **?函蔡蝑嚗?* 撱箄降撠??賜???賣蝯??其???瑼?銝准撠?摨衣蝡?鞈??瘙?????函蔡?箇蝡? Function Group??? asia-east1 (敶啣?) ??asia-northeast1 (?曹漪) ?啣??函蔡?賣嚗誑??撱園??*   **?瑕????** 閮剖??????園? (?喳? 256MB)????迂嚗閮剖??撠祕靘 (Minimum Instances) 靽??賣撖虫?瘣餉????典?蝭??批銵?????冽??極?琿脰? Tree Shaking??
**2.4. 鞈?摨怨身閮?(Firestore)**

*   **憿?嚗?* Firestore (NoSQL)??*   **閮剛???嚗?* ?∠?曹澈鞈?摨怒鈭?Schema??????蝘?孵????????TenantID ??StoreID 甈?嚗蒂?冽???撖急?雿葉撘瑕?脰??蕪嚗Ⅱ靽???Ｕ??寞????亥岷璅∪?摰儔敹????揣撘?(firestore.indexes.json)??*   **??釣????** Firestore 銝?渲??? Join ?之????蝞?甈⊥閰Ｙ?餈?蝑?之撠?? (1MB)??辣撖怠?餌????嗚???閬閮剛???鞈?蝯??芸? (憒?園?銴摮遣蝡??揣撘? ??銴?閮?頧宏?啣?蝡舀甈∟???????
**2.5. 憭?游? (Integrations)**

蝟餌絞?閬?????冽???
*   憭像?堆?Uber Eats API, Foodpanda API (??Webhook 璅⊥)??*   ??嚗INE Pay API??*   ?嚗INE Notify, Telegram Bot API, Firebase Cloud Messaging (FCM)??*   LINE Login (LIFF SDK)??*   LINE Messaging API (Webhook) - ?航?冽?交憿批恥閰.

**瘜冽?鈭?嚗?* 蝚砌??寞???鞈游?賢???API ????辣?脣蔣?踴??隢?蝺拙??隤日?閰西???靽風璈??
---

**3. ?銵?皞?閬? (Technical Standards & Specifications)**

?箇Ⅱ靽?獢??湔扼蝬剛風?扯?蝛拙??改???湔?萄儐隞乩?璅?嚗?
**3.1. ??批??鞈渡恣??*
*   **?蝯曹?嚗?* ????Ｗ??蝙?函???祉? Firebase Client SDK (撱箄降 v9.22.2 Compat ?剜?蝯曹?嚗????v9+ Modular SDK v11.6.1+)?????Ｗ??蝙?函???祉? LIFF SDK (撱箄降 2.21.4 ????啁帘摰?)?DK ??湔敹?蝬?摰皜祈岫銝血?甇交?唳????Ｕ?*   **敺垢 SDK ?嚗?* Firebase Admin SDK 撱箄降雿輻??啁?蝛拙?銝餌???(v13.x+)?loud Functions V2 SDK??*   **Node.js Runtime嚗?* 蝯曹?雿輻 Node.js 20 LTS??*   **NPM 憟辣蝞∠?嚗?* 撘瑕雿輻銝行?鈭?package-lock.json ?啁??祆?嗥頂蝯?(Git)???潛Ⅱ靽??憓?靘陷?銝?湔?*璆萄??**??*   **Firebase CLI嚗?* 雿輻??啁?蝛拙???(v12+)??*   **Container Base Image (憒??Cloud Run):** ?交靘???Cloud Run嚗遣霅唬蝙??node:20-slim ??node:22-slim ??Node.js Runtime 銝??

**3.2. 蝺函Ⅳ憸冽??隞?*
*   **蝺函Ⅳ憸冽嚗?* ?萄儐銝?渡? JavaScript ?賣?賢??恐?◢?潭???(docs/coding-style-guide.md)?遣霅唬蝙??ESLint ?剝? Prettier ?脰??芸?瑼Ｘ?撘???*   **?辣?酉閫??** ?箄???頛胯?貊???詻??潭溶??嗥? JSDoc 閮餉圾??銵??潭?PI 閬???刻??牧?揣撘?蝢拍??辣??券??潮脣漲???萄遣??啜?
**3.3. ?撖西?**
*   **?葉????** 撠?Firebase ??LIFF ?敹?憪??摩??葉?啣??冽?隞嗚蝙??Promise ??async/await 蝣箔????其蝙?典?撌脣???憪?嚗?*?渡?雿輻 setTimeout 頛芾岷**??*   **敺垢?芸?嚗?* 瘨?甈???蝞????氬??霅??詨?璆剖??摩敹??曉 Cloud Functions 銝剛????賢?靘陷?垢??Firestore Rules ?脰?甈??批??*   **?豢??嚗?* ???蝡舀?赤?????思蒂甇?Ⅱ雿輻 TenantID/StoreID ?蕪??*   **????嚗?* 撠?閬?甇仿??湔??雿??雿輻 Firestore Transaction 蝣箔????扼?*   **?航炊??嚗?* Cloud Functions ?折?憒亙????車???????航炊嚗蒂餈???蝢拍????隤?
---

**4. ?璅∠?閰唾膩 (Detailed Functional Modules)**

?祉?撠底蝝啗牧??獢????賣芋蝯???嗥璅蜓閬??賬?頛航?暺?銝行?蝷箏歇?亦???敺齒鈭??撩憭梁??詨??摩??
**4.1. 頞?蝞∠?敺 (Super Admin)**
*   **?格?嚗?* ?? POS ???葉憭桀像?堆?蝞∠?憭??嗥頂蝯晞?抒??身摰撅閬??恣???塚?銝血?Ｘ?嗅誨?頂蝯晞?衣頂蝯梯??箇??閮剖???*   **甈?嚗?* ?擃頂蝯望?????????*   **銝餉??嚗?* 蝘蝞∠?嚗?銵具???皞??????芋?祉????湔?抒恣嚗獢?閮祥蝞∠?嚗?蝢拇獢?撅斤????賣芋蝯??函???閮剛?皞??塚??撅閮剖?????賡???(Feature Flags)?誨?頂蝯梁恣???典??????嗥???雿?銵?雿蔭?株都蝞∠?嚗?衣頂蝯梁恣??瞈瘣餅?隞嗉??身摰??怎?嗡??格???菔??身摰????嗆蝝Ｗ像?啁恣??閮剖?隞祥??璁??恣?移?詨?摰嗚祟?詨?摰嗅??閮??頂蝯梁?扯???嚗撱??????臭遙?楊蝘?踹??隅?Ｗ??????刻??亥?嚗頞?蝞∠??⊥?雿里?賂???*   **?銵??** 摰??Web ?蝔?獢??
**4.2. ?刻閮餃?????菜???*
*   **?格?嚗?* 瞈?菜撱?????脣恥?嚗?擃?冽嚗??塚?瘣餉?摨佗??芸????萇?整?*   **??瘚?嚗?* ?刻蝣潛???-> ?啁?嗉酉?撓?交?衣Ⅳ -> 撽???摰?靽?-> **瞈瘣餅?隞嗉蕭頩?(?舫?蝵?嚗?* 靘?摰?閮餃?+銝 N ???????酉???脣??喳? M 雿蝡“摰ａ?蝟餌絞??銝 (璇辣 B ?啣?)?uper Admin ?航身摰????瞈瘣餅?隞嗚?> **?閫貊?銵?* (??刻??-> ?芸???鞈??? / 閫??? / 撱園??????*   **?豢?璅∪?璁艙嚗?* Tenants, Plans, TenantLimits, ReferralCodes, ReferralUsages (??activated_at 甈?), ReferralRules (activation_type, activation_threshold)??
**4.3. 撱????恣?頂蝯?*
*   **?格?嚗?* ?箏像?啣??憭??塚????暑?蔭嚗?閮梁??嗡?鞎餃撱????*   **??瘚?嚗?* ??摰儔 -> 撱??閮剖? (Super Admin) -> 撱??隢? (Frontend) -> 撱??瘙箇? (Backend) -> 撱??皜脫? (Frontend) -> ??餈質馱??*   **撱??憿???蝵?(蝭?)嚗?* 憿批恥蝡?(璈怠????亙???璈???撌亦垢 (?餃??銵冽摨 - **璆菔牲??*)???嗅??啜誨???仿???甇伐?蝣箔?銝蔣?踵敹??賬?*   **?脣璅∪?嚗?* ?餃誨???晞誨??雿?柴?*   **??瘜冽?鈭?嚗?* 雿輻??撽?(UX) ???????乓??質???
**4.4. 蝺?暺?璅∠? (?∪極蝡?- PWA)**
*   **?格?嚗?* ????嚗?撠隤歹??拍 PWA 撖衣?Ｙ???嚗??Ｚ???瘚??擃漲?渲?銝?蔭??*   **憭?閮剛?嚗?* 憭扳??孛?批??*?迂蝘?芾?撣貊?敹急?菔?雿?**?蝺?蝺????蝷箝???撟脫?批誨??雿?(雓寞?)??*   **???頛荔?** **蝘???蝵桀?頛?* (?餃撽? TenantID嚗?頛府蝘?翰?琿閮剖????賡??????株??豢???擗?雿?(?怠?閮颯?擗?????桃恣??(?怠?????柴耨????-?甈?+Log)??撣單?雿?(?急毽?隞?????-?甈?+Log?蟡具孛?潸???????*撘瑕??Ｙ?璅∪?**??*閰喟敦甈?閫摰儔?恣??*??*?暸??賢?蝞∠???亦?蝞?*??靘?蝺湔芋撘?*鞈??瑼Ｘ** (隤輻敺垢 API 瑼Ｘ TenantLimits)??*?箏** (?潮蝘???蝡臬銵冽?隡箸???API)??*   **撣摰?嚗?* ?詨??箇?璅∠?嚗帘摰?蝺???芾??扳鞈????
**4.5. ??蝺刻?蝞∠?璅∠?**
*   **?格?嚗?* 皜撅內閮?????????嚗?*?舀?∪祕擃撟???璅∪?** (?? LINE ?憿批恥)??*   **?嚗?* 蝟餌絞憿舐內閮???(憒ˊ雿葉/撌脣????“摰Ｗ??蝣潭??????
**4.6. ?蝟餌絞璅∠? (Web + LINE Login)**
*   **?格?嚗?* 撱箇?敹?摨佗??園??豢?嚗移皞??瘀??游?閰嚗?*??鞊?銝?梁??嗉閮?瘣餃?璈**??*   **憭?閮剛?嚗?* ?銝剖? (蝘?航閮??閫?＊蝷箄????”)???誨??雿?*   **???頛荔?** ?蝬????(LINE - **蝘?函? Channel**)???貉?蝞??? (蝘?航身摰??????株蕭頩方?甇瑕?亥岷?“摰Ｚ??寧頂蝯望??(Pull 璅∪?)???∪??暹?蝐斤恣??/???貊頂蝯?(蝘?臬?蝢拙????閬?)??*?芸??暑?身摰?(Campaign Management)**: ???交??潭瘣餃??詻??亦旨?芸??潮?(**蝘?航身摰?*)???勗?蝡臭遙???孛?潦?*   **??瘜冽?鈭?嚗?* ?豢??梁???閬敺?(PDPA)???郊頛撱???辣??*   **撣摰?嚗?* ?詨??孵潭芋蝯?擃漲摰Ｚˊ???鞈????
**4.7. 蝖祇??券??游?璅∠? (?脩垢?箏璅∪?)**
*   **?格?嚗?* 蝣箔? POS ?賢??隞餃??潮**蝘???蝡臬銵冽?隡箸???*嚗?*?喃蝙?∪銵冽?銋??**??*   **???頛荔?** ?脩垢?啗”璈??(蝘敺?蔭 API URL, Key, 璅⊥嚗OS 敺垢?澆???蒂隤輻蝘?? API)??????航炊?岫??*?∪銵冽??寞?嚗?* ?亦??嗆?蔭嚗頂蝯望??賣迤撣賊?雿?閮?? KDS/PWA 隞憿舐內嚗“摰Ｘ?霅?粹摮隞嗚陛閮? PWA/?銝剖??亦? QRCode??*   **撣閰摯?勗?嚗?* ?芸?冽蝪∪?摰Ｘ蝡舐′擃?渡?啗”璈?摰嗚?Ｘ靘陷?脩垢??蝛拙??扼雯頝胯?
**4.8. 摨怠?蝞∠? (Inventory Management)**
*   **?格?嚗?* ?摨振?脰??箸?澈摮蕭頩方?蝞∠?嚗?交?漲?日???典鞎冽?蝔?*   **???頛荔?** ??TenantID ??豢???*?漲?日?嚗?* ??瘥??日?瘚?蝞∠?嚗???日?皜嚗丰隡渡?銝‵?望??蝟餌絞閮?撌桃銝衣????*?折?怨疏嚗?* ?撣?銝剖亢撱/?澈閮頃瘚?蝞∠?嚗丰隡游‵撖怠鞎典嚗頂蝯勗?隢策?拇?撖拇嚗??風?脖蒂?迂?航炊???*蝘?舫??血??典???蝞∠???蝞∠???摨怠?**??*   **蝭?憭?** 銝??怠??渡??單??脤摮恣???閮???*   **撣摰?嚗?* ?詨??孵潭芋蝯???敶扳遛頞喃??恣?楛摨阡?瘙?
**4.9. ?脤??梯”?????(Reporting & Analytics)**
*   **?格?嚗?* ??蝬??豢?瘣?嚗??拙?摰嗅????*   **???頛荔?** ??TenantID ??豢???*蝘?航閮?銵冽?釣??**??靘?祉??瑕?澈摮榆?啜鞈銵函???*敺???** ?桀???靘?祆???閰喟敦?????銵冽?箇????靘撅???閬祕?曉?蝡舐??????摩??*   **撣摰?嚗?* ?詨??孵潭??剁?摰Ｚˊ??銵冽??擃???
**4.10. ???怨?蝟餌絞**
*   **?格?嚗?* 蝞∠?憿批恥???????????????*   **?嚗?* ?舀??TenantID ???閰喟敦??芸靘?銝剖??????箸?芋蝯???
**4.11. 憭像?唬葡??*
*   **?格?嚗?* ?游?憭像?啗??株?瘚?嚗?撠犖撌交?雿??嫣噶撠董??*   **???頛荔?** ??TenantID ??豢????嗅?典??啗身摰?API Key 蝑?霅頂蝯勗?憭像?啣?亥??柴丰隡游蝟餌絞銝剛??????殷?鋆賭???柴?啁?????游?瘨??銝血?甇仿撟喳?????桅?憿像?唬膛??嚗?蝯???撣喋?*   **?游??孵?嚗?* ?? API ??Webhook 璅⊥??*   **瘜冽?鈭?嚗?* 靘陷蝚砌??寞???蝛拙??扯? API ???
**4.12. 蝘?Ｙ揣撟喳 (Tenant Discovery Platform)**
*   **?格?嚗?* ?Ｗ?蝯垢瘨祥??撅內撟喳銝?摨振嚗蝘撠?嚗??憭??嗚?*   **???頛荔?** **摨振撠?嚗?* 憿舐內摨振閰喟敦?祇?鞈?嚗蝘?典??啁雁霅瘀????桅?閬賬脰?銝剔?瘣餃???璆剜??蝜急撘?銝?擗????*摨振鞈??澆?嚗?* 蝘?臬敺?豢??臬?澆?鞈?銝衣雁霅瑕????*???嚗?* ?啁?雿蔭???萄?/???暑?祟?詻?*??璁??塚?** ?身??嚗??Ｕ??對?嚗?靘?行?摨??嗅??敺鞈潸眺??璁???蝵殷?隞祥??嚗?蝡?API ??賢??冽閰Ｘ?????蝘鞈???*   **?脣璅∪?嚗?* ??撱??/??鞎餃??憭??嗚?*   **撣摰?嚗?* 撟喳???潭???敺??澆?????閬雲憭?蝘???孵潦?
**4.13. 憭乩撈蝞∠?璅∠? (?∪極蝞∠?)**
*   **?格?嚗?* 蝯曹?蝞∠?鈭箏?鞈??賊??嚗Ⅱ靽犖?∟????具?????*   **???頛荔?** **頨思遢隤???伐?** ?游? LINE ?餃雿憭乩撈頨思遢撽?嚗?甈∠?仿?蝞∠??∪祟?詻irebase Authentication ?脣??箸鞈?銝西? LINE 蝬???*?箸鞈?蝞∠?嚗?* 閮??犖?遙?瑁?閮??舀?臬/?臬??*?瑚?????** 撱箇?皜??6 蝝蝑?蝟颯??瑞?撠?銝?蝟餌絞甈?蝭??恣??典??啁恣?????脯???嗅?垢??蝡臬??刻????祕?賬?*憭乩撈???祟?賂?** ?啣丰隡湧?閮餃??漱?唾?嚗恣?敺撖拇嚗??芸?撱箏董??瘣曇雿?????*頝典??晷嚗?* ?舀憭乩撈頝典?摨遙?瘀??迂?豢?撌乩????脰???嚗????????
* *?? `checkResourceScope` ?賣??堆?* 撘瑕?鈭?皞??炎?仿?頛荔?蝣箔?摨???蝣箸改?銝阡??舫?泵??(`?.`) ??鈭誨蝣澆??瞏 `undefined` ??`null` ?潭??憯舀扼?* *蝘??摩撘瑕?嚗? 靽格迤鈭??嗥恣?甈??斗嚗Ⅱ靽???湔??刻頨怎??嗥??嚗蒂?寥脖?撠?`tenantId` 摮?抒?瑼Ｘ??* *銝剝?隞?(`withPermissionCheck`) ?寥莎?* ?芸?鈭?`getUserInfoFromClaims` ?賣撠?嗉澈隞賭誘??token嚗葉?芸?蝢抵??claims嚗?閫???蝙?冽撘?雿踹?賣?舫??唳?????縑?胯皜祈岫?啣?瘛餃?鈭???芋?穿?mock嚗誑?皜祈岫靘陷嚗蒂憓撥鈭隤斗隤???* *皜祈岫閬?????* ??靽桀儔皜祈岫?????葫閰衣靘??湧?皜祈岫閬???? 18.53%嚗敹?RBAC 璅∠?閬?????84.09%嚗＊??撘瑚?隞?Ⅳ鞈芷???扼?
**4.14. ?蝞∠?璅∠?**
*   **?格?嚗?* ??瘥振???潛銵典???隢?蝞∠?嚗Ⅱ靽?撣犖??蝵桀???*   **???頛荔?** **?剛”??嚗?* ?舀??????准恣??????蝙?刻???剜?蝞???????剛”?臬隤踵蝣箄?敺撣?*?芸??瞍?瘜?敺齒鈭?**??*???撱箄降?芸?嚗?* ???祕??擖??雿??交芋?祈?蝔踴?*?剛”?澆??嚗?* 蝣箄?敺撣憭乩撈?垢?嚗?? LINE Notify ???*隢??唾??祟?對?** 憭乩撈?漱?唾?嚗頂蝯望炎?亦?隡??蝞∠??∪??啣祟?嫘??擏?敺??*蝳??交?蝞∠?嚗?* 蝞∠??∟身摰?隡??蝡舫?瑼Ｘ銝行?蝷粹?憭?歹?敺垢??活撽?銝西?蝞?憭?文予?詻?*??Ⅱ??擗???????湧?頛?*??*隤輻?誨?哨?** ?舀隤輻?唾? (?蝞∠??⊥?????瘣曆誨?准?*?箏?郎嚗?* 撠???擃極???喳?頞????澆?郎??
**4.15. ??璅∠?**
*   **?格?嚗?* ??隞?GPS 摰??箏蝷?銝??剜??∪??踝?蝎曄Ⅱ閮??箏??*   **???頛荔?** **GPS 摰??嚗?* 憭乩撈?????銝摰?? (?啁???) ?????????蝵柴?*?芸???摰?** ?寞??剛”???⊥??摰???啜????准???拚?蝞∠??～?璅?蝻箏??靘??⊥???*頝典??嚗?* ?舀頝典??舀憭乩撈?豢??嗅?撌乩???敺??～?*瞍??∟??鳴?** 憭乩撈?漱鋆?唾?嚗?蝞∠??∪祟?賊?敺??亥??蒂璅酉???颯?*?箏?梯”???** ???鞈??梯”嚗?潸鞈?蝞??????
**4.16. ?瑕?蝟餌絞**
*   **?格?嚗?* ?箏??芸??典???POS ??閬犖撌交甇??憓?靘?格???望??嗚?*   **???頛荔?** ??瘥?平蝯??舀?鈭斗?皞??瑕?豢?銵典??渲摰儔甈????銝凋?鞎∪??????蝙?具丰隡游?典撌仿??Ｘ?鈭日?株??恣??臬蝞∠??瑼Ｚ??瑕?豢???
**4.17. ?芾????頂蝯望芋蝯?*
*   **?格?嚗?* 閰摯憭乩撈銵函銝西?蝞鞈???瞈?萄???*   **???頛荔?** **蝮暹???蝝??** ?芾?憭雁摨行?璅?(?瑕憿??嫘?斤?蝑?嚗?敞蝛恣???唳??璅???瘜?*??隞餃?嚗?* ?蔭銝?憿???寞?嚗?隞嗚?鞊～???嚗???隞嗉???亦??董?嗚?游?蔭???遙????隡啣?梯???遙?孛?潦?*?芾?閮??游?嚗?* 瘥??寞?摨??扎蜀?????芸?閮??芾????鞈銵具丰隡游?亦??犖?芾??敦???敞閮?*?詨?靽格迤??嚗?* ?撖衣?詨?閮??摩??*??閰摯** (evaluateBonusTasksScheduled, checkSingleCondition) ?霈???蒂?斗璇辣??*?芾?閮?** (calculatePayroll) ?霈??????蝞蒂撖怠??
**4.18. 蝮暹????????蝟餌絞璅∠?**
*   **?格?嚗?* ???砍像?蜀??隡啗??瑚?隤踵璈??*   **???頛荔?** **蝮暹?閰摯擃頂嚗?* 撱箇?憭雁摨西?隡圈?蝟颯?*????蝝?** ??瘚?蝞∠???渲?孛?潭?蟡?(憒祕蝧?頧迤??皛蹂?摰?????游?⊥?蟡刻”瘙箝?渲??湔?晷/?巨??瘚??????蒂?湔憭乩撈?瑚??丰隡游??蝮暹?閰祟??蟡具?*?詨?敺垢?摩敺祕??*??
**4.19. 憿批恥閰璈璅∠?**
*   **?格?嚗?* ?園?憿批恥撠????Ｗ???擖?雿?折?寥脣?憭乩撈蝮暹???*   **???頛荔?** **LINE Bot ?嚗?* 瘨祥敺? LINE Notify ?潮??瑟?????? (?憿批恥??)???孵?摮??閮???丰隡氬?*憭閰?臬嚗?* ?舀??頛詨????臬 Google閰??ber Eats 閰?蝑?*閰撅內???伐?** ?典撌亦垢撅內?餉??亙?閰?恣??航”???釣撌株???*蝮暹??嚗?* 閰敶梢憭乩撈蝮暹???銝?典????寞?踹?銝??撠犖?祇?嚗?蝞∠?撅文?亥底?遣蝡閮湔??嗚?*?詨?靽格迤??嚗?* ?閮剛? LINE Bot ?擃???蝔? lineWebhook ?底蝝圈?頛胯?
**4.20. ?折皞芋蝯?*
*   **?格?嚗?* 靽脣?刻?閮?准霅?鈭怨????園???*   **?嚗?* ???砍??澆??恣?霅澈 (?急葫撽?鋆??剖??? 蝬剛風??蟡函頂蝯?(?冽??/??/銝?祆捱蝑??丰隡游?典撌仿??Ｘ??霅澈嚗???蟡具恣??臬蝞∠???澆??恣?摰嫘?
**4.21. 蝟餌絞蝞∠??**
*   **?格?嚗?* ??蝞∠??⊿?蝵柴?扼祟?貊??葉?亙??*   **銝餉??嚗?* **撖拇銝剖?嚗?* ?葉???芋蝯?撖拇? (隢????～???????蝑???*?閮剖?嚗?* ?葉蝞∠??芋蝯身摰???(摮 settings, system_config)??憒?摨?GPS 蝭??鞈?蝞??詻?????隡????*?詨?靽格迤嚗?* **敹?閫?捱?蔭靘?銵?** (蝣箔??桐??亙)嚗?*??Ⅱ銝行?脣??訾?摮?頛?*嚗?*敹?鋆?芸祕?曄?????賣**?撖?Firestore Rules (?? Level 蝞∠??∪撖???*蝟餌絞??嚗?* ?亦????亥???嗅? (憒? Telegram)??砍???炎閬??撓?亙??典像?啗??孵??詻?*???亥?閮??箏?撖衣?敹?蝡舫?頛?*??
---

**5. 蝟餌絞摰獢 (System Security Framework)**

摰?扳 SaaS ????喉?撠文瘨?鈭斗??恥?嗆??敹??隡平蝝??冽?皞銝?楊璅∠????塚??嗅????芣???唳??隞芋蝯???蝵脖葉??
**5.1. ?詨???**
*   瘛勗漲?脩戌??撠????典椰蝘?(??拇?隞)??
**5.2. 銝餉?摰?芣**
*   **頨思遢撽? (Authentication):** 撘瑕?蝣潛??乓??舫) MFA for 蝞∠??～??函? Session / JWT Token 蝞∠??INE Login ?游?摰 (撽? State, 摰?? Callback)??鞈?Firebase Auth ?????蝳迫雿輻 sessionStorage ??localStorage ?脣????豢?????霅?LIFF ?蔭???扼?*   **?? (Authorization):** 撖行?箸閫????嗚?*Firestore 摰閬? (Firestore Rules) ?箸扔擃?漲**????Collection 閮剛??渲牲霈撖怨???雿輻 request.auth.uid ????蝝?霅??萄儐?撠?????*???Cloud Functions ?折敹?撠矽?刻?甈??脰??活撽?**???菜??雿????? Firestore Rules ??Cloud Function ?折?摩???炎?乓???ａ?蝣箔?閬???賊?頛航甇?Ⅱ?頝函??嗆?赤??*??? Firestore 摰閬??擃?靘?皜祈岫閮?**?甇Ｘ???閮? API 瘣拇???*   **?豢?摰嚗?* ??鞈???摮 (憒??典????蝣?Hash)?頛詨?撖?(TLS/SSL)嚗???敺垢??撘瑕雿輻 HTTPS?????隞質?????蝚砌???API ?澆雿輻摰??銝血??暹 Cloud Functions ?啣?霈??Google Secret Manager??*   **?箇?閮剜摰嚗?* 隡箸??典??典??箝?怎?閮剖? (WAF)???脰?撘梢????耨鋆???Firebase App Check 蝑??園??瘜?瘙??澆?? HTTPS ?賣?亙??箸????嗅? DDoS ?脰風??*   **靘陷蝞∠?嚗?* 摰???蝚砌??孵撘澈/獢???冽?瘣蒂???湔??潛絞銝 SDK ???*   **?亥???改?** **閰喟敦??雿隤?(Audit Log)** 閮????閬?雿?(?餃?????氬?耨?嫘?蝵格?嫘誨?身摰?)嚗??急???雿?IP??雿摰嫘頂蝯梢隤斗隤??其?隞嗥?扯??郎嚗?抒撣貊?乓??隤扎??冽??閮剖??郎 (憒? Telegram)??*???亥?閮??箏?撖衣?敹?蝡舫?頛?*??*   **?摰 (Security by Design):** ?券?瘙???閮剛??挾撠梯摰?瘙??潔犖?∪??冽?霅閮?撘Ⅳ摰撖拇 (Code Review)??*蝳迫蝖祉楊蝣潭???閮?(憒?蝣潦???**??靘摰Ｘ蝡舀?蝚砌??寞???頛詨?脰??湔撽??????脫迫瘜典?餅? (XSS, NoSQL Injection 蝑??撓?箏?垢????拍蝺函Ⅳ?脫迫 XSS??
**5.3. ?游??孵?**
?銝?楊璅∠????塚??嗅????芣?閬??典??隞芋蝯???蝵脖葉?PI 閮剛????澈????蝡舀葡???圈?頛舫?閬摰迨獢??
**5.4. 憸券??蝑?*
摰瞍???瞏憸券??蝑??穿?摰?摰???輔?葫閰佗?撽? Firestore 閬?甇?Ⅱ??(雿輻璅⊥皜祈岫)嚗???App Check嚗??祇? HTTP ?賣?亙??餌????DDoS ?脰風??潛?鞈?鈭辣嚗??喳???霈?蝔?
---

**6. ?函蔡?雁?遣霅?(Deployment & Operations Recommendations)**

?箇Ⅱ靽頂蝯梢??拐?蝺蒂?瑟?蝛拙???嚗?閬??Ⅱ?蝵脰?蝬剝?蝑??
**6.1. ?函蔡撟喳**
*   **?垢嚗?* Firebase Hosting??*   **敺垢嚗?* Firebase Cloud Functions V2?遣霅圈蝵脰 asia-east1 ??asia-northeast1 ???
**6.2. ?啣?蝞∠?**
*   **敹?** ?????(Development) ????(Production) ?啣??遣霅唬蝙?函蝡? Firebase 撠???憓??? (Staging) ?啣??冽?蝯??嗆葫閰艾?
**6.3. ?函蔡瘚?**
*   雿輻 Firebase CLI ???函蔡??*撱箄降撱箇? CI/CD Pipeline** 撖衣?芸??蝵莎???桀?皜祈岫??葫閰艾??冽扳炎?亦?甇仿???蝡舫??? CI/CD ?芸??函蔡??Firebase Hosting?????祉??垢?臭誑雿輻銝?摮??脰?撽皜祈岫??
**6.4. ???蝑**
*   蝟餌絞?∠璅∠??瑽遣霅唬蝙?刻???? (Semantic Versioning) 蝞∠?瘥芋蝯??研靘??賣?唳??皜祈岫?啣?撽??蝵脰甇???啣????澈蝯????撖恍蝘餉?祆?撖衣???澆捆霈??頛胯??乩耨敺拐誑撠??祉雿?
**6.5. ???隤?*
*   ?拍 Firebase ?批?啣? Cloud Logging ??蝟餌絞??隤斤??扯蝑?*   摰?瑼Ｚ?閰喟敦???亥??頂蝯梢隤斗隤?*   閮剖?摰鈭辣?撣豢?瘜??郎 (憒? Telegram)??*   蝬剝???????嗥?扼誨???/?刻/?隞餃?????
**6.6. ??芸?**
*   ???拍 Firestore 蝝Ｗ????亥岷?漲??*   ?敹怠?璈皜?銝?閬???隢? (?垢?砍敹怠??/閮剖?瑼?敺垢??蝞銵函?????*   ? Cloud Functions ?蒂銵銵???甈∩遙??*   ?? Cloud Functions 撣賊?撖虫? (?雿?璈祕靘) 皜??瑕???*   敹?????Cloud Function 閮擃?蝵格?撠芋蝯???函???Cloud Run ???脰?瘞游像?游???
**6.7. 皜祈岫蝑**
*   ??桀?皜祈岫 (雿輻璅⊥????*   ?游?皜祈岫 (皜祈岫?垢??蝡臭漱鈭?頝冽芋蝯?蝔????冽??????蝝啣??頝冽芋蝯??胯?*   蝡臬?蝡舀葫閰?(璅⊥?祕?冽?湔)??蝝啣????垢?啁垢瘚???*   **摰?扳葫閰佗?** **擃?漲**?葫閰?Firestore Rules ??Cloud Function 甈?瑼Ｘ???扼??脰?摰???輔?葫閰艾?*   雿輻???嗆葫閰?(UAT)嚗?隢??雿?甈???撖衣?嗅??脰?皜祈岫??*   ??閮毀璅∪???
**6.8. 鞈?摨怠?隞質??Ｗ儔**
*   ?閬? Firestore 摰??遢璈 (憒蝙??Cloud Storage ???箄?鞈?摨???*   ?嗅?鞈?靽?蝑??*   ?脰??Ｗ儔皜祈岫閮???
**6.9. 摰寥????*
*   ???桅???閮剛?摰寥?寞? (憒????砍蝺拙?璅∪?)??*   蝬剜?銝憟蝯梁??祆?蝔????函? App 雿蝺亙??冽獢?*   ?券?瘚??蝭暺??乩犖撌乩??亥郎蝷箝?
---

**7. 撌脩???◢?芸???(Known Issues & Risk Analysis)**

?砍?獢???銝剖歇霅?箏????典?憿?憸券嚗???澆????孵?釣??
**7.1. ?銵??嗆?撅日憸券**
*   **Cloud Functions ?瑕??辣?莎?** ?冽????????賜??敶梢?單??踵???    *   *撠?嚗? 摰?????賢?嚗??冽?雿銵?閮剖?嚗??賢????箄??孛?澆/?隞餃???*   **蝚砌??寞??????踵?撱園嚗?* 憭隞?????航撠璆剖?銝剜??    *   *撠?嚗? 閮剛??岫璈???獢??蝭暺??乩犖撌乩??亥郎蝷綽??雿輻銝凋???蝯曹???憭?游???*   **鞈?銝?湔扯?蝡嗆?璇辣嚗?* ?撘瑽??Ｙ???航撠鞈??郊銝??湔?銵???    *   *撠?嚗? ? Firestore 鈭?璈??閫??銝??郊?炎?亥?蝒蒂??嚗?閬?蝙?典?蝡舀甈⊥甇??*   **Firestore ?券????祇◢?迎?** 擃撖怠/憭折?摮?航頞??Ｙ?鞎餌?irestore ??? (憒神?交活????    *   *撠?嚗? ?蔥撖怠皜?甈⊥嚗???抒?蒂閮剔蔭?郎嚗????????(甇瑕鞈?頧?)嚗?蝙?冽?瘜矽?渡揣撘?鞈?蝯???*   **Firestore 銴??亥岷??嚗?* 憭扯?璅⊥撅?嚗??閰Ｗ???賣??箸??啜?    *   *撠?嚗? 鞈?蝯??芸?嚗遣蝡??揣撘?銴?閮?頧宏?啣?蝡舀甈∟???*   **Node.js ?桀銵??寞改?** Cloud Functions ?箸 Node.js嚗PU 撖?隞餃??航?餃???    *   *撠?嚗? ???寞活隞餃??蝙?券蝡舀?蝔??隞餃??賢??靘 Serverless Containers (Cloud Run) ??銴?/?瑟??遙??
**7.2. ??恣?惜?ａ◢??*
*   **蝻箔? UI/UX 閮剛?蝔選?** ?舫??菟◢?迎??航撠敺?憭折?隞隤踵?擃??撥?遣霅啁敹怠?敺??萎??Ｚ身閮阮??*   **?詨?敺垢?摩憭折?蝻箏仃??摰?嚗?* 憒???剜?蝞????皜???蝞?雿隤????祟?寞?蝔祕?曄?????擃????*   **蝻箏仃 API 閰喟敦閬?辣嚗?* ?舫??萄?颲虫???銝?潭???圾敺垢?亙?券??詻??澆??航炊?????血?撱箇?甇斗?隞嗚?*   **蝻箏仃 Firestore 摰閬??擃?靘?皜祈岫閮?嚗?* ?舫??萄?颲虫???敶梢撠?赤????園?頛舐??圾??霅????琿?蝭???*   **Firestore 銴?蝝Ｗ??芸?蝢抬?** ?敺齒嚗蔣?踵閰Ｘ??賬?摰儔?琿?蝝Ｗ???*   **蝟餌絞?閮剖???蝵桐?皞?蝒?靽??摩?芾圾瘙綽?** ?閬?圾瘙綽?蝣箔??蔭蝞∠??銝?亙?迤蝣箸扼?*   **??航炊?璈?** Bug ?航撠?垢?嗆?嚗蔣?輻???    *   *撠?嚗? 撘瑕?皜祈岫 (?桀???2E)嚗??亙?蝡舫隤斤?批極?瘀???蝺亙??冽獢?
**7.3. 摰撅日憸券**
*   **摰瞍????** JWT ?急??irestore 閬??蔭?航炊?DoS 蝑?    *   *撠?嚗? 摰?摰??/皛脤葫閰佗?撽? Firestore 閬?嚗???App Check嚗??祇??賣?亙??餌????DDoS ?脰風嚗遣蝡?摰?隞嗆?霈?蝔?*   **XSS ?脰風銝雲嚗?* ?冽頛詨?批捆?芰????湔皜脫?撠瞍???    *   *撠?嚗? ??蝡臬???撓?仿脰??湔撽?????頛詨?啣?蝡舐??豢??脰??拍蝺函Ⅳ??閬?Ｚ???
---

**8. ?芸??撅???(Optimization & Expansion Plan)**

?祉頂蝯勗歇撱箇?蝛拙?箇?嚗靘?寞?璆剖??澆???銵??脤脰???芸??撅?
**8.1. ?剜??芸? (Priority)**
*   **閫?捱?敺齒鈭??◢?迎?** ?芸?摰?蝻箏仃?敹?蝡舫?頛胯?蝢拐蒂皜祈岫 Firestore 摰閬??揣撘圾瘙箏??賊?蝵株?蝒遣蝡底蝝?API 閬?辣??*   **?芸??暹??嚗?* ?寞?撣閰摯?勗??蝙?刻?擖????詨?璅∠????冽扯????憒?銝?擗芋蝯?擃閮找??Ｗ??*   **撘瑕?摰?脰風嚗?* ?券?賢祕 XSS ?脰風????閮恣??蝡舀??炎?亦??芣??
**8.2. ?芯??游??孵? (Future Expansion)**
*   **Kiosk ?芸暺?嚗?* ??撣?拚?擗孛?找??ｇ???暹? POS ?摩嚗???游???Ｗ??怨?????鈭箏?鞎?嚗?????*   **?脤??豢?????璆剜?改?** 撠 BI 撌亙 (憒?Google Data Studio, Tableau)嚗??豢??臬?豢??澈 (憒?Google BigQuery) ?脰?憭扯?璅∪????冽??典飛蝧芋?脰??琿??葫?“摰Ｘ?憭梢?皜研??剖??瘙箇?敺?撽??????*   **??脣潸??餃??Ｗ?嚗?* ?冽??∠頂蝯勗蝷?憓??脣澆??踝???憿批恥暺?摨艾??渲牲??蝞∠?銝衣泵??閬?*   **?游?憭撟喳銝脫嚗?* ?游?銝脫?游?憭像?啜??隞??(憒???隞pple Pay)?摨摮蟡??梁?蝟餌絞?冗蝢文?擃?閰?撟喳 API??*   **憭?閮?絲憭?摨??** ?????(i18n) ?舀嚗??????疏撟??唳?閮摨血??梁?瘜???*   **SaaS 撟喳??** ?琿??格?嚗??暹??嗆????箸???憭???SaaS ?Ｗ?撠??????撥頞?蝞∠?敺???嗉?拚????蔭瘚???潛??嗆???Ｕ?鞎餉??芋蝯???
**8.3. ?銵??脰?**
*   ??閰摯銝行??Firebase Cloud Functions V2 ?????*   ?撠 Serverless Containers (憒?Google Cloud Run) ???閬?暑?扳??孵??啣?靘陷?芋蝯?*   ????銝行?唳??蝙?函? SDK ?洵銝靘陷嚗???冽?啣??扯?寥脯?
---

**9. 蝮賜???蝥郊撽?(Conclusion & Next Steps)**

?砍??箸?暹?鞈?嚗底蝝圈餈唬??????曆??押OS ???啁恣?頂蝯勗?獢??詨?璁艙??銵瑽??賣芋蝯??冽扯?瘙蝵脩雁?遣霅啜歇?仿◢?芾??芯??游?閬??遢?辣?典??頞喳??誨摨血?瘛勗漲嚗蝙隞颱??啁?????賢?敹恍?Ｗ鈭圾撠?嚗蒂?瑕??交????
?箔?霈???賢??湧??Ｗ?交?銝血??擗??隞乩??辣?極雿?擃????颲虫???
1.  **摰? API 閰喟敦閬?辣嚗?* ?????蝡?Cloud Functions API嚗底蝝啗???券TTP ?寞???瘙?URL?撓?亙??豢撘?蝭??????瑽?蝭??隤斤Ⅳ?隤方??航?蝭?2.  **摰儔銝行葫閰?Firestore 摰閬?嚗?* 蝺典神摰??firestore.rules ?辣嚗蒂??閰喟敦隤芣??葫閰衣?靘?蝣箔????Collection ??撖急??敺?湔?批??霅撥?遣霅唬蝙??Emulator Suite ?脰?敺孵?皜祈岫??3.  **摰儔 Firestore 銴?蝝Ｗ?嚗?* ?寞????亥岷璅∪?嚗 firestore.indexes.json 銝剖?蝢拇???閬?銴?蝝Ｗ???4.  **鋆?蝻箏仃?敹?蝡舫?頛荔?** ?芸?撖衣璅??箝??萸??敹耨甇??暺? Cloud Functions嚗?交?芾?閮?????隡啜??皜?雿隤??祟?寞?蝔?蝡臬祕?整????INE Bot 閰??蝑?5.  **閫?捱蝟餌絞??蔭??蝒?靽??摩??嚗?* 蝣箔??閮剖??銝?舫?????靽?璈??6.  **?賢祕?券???冽扳?踝?** ?孵?航撓?仿?霅撓?箇楊蝣?(XSS ?脰風)????閮恣??(雿輻 Secret Manager ?憓?????蝡舀??炎?亦?嚗蒂?脰?摰?扳葫閰艾?7.  **?Ｗ?隞??UI/UX 閮剛?蝔選?** ?喃蝙?舐?獢?嚗??賣扔憭批鼠?拙?蝡舫??潘?皜?餈極??8.  **撱箇? CI/CD Pipeline嚗?* ?芸??葫閰西??函蔡瘚???9.  **閬?閰喟敦?蝵脰?蝬剝?蝑嚗?* ??啣?蝞∠???批?霅艾???隞質??Ｗ儔閮???
摰?銝膩鈭?敺?撠?撠?皜???潭?蝛拙??瑽??游???箇?嚗敺????賢????游?憟??祕?蝷?






---

# ?? 撠??格?????朣?嚗?湔?脣?嚗?
---

## 1. 撠??詨??格?嚗MART ??

| ? | 隤芣? |
|:---|:---|
| ?格? (Specific) | 撱箇?銝憟?????抒??撣嗚???銝?擗??OS暺?+敺蝞∠?蝟餌絞??銝行?撌乓鞈??准???嫘??～??澈摮恣?銝擃?銝?渡?啗”璈憓??箏??|
| ?航﹛??(Measurable) | 摰?蝟餌絞?敺?90%???賭誑?祉頂蝯望???????隞乩??“摰Ｚ??桅隤斤???20%?撌亦恣??????0%???嗉????100%??|
| ?舫???(Achievable) | ? Firebase ?券蝡舫蝵?PWA?孵?嚗?蝡?Functions 璅∠??身閮??垢?⊿?摰? App 銋雿輻嚗祕??潔????折??澆???MVP??|
| ?賊???(Relevant) | 摰?舀?????抵??桅?????游?銝剔?憭?摨??芋撘?銝阡???蝘 SaaS ?游?璈??|
| ?? (Time-bound) | 2025 撟?8 ?????Beta ??蝺?2025 撟?10 ?迤撘??典?摨蝙?具?|

---

## 2. 鈭支????抬?Deliverables嚗?
- **?垢 PWA 蝟餌絞嚗OS暺?蝡??∪極??蝡?蝞∠?敺蝡荔?**
- **敺垢 API 蝟餌絞嚗irebase Cloud Functions V2嚗?*
- **Firestore 鞈?摨怎?瑽??怎揣撘?**
- **LINE/LINE Pay ?游?璅∠?**
- **憭像??API ?游?璅∠?嚗ber Eats, Foodpanda嚗?*
- **???亥?蝟餌絞???冽扯身閮?隞?*
- **摰?函蔡?單?憓身摰?**
- **雿輻??雿???蝪⊥???**
- **?銵??潭???API, Rules, Data Model嚗?*
- **閮毀鞈?嚗恣?垢???飛?撌亦垢暺??飛**

---

## 3. 撠?蝭?嚗n Scope嚗?
??POS 暺?璅∠?嚗WA嚗? 
???∪極?餃???～??准??恣?? 
???瑕鞈??駁???柴?撣喉??舀?暸?+LINE Pay嚗? 
???箏璈蝡臬??堆??交??啗”璈???∪銵冽??＊蝷箏?Ｗ?  
???蝟餌絞嚗INE Login敹恍?摰?  
??憿批恥閰璈嚗INE??嚗? 
??摨怠??箸蝞∠?嚗?典鞎具?摨衣暺?  
??憭乩撈嚗撌伐????鞈?蝞芋蝯? 
??憿批恥蝺?閮?嚗??堆?  
??敺蝞∠?蝟餌絞嚗?????蝬???嚗? 
??蝟餌絞蝞∠?敺嚗?蝝恣???嚗? 
??撱????蝞∠?嚗?典誨??  
???刻蝣??典誨閮餃??璈  
??蝪⊥??梯”??銵冽嚗?柴?扎澈摮撣賂?  
???Ｙ????舀嚗WA蝺拙??/閮?阮嚗?
---

## 4. ????Out of Scope嚗??孵璅?嚗?
??銝??澆???App嚗ndroid/iOS ??App嚗? 
??銝祕雿???ERP / ?脤摮恣???芸??漲?怨疏+?日?嚗? 
??銝?瓷??閮頂蝯梧?靘??箇蜇撣喋???梧?  
??銝撱箏恥?頂蝯梧?LINE蝢斤?皞獢???  
??銝?乩葡?交摨??摮蟡剁??啁蝯曹??潛巨撟喳嚗? 
??銝?湧 LINE 隞亙??冗蝢斗??憒?FB Messenger?G蝑獢?  
??銝?摰Ｚˊ?????嗥?璅??銝駁?嚗??舀璅??蜓憿?  
??銝?渲楊?疏撟??撟??撣喉????啁?啣撟??  
??銝?渡撣賊?摨血恥鋆賢? API ?游?嚗ber/Foodpanda隞交?皞PI璅∠??游?嚗?
---

## 5. ?蝮暹???嚗PI嚗?
- 90%隞乩???撠銝?敺???頂蝯?- POS閮摰??航炊????20%嚗誑?亥??格??臬蝯梯?嚗?- ????～鞈???銝剖漲??95% 隞乩?
- 憿批恥摰?閮?敺?憛怨??寧???30%
- ?湧???梯”?芸???蝣箇???99%

---






---

# ?? 雿輻???脣?蝢抬?User Roles嚗?
| 閫?迂 | 隤芣? | ?詨?甈?蝭? |
|:---|:---|:---|
| 頞?蝞∠???(Super Admin) | 蝟餌絞撟喳蝞∠???鞎痊蝘嚗?摰塚?蝞∠??頂蝯勗??貉身摰誨???刻閬?蝞∠???| ?舫脰?????嗥?璅⊥?餃???貉身摰祟?貊恣?誨?身摰?衣頂蝯梯身摰???扼?|
| 蝘蝞∠???(Tenant Admin / 摨) | ??摨恣??鞎痊?砍????撌亦恣??| ?∪極蝞∠????桃恣???桃恣???∠恣???准?鞈??身摰??????|
| ???∪極 (Store Staff / ?∪極) | 銝餉?鞎痊?曉?亙???～?擗澈摮?雿?| ?銝??准?擗?柴???啜??剜??株???鈭扎??隢?|
| 憿批恥 (Customer) | 雿輻蝺?暺?蝟餌絞暺???甈曄?蝯垢瘨祥??| 蝺?暺????格閰Ｕ?甈整??孵?擖??∩葉敹??|

---

# ?? 雿輻獢?摰儔嚗ser Cases嚗?
### 2.1 頞?蝞∠??∠?雿輻獢?
- ?餃頞?敺蝞∠?蝟餌絞
- ?啣?/蝺刻摩/?蝘嚗?摰塚?
- ?亦?蝘?”?蝙?函?瘜?- 閮剖??典???嚗?憒??蝭??隡嚗?- 蝞∠??刻閮餃??閬?
- 銝??摨誨??雿?- ?亦???蝮質汗?梯”嚗楊蝘?舐蜇嚗?- ?亦???箏?蝔格?雿隤?- 閮剖?蝟餌絞?砍?嚗撟喳?改?
- ?嗅摰?郎?嚗??啣虜?餃??擃???

---

### 2.2 蝘蝞∠??∴?摨嚗?雿輻獢?
- ?餃蝘敺
- ?亦?瘥/瘥???梯”
- 蝞∠????嚗憓??柴身摰?潘?
- ?晷?∪極?身摰撌亥雿?甈?
- ??矽?剔恣??- ?芾???撖拇?耨甇?- ?/?靽瘣餃?嚗???芣??賂?
- ?澆??撣?砍?蝯血撌?- ???瑕?啣虜??瘨
- 撖拇?∪極隢??唾?
- 撖拇鋆??∠隢?- ?亦?憿批恥閰閮?
- ?芾????怨?閬??撟＊蝷箄身摰?
---

### 2.3 ???∪極嚗丰隡湛??蝙?冽?靘?- 雿輻LINE?餃?撌亙董??亦頂蝯?- ?銝??哨?GPS摰?嚗?- ?亦??銵?- ?亙??擗??柴?柴?瘨??殷????嚗?- ??閮隞狡嚗?INE Pay嚗?- 憛怠神?漲?日?銵剁?摨怠??賊?嚗?- ?漱?怨疏?殷??折?怨疏?唾?嚗?- ?漱隢??唾?
- ?唾?鋆???- ?亦??犖??蝝航???斤???- 摰?閮毀隤脩??????亥?摨怠??踝?

---

### 2.4 憿批恥?蝙?冽?靘?- ?脣蝺?閮??
- ?汗?嚗?????亥頃?抵?
- ?芾????賊?嚗???啜?颲??嚗?- ?豢??????撘?憭葆/?抒嚗?- 摰?隞狡嚗??港?甈整?LINE Pay蝺?隞狡嚗?- ?亦?閮?脣漲嚗ˊ雿葉????
- ???嚗＊蝷箏?擗?蝣潭?LINE??嚗?- ?交閮摰?敺?閰??隢?- 憛怠神閰嚗?蝑???嚗?
---

# ?? 雿輻????? ?甈??拚嚗ummary嚗?
| ?/閫 | 頞?蝞∠???| 蝘蝞∠???| ???∪極 | 憿批恥 |
|:---|:---:|:---:|:---:|:---:|
| ?餃蝟餌絞 | ??| ??| ??| ??憿批恥蝡舐?銝?擗? |
| ?銝???| ??| ??| ??| ??|
| 暺??亙 | ??| ??| ??| ??|
| ?蝞∠? | ??| ??| ?亦? | ??|
| ?蝞∠? | ??| ??| ??| ?亦? |
| 閮蝞∠? | ??| ??| ??| ?亦? |
| ?瑕/?芾??梯” | ???舐蜇嚗?| ???砍?嚗?| ?亦??犖 | ??|
| 憿批恥閰蝞∠? | ??| ??| ?亦??犖 | 憛怠神 |
| 摨怠?蝞∠? | ??| ??| ?日?/?怨疏 | ??|
| ?砍??澆? | ???典像?堆? | ?????改? | ?亦? | ??|
| ?刻/撱??蝞∠? | ??| ??| ??| ??|

---



# ?? ?詨???折?瘙?朣?隞亙??賣芋蝯?桐?嚗?
---

## 3.1 ?∪極??嚗PS 摰??嚗?
**??膩**嚗?- ?∪極敹??潭??剜?畾菟?憪????剖??蝯?敺????剖??- ??????閮剖????甈?Geo-fence嚗嚗?瘜??～?
**?瘚?**嚗?1. ?∪極???∪極蝡烈WA ???????～?2. 蝟餌絞??雿輻???雿漣璅?3. 撽?摨扳??臬?典?閮梁??嚗?敺身摰潘?憒?50 ?砍偕嚗?    - **?亙蝭?????憿舐內????恍嚗?????雿蔭??*
    - **?乩??函?? ??憿舐內?航炊嚗?典?蝭??扼?*

**?航炊??**嚗?- 摰?憭望? ???內????摰??銝阡?閰艾?- 摰?鞈?銝????????銝衣??隤斗隤?
**鞈?閮?**嚗?- ?憿?嚗???銝嚗?- ???嚗imestamp嚗?- GPS摨扳?嚗?蝺臬漲嚗?- ??ID嚗toreID嚗?- ?∪極ID嚗taffID嚗?- ?蝯??????/憭望?嚗?
---

## 3.2 蝺?暺??嚗“摰Ｙ垢嚗?
**??膩**嚗?- 憿批恥?????R Code??仿?蝺?閮?蝬脤???- ?臭誑?汗????柴?甈整蕭頩方??桅脣漲??
**?瘚?**嚗?1. 憿批恥?脣閮??????汗???2. ?豢?擗???????憒?韏瑕/?餃/?麾嚗?3. ?鞈潛頠?4. 蝯董 ???豢?隞狡?孵?嚗?INE Pay嚗?5. ??隞狡敺?蝟餌絞?Ｙ?閮銝行?摰?蝯?擗?蝣潦?
**?航炊??**嚗?- 隞狡憭望? ???內??甈曉仃??隢?閰艾?- ?鞈?頛?航炊 ??憿舐內?航炊?銝阡?閰行??嗚?- ?園?暺摰?嚗??閮?摰??舫??詻?
**鞈?閮?**嚗?- 閮蝺刻?嚗rderID嚗?- 憿批恥ID嚗????餃嚗?- 擗?皜嚗roducts嚗?- ??嚗otalPrice嚗?- 隞狡???Pending / Paid嚗?- 閮???鋆賭?銝?/ 摰? / 撌脣?瘨?
- ???Ⅳ嚗ickupNumber嚗?
---

## 3.3 ?蝞∠?璅∠?

**??膩**嚗?- 摨???頂蝯梯???准?- ?∪極?臭誑?亦??芸楛?銵具隢???隤輻??
**?瘚?**嚗?1. 摨?餃敺 ???脣?蝞∠???2. ?豢??遢 ???晷瘥?剜活?撌乓?3. ?澆??剛” ??蝟餌絞?冽?憭乩撈?亦???4. ?∪極?舀炎閬撌梁????5. 隢??唾? ??蝞∠??∪祟?詻?6. 憒?鈭箄???摨?舫??唳?瘣暹??隞??唾???
**?航炊??**嚗?- ?∪極?芸????剔Ⅱ隤?????銝阡?摰??∪??賬?- 隢?頞?蝳?????蝟餌絞?芸??????亦?隡蒂?銝餌恣?孵?詨??
**鞈?閮?**嚗?- ?剛”嚗chedule嚗?- ?∪極ID嚗taffID嚗?- ??交?
- ?挾嚗?憪?蝯???嚗?- 隢?閮?嚗eaveRequests嚗?- 隞?閮?嚗ubstitutionRequests嚗?
---

## 3.4 ?芾?????蝞頂蝯?
**??膩**嚗?- 瘥??寞??箏蝝?平蝮整??遙???蝞鞈?- 摨?舀敺撖拇銝虫耨甇??
**?瘚?**嚗?1. 瘥???嚗?孛?潸鞈?蝞?2. ?寞??∪極?瑞????芥??∠?????桅?蝑?璅?蝞鞈?3. ?芸?蝝舐????????瑕???”?曄??畾暑??????4. 摨?餃敺 ???芾?撖拇? ???仿?靽格迤?舐楊頛胯?5. 蝣箄??潸 ??蝟餌絞??閰脫??芾?嚗撌亙?亦??敦??
**?航炊??**嚗?- ?亥???摰嚗?瞍??∴? ??蝟餌絞璅??啣虜銝西郎??鋆??
**鞈?閮?**嚗?- ?∪極ID嚗taffID嚗?- ?祆?蝮賢?文予?貉?撠???- ?????”嚗alesBonus, PerformanceBonus嚗?- 隢???閮?
- ?祆????芾?嚗otalPay嚗?- ?詨??耨?寞風?脩???AuditLogs嚗?




---

# ?? ???賣折?瘙??渲???
---

## 4.1 ??瘙?Performance Requirements嚗?
| ?                           | ?琿?璅?                                                         |
|--------------------------------|------------------------------------------------------------------|
| ?頛??                   | 擐??撌交??∠?Ｗ甇?虜4G蝬脰楝?啣?銝?擐活頛撠3蝘?              |
| ??雿輻?嚗撌亦垢嚗?          | ?舀瘥???30鈭箸?雿?暺????～閰Ｘ??哨????⊿?                  |
| ??雿輻?嚗“摰Ｙ垢嚗?          | ?舀瘥振摨撠???00蝑?銝??格閰Ｘ?銝嚗WA璅∪?嚗?                |
| 敺垢API????                 | 銝?祆?雿PI嚗??寞活雿平嚗像??????500ms                        |
| ?脩垢?蝟餌絞嚗?殷?             | 暺?啣??啁?撱園?撠5蝘?                                         |
| ?閮?/?芾??寞活????        | 1000鈭箏?芾??寞活閮?摰???撠10??                               |
| ?Ｙ?摰寥                        | PWA???舀?剜??∠雯嚗????改?銝蔣?輸?擗??嚗敺拍雯頝臬??芸??郊   |

---

## 4.2 摰?折?瘙?Security Requirements嚗?
| ?                           | ?琿?璅?                                                         |
|--------------------------------|------------------------------------------------------------------|
| 頨怠?撽?嚗uthentication嚗?     | - ?∪極蝡臭蝙?汪INE Login / Email-Password <br> - 憿批恥蝡臬?踹??INE Login |
| 閫???蝞∴?Authorization嚗?| - ?∪極蝡臬祕?賜敦蝺餅??蝞∴?6撅斤?閫嚗?撘瑕瘥PI撽?閫/摨         |
| ?唾撓摰嚗ata in Transit嚗?    | - ?函?撘瑕HTTPS <br> - 憭API?游?敹??舀TLS 1.2?擃?            |
| 鞈??脣?摰嚗ata at Rest嚗?   | - Firebase Firestore靽風 <br> - 璈?甈?嚗?隞狡蝝??AES-256??   |
| 蝟餌絞?亥?閮?嚗udit Logging嚗?  | - 蝞∠?蝡舀???憭扳?雿?憒鞈耨?嫘???對??閮???鈭箏????IP    |
| ?脫迫?游??餅?嚗rute Force Protection嚗?| - ??餃?航炊甈⊥嚗???甈⊿??瑕3??                                 |
| App Check                     | - ??Firebase App Check撽?靘?瘚??脫迫瞈怎                         |
| DDoS?脰風                      | - HTTP Functions???餌???loud Armor?脰風撅歹??舫嚗?               |

---

## 4.3 ??折?瘙?Usability Requirements嚗?
| ?                           | ?琿?璅?                                                         |
|--------------------------------|------------------------------------------------------------------|
| ?活摮貊??                   | ?∪極蝡荔?????准?擗???臬5???抒??摰??箸??               |
| 撠?摩????                 | - 憿舐內皜????/??蛛?銝?箇??甇餉楝                           |
| ?⊿?蝷?Accessibility嚗?        | - 蝚血?WCAG 2.1 AA蝝?瘙?憒敶拙?瘥?蝐斗?閮?斗?雿?湛?           |
| ?航炊?內                       | - 敹??其蝙?刻?雿隤斗?皜??內?航炊???遣霅啗???                    |
| 憭?蝟餅?湛??芯??游?嚗?          | - ?垢閮剛????i18n?游?蝯?                                          |

---

## 4.4 ?舀撅折?瘙?Scalability Requirements嚗?
| ?                           | ?琿?璅?                                                         |
|--------------------------------|------------------------------------------------------------------|
| 璈???                      | ???函蔡?厲irebase asia-east1嚗??撅??賢翰??鋆質asia-northeast1  |
| 鞈?摨急撅?                    | ?舀?ollection?脣?憭??嗉???1?砍??芾????賜??扳撅?               |
| ?璅∠???                    | 瘥芋蝯?憒??～?擗鞈???賜蝡?蝝??踵?嚗?蔣?踹隞???      |
| ?寞活??蝔?璆?                | 雿輻Pub/Sub + Cloud Tasks蝯?嚗Ⅱ靽之閬芋雿平?臬??????               |

---

??隞乩????賬??冽扼??冽扼?游??抒????賣扳?皞?*摰鋆?**鈭?銝?冽**?琿??航﹛??璅?**嚗?湔?脣蝟餌絞閮剛????潦?
---

# ?? ?格?雿輻??雿輻獢?摰儔

---

## 5.1 雿輻???脫??株?甈?摰儔嚗??渡?嚗?
| 閫         | 隤芣?                               | 銝餉?甈?????|
|-------------|----------------------------------|----------------|
| 頞?蝞∠??∴?Super Admin嚗?| SaaS撟喳?擃恣?惜嚗恣?????嗚誨??艾像?啗身摰?| - ?亦?/蝞∠?????嗉???<br> - 閮剖?撟喳撱????行?隞?<br> - 撖拇蝘鞈?/撠?撣唾? <br> - ?亦?撟喳蝮賡?蝯梯??隤?|
| 蝘????Tenant Owner嚗?| 摨振鞎痊鈭綽???摨???雿?蝞∠?甈?           | - 蝞∠???閮剖?????<br> - 蝞∠??∪極?????芾?閮剖? <br> - 瑼Ｚ?/靽格閮?澈摮銵?<br> - 撖拇憿批恥閰?撱?暑?身摰?|
| ??蝞∠??∴?Store Manager嚗?| ?桐????亙虜??鞎痊鈭?                    | - ?亦?/蝞∠??砍??∪極????～?株???<br> - ?箏?鞎具暺?璆剔恣??<br> - ?瑁??典???/?芾??郊撖拇 |
| ?∪極嚗taff嚗?| ?撣撌伐?鞎痊?曉雿平                     | - 暺????～?銵刻??芾??敦 <br> - ?箏雿平??桀???|
| 憿批恥嚗ustomer嚗?| 憭雿輻????PWA閮????⊥暑??            | - ?亥岷/銝/?亦????Ⅳ <br> - 蝞∠??犖?鞈? <br> - ?嗅閮摰?閰?隢?|

---

## 5.2 ???脖蜓閬???蝔??詨?Use Case嚗?
### (1) 頞?蝞∠??∩蜓閬?蝔?
- ?餃蝞∠?撟喳
- ?亦?蝘?”?祟?豢蝘?唾?
- 閮剖?撟喳撱??????行暑????- ???典像?啁????靘?嚗酉?????桅??誨????
- ?亦????亥??祟?貉??臭遙?銵?瘜?
---

### (2) 蝘???蜓閬?蝔?
- 擐活?餃閮餃?蝘鞈? ??銝??Logo??摰嗅?祈???- 撱箇?????憿?- 閮剖???鞈?嚗?蝵柴?璆剜???????
- ???∪極 ??撖拇LINE?餃?唾? ???晷?瑚???摨?- ?蔭??芣?瘣餃????哨?靘?嚗??亙??血末??
- ?亦??瑕/摨怠?/?芾??梯”
- 撖拇????????鞎函隢?
---

### (3) ??蝞∠??∩蜓閬?蝔?
- ?亦??嗆?潛銵刻??箏???- ???平 ?????曉暺????- ?亦?/蝞∠??嗆閮????抒/憭葆/憭?
- 瘥?? ???漱?瑕? ???舐蜇?箏?豢?
- ?潮???憒????啣虜?嚗?
---

### (4) ?∪極銝餉?瘚?

- LINE敹恍?亦頂蝯?- ?脰?GPS?銝???- 瑼Ｚ??犖?剛”?隢???隤輻
- ??憿批恥暺???甈橘??抒/憭葆/憭?
- ?亦??犖蝝舐????鞈???
---

### (5) 憿批恥銝餉?瘚?

- ??PWA ??敹恍汗?
- 暺?Ｗ? ???鞈潛頠???銝嚗?甈暸???啣?隞狡??銝?甈橘?
- ??閮?Ⅳ ??蝺??亦?鋆賭??脣漲
- ??摰? ???交LINE?冽?隢???憛怠神蝪∪憿批恥??閰銵典

---

# ?? 雿輻獢?銵剁?蝎曄陛蝭???

| 蝺刻? | 雿輻????| ?格?                    | 蝟餌絞鈭?瘚?蝪∟膩 |
|------|-----------|-------------------------|-----------------|
| UC01 | ?∪極       | 摰?銝??剜???            | ??PWA ???芸?摰? ??憿舐內????????蝣箄????閮 |
| UC02 | ?∪極       | 撱箇??啗??桐蒂?箏          | 暺?閮?????豢??? ???酉 ??蝣箄? ???箏? |
| UC03 | 蝘????| ???恣?丰隡?            | ?潮INE?餃?隢????∪極???撣唾? ??蝞∠??∪祟?貉??晷?瑚? |
| UC04 | 憿批恥       | 蝺?敹恍?鞈潮???          | ??QR Code ???豢?擗? ???鞈潛頠???憛怨?????銝隞狡 |
| UC05 | ??蝞∠???| ?亦??祆?瑕???剜?瘜?      | ?脣蝞∠?隞 ??暺???亙銵具????亦??瑕?撌亙?剛???|
| UC06 | 頞?蝞∠???| 閮剖??典像?唳??刻閬?     | ?脣頞恣敺 ??蝺刻摩?刻閮剖? ???脣?敺?????冽 |

---


---

## 6.1 ?銵ㄖ (Technology Stack)

| 撅斤?         | ?銵??                        | 隤芣?                                 |
|-------------|---------------------------------|-------------------------------------|
| ?垢 (PWA)  | HTML5 + CSS3 + JavaScript (ES2021) | ?∠摰??塚?撠?璅∠????潛?瑽?|
| ?垢SDK    | Firebase JS SDK v9.x Compat??      | 雿輻 Firebase Hosting, Auth, Firestore, FCM |
| 蝚砌??寧?? | LINE Login (LIFF SDK 2.21.4)        | 憿批恥?撌亦絞銝 LINE ???餃 |
| 敺垢API    | Firebase Cloud Functions V2 (Node.js 20) | 銝餉?鞎痊?平?摩?洵銝?游????臭遙??|
| 敺垢SDK    | Firebase Admin SDK 13.x+             | 敺垢蝞∠?Firebase鞈? |
| 鞈?摨?      | Firestore (NoSQL Document DB)        | 擃辣撅扼楊蝘???湔?璈翰????|
| ?冽??    | Firebase Cloud Messaging + LINE Notify + Telegram Bot API | 蝟餌絞?折??閬郎蝷粹 |
| ???游?    | LINE Pay API                         | 蝺?隞狡??嚗?? |
| 憭像?唳??| Uber Eats, Foodpanda API (Webhook?郊璅∪?) | 憭??格??POS 蝟餌絞 |
| 隡箸??典?  | asia-east1 (敶啣?) + asia-northeast1 (?曹漪) | ??撱園???帘摰?|
| ?函蔡撌亙    | Firebase CLI 12.x 隞乩???+ GitHub Actions (?芯?撱箄降) | CLI?函蔡+CI/CD閬? |
| 摰?批?撘? | Firebase AppCheck + Secret Manager     | ?踹??⊥?隢??恣??????|
| ??啣?    | VSCode + Firebase Emulator Suite       | ?砍??葫閰行芋?砍?啣? |

---

## 6.2 ??鞈?璅∪?嚗RD ? 1.0 ??嚗?
?? 銝餅敹”嚗?
```
(蝘蝞∠?撅?
Tenants { tenantId (PK), ownerUid, storeCount, planType, active }
Stores { storeId (PK), tenantId (FK), storeName, location, openHours, gpsFence, printerSettings }

(??“摰Ｗ惜)
Customers { customerId (PK), tenantId (FK), lineUid, displayName, phone, birthday, points, memberTags }
Orders { orderId (PK), tenantId (FK), storeId (FK), customerId (FK), items[], status, paymentInfo, createdAt }

(?∪極蝞∠?撅?
Employees { employeeId (PK), tenantId (FK), lineUid, role, assignedStores[], salarySettings, active }
AttendanceRecords { recordId (PK), employeeId (FK), storeId (FK), clockInTime, clockOutTime, gpsLog, type }

(??鞈惜)
Shifts { shiftId (PK), storeId (FK), startTime, endTime, assignedEmployees[] }
Payrolls { payrollId (PK), employeeId (FK), month, baseSalary, bonusAmount, deductions, totalSalary }

(????桀惜)
Menus { menuId (PK), tenantId (FK), categories[], items[] }
InventoryItems { inventoryId (PK), storeId (FK), itemName, stockQty, unit, lastUpdate }
SalesReports { reportId (PK), storeId (FK), salesAmount, orderCount, date }

(蝟餌絞???典惜)
Settings { tenantId (PK), configs (JSON) }
AuditLogs { logId (PK), actionByUid, actionType, target, timestamp }
Notifications { notificationId (PK), tenantId (FK), type, payload, createdAt }

(撱?????
Ads { adId (PK), tenantId (FK), adType, placement, contentUrl, activePeriod }
Referrals { referralId (PK), code, inviterUid, inviteeUid, activatedAt }

```

>嚗??閮鳴?隞乩? ERD ?航楊蝘嚗?????????撣?`tenantId` 撘瑕???

---

## 6.3 API 閮剛???嚗?閬垢暺?靘?

| ??憛?    | ?寞? | 頝臬?                                | 蝪∟膩                   | ?酉                 |
|------------|----|----------------------------------|----------------------|---------------------|
| ?餃撽?     | POST | /auth/exchangeLineToken           | 鈭斗? LINE Token ?? Firebase Token | |
| 憿批恥銝     | POST | /orders/create                    | 憿批恥撱箇??啗???           | ?垢 PWA ?澆 |
| 憿批恥???脣漲?亥岷 | GET  | /orders/{orderId}/status           | ?亥岷閮鋆賭?/摰????       | |
| ?∪極?     | POST | /attendance/clockIn               | GPS ?銝             | ???GPS摨扳? |
| ?∪極?     | POST | /attendance/clockOut              | GPS ?銝             | ???GPS摨扳? |
| ?蝞∠?     | POST | /shifts/generate                   | ?芸????剛”             | |
| ?瑕?     | POST | /salesReports/submit               | ?嗆?瑕?豢?憛怠          | |
| ?蝞∠?     | GET  | /customers/profile                 | ?亥岷?鞈?             | |
| ???   | POST | /coupons/redeem                    | ???瘣餃??芣???         | |
| ?怨?蝞∠?     | GET  | /orders/{storeId}/currentQueue     | ?亥岷?桀??????”        | |
| 撱????     | GET  | /ads/fetch                         | ??撱??鞈?嚗“摰Ｙ垢/?∪極蝡荔?   | |
| ?刻璈     | POST | /referrals/redeem                  | ???刻?             | |

???券韏?HTTPS endpoint?irebase Auth 撽???蝡臬撥?嗆炎??tenantId + 甈?蝑???
---

# ? ??鋆?

- ???API ?賣??批遣嚗?*甈?撽? ??TenantID 撽? ???撽? ???瑕???航炊**??- API ?航炊??澆?蝯曹?嚗?嚗?
```json
{
  "success": false,
  "errorCode": "ERR_PERMISSION_DENIED",
  "message": "?冽????銵迨????
}
```

- ?芋蝯???Firestore 蝝Ｗ? (`firestore.indexes.json`) ??摰閬? (`firestore.rules`) ??雿菔???
---


---

### ??Tenants嚗??嗉?閮”嚗?
| 甈???        | ??        | 敹‵ | 撽?閬?                                | 隤芣? |
|---------------|------------|-----|----------------------------------------|-----|
| tenantId      | string     | ??  | UUID?澆?                               | ?臭?蝘霅蝣?|
| ownerUid      | string     | ??  | Firebase UID?澆?                       | ???澈隞?|
| storeCount    | number     | ??  | >=0                                    | ?撣??|
| planType      | string     | ??  | enum: ['free', 'basic', 'pro', 'enterprise'] | 雿輻?寞?憿? |
| active        | boolean    | ??  | true/false                             | 蝘????|

---

### ??Stores嚗?撣??”嚗?
| 甈???          | ??        | 敹‵ | 撽?閬?                                    | 隤芣? |
|-----------------|------------|-----|------------------------------------------|-----|
| storeId         | string     | ??  | UUID?澆?                                 | ?臭??撣??亦Ⅳ |
| tenantId        | string     | ??  | UUID?澆?                                 | ?撅祉???|
| storeName       | string     | ??  | 1~50摮?                                  | ?撣?蝔?|
| location        | map        | ??  | ? address(string), lat(number), lng(number) | ?撣????蝵?|
| openHours       | array      | ??  | ????扳???蝝???start(string), end(string) (?澆? 'HH:mm') | ?平?? |
| gpsFence        | map        | ??  | ??蝭???嚗eter, number嚗?銝剖?摨扳? | ??啁??? |
| printerSettings | map        | ??  | API URL(string), API Key(string)         | ?脩垢?啗”璈身摰?|
| createdAt       | timestamp  | ??  | Firestore Timestamp?澆?                  | ?萄遣?? |
| updatedAt       | timestamp  | ??  | Firestore Timestamp?澆?                  | ?湔?? |

---

### ??Customers嚗“摰Ｚ??”嚗?
| 甈???       | ??        | 敹‵ | 撽?閬?                                | 隤芣? |
|--------------|------------|-----|----------------------------------------|-----|
| customerId   | string     | ??  | UUID?澆?                               | 憿批恥ID |
| tenantId     | string     | ??  | UUID?澆?                               | ?撅祉???|
| lineUid      | string     | ??  | LINE UserID?澆?                        | 蝬?LINE撣唾? |
| displayName  | string     | ??  | ?憭?0摮?                              | 憿批恥?迂 |
| phone        | string     | ??  | 甇??銵函內撘? ?啁???澆? ^09\d{8}$        | ???Ⅳ |
| birthday     | string     | ??  | ?澆?: 'YYYY-MM-DD'                      | ? |
| points       | number     | ??  | >=0                                    | 蝝舐?暺 |
| memberTags   | array      | ??  | ????抒string嚗摨阡???5              | ?芾?璅惜 |
| createdAt    | timestamp  | ??  | Firestore Timestamp?澆?                  | ?萄遣?? |
| updatedAt    | timestamp  | ??  | Firestore Timestamp?澆?                  | ?湔?? |

---

?儭?瘥??”?潭??見?冽?雿?蝭???
嚗??箇?撟?憭???敹恍?莎???其蜓鞈?銵冽?雿?銝隞質?摰璅?鞈?摮嚗?

---

## 7.2 鞈?撽?閬?鋆?嚗alidation嚗?
1. **ID甈??撥?貸UID?澆??irebase UID?澆?撽???*  
2. **摮葡?瑕漲?撘瑕?撥嚗I蝡臭??內嚗?蝡臭???嚗?*  
3. **?交?甈??券璅???ISO ?澆? ('YYYY-MM-DD' or 'YYYY-MM-DDTHH:mm:ssZ')??*  
4. **??甈?銝??箄??賂?暺甈?銝??箄??詻?*  
5. **雿輻Enum摰儔?賊??箏?蝭?嚗?憒??脯???甈暹撘?嚗?*  
6. **瘥???Collection嚗憓???createdAt / updatedAt timestamp??*  

---

## 7.3 鞈?瘚?嚗FD嚗???
隞乩??臭蜓閬?????靽?Data Flow Diagram - 擃???嚗?
```
?“摰Ｘ?雿?蝔?憿批恥PWA -> 閮餃????(LINE) -> Customers
憿批恥PWA -> 銝???-> Orders
憿批恥PWA -> ?亥岷???脣漲 -> Orders.Status
憿批恥PWA -> 閰擗? -> Notifications

?撌交?雿?蝔??∪極PWA -> ? -> AttendanceRecords
?∪極PWA -> 暺?雿平 -> Orders
?∪極PWA -> ?日?/?怨疏 -> InventoryItems
?∪極PWA -> ?漱?瑕?梯” -> SalesReports

???啁恣??蝔?摨敺 -> ?∪極蝞∠? -> Employees
摨敺 -> ?剛”? -> Shifts
摨敺 -> ?芾??貊? -> Payrolls
摨敺 -> 撱??/?芣?閮剖? -> Ads

?頂蝯梯???臭遙??Firebase Scheduler -> ?? Bonus 隞餃?閰摯 -> Payrolls
Firebase Scheduler -> 摰??潮??亙??-> Customers

???函頂蝯曹???LINE撟喳 -> LINE Login 隤?
LINE Pay -> ?臭?? -> Orders.PaymentInfo
Uber/Foodpanda -> 閮 Webhook -> Orders
```

---

# ??撠?

?曉嚗??歇蝬???
- ???”??雿身閮?- 鞈?撽?閬?
- 鞈?瘚??? DFD ??

?誨銵剁?

??鞈?摨怠隞亙遣蝵柴? 
??API???璆?鞈?蝯?靘??? 
???垢?臭誑?仿?鞈?閬獐???獐霈?? 
??皜祈岫???嗅隞交??Ⅱ靘??? 

---


---

# ?? 鞈?銵典??渲身閮??怠???+ ?澆?蝭?嚗?
## 1. Tenants嚗??嗉?閮?

| 甈???        | ??        | 敹‵ | ?澆?/?                          | 蝭?                   | 隤芣? |
|---------------|------------|-----|-----------------------------------|------------------------|-----|
| tenantId      | string     | ??  | UUID?澆?嚗?撖恬?                    | `"c25f1b56-8e88-4d4c-97f4-8c5d5ee91e55"` | ?臭?蝘 |
| ownerUid      | string     | ??  | Firebase UID ?澆?                  | `"A4sPqUzoaAd9MZ6hwfPYJd4cRCw1"` | ???澈隞?|
| storeCount    | number     | ??  | >= 0 甇???                       | `2`                    | ?撣 |
| planType      | string     | ??  | ENUM: `'free'|'basic'|'pro'|'enterprise'` | `'basic'`               | 蝘雿輻?寞? |
| active        | boolean    | ??  | true/false                        | `true`                  | ????|
| createdAt     | timestamp  | ??  | Firestore Timestamp?澆?            | `Timestamp.now()`       | ?萄遣?? |
| updatedAt     | timestamp  | ??  | Firestore Timestamp?澆?            | `Timestamp.now()`       | ?湔?? |

---

## 2. Stores嚗?撣?閮?

| 甈???          | ??        | 敹‵ | ?澆?/?                          | 蝭?                   | 隤芣? |
|-----------------|------------|-----|-----------------------------------|------------------------|-----|
| storeId         | string     | ??  | UUID?澆?                          | `"5f3e2f74-89bc-4a4b-a2f2-ef930b03ff3e"` | ?臭??撣?|
| tenantId        | string     | ??  | UUID                              | `"c25f1b56-8e88-4d4c-97f4-8c5d5ee91e55"` | 蝘? |
| storeName       | string     | ??  | 1-50摮?                           | `"?批ㄑ敹?摨?`             | ?撣?蝔?|
| location        | map        | ??  | address(string), lat/lng(number)   | `{ address:"獢?撣葉憯Ｗ?敹?頝?, lat:24.956, lng:121.225 }` | ?啁?鞈? |
| openHours       | array      | ??  | ???嚗tart,end ?澆?'HH:mm'         | `[ {start:"10:00", end:"22:00"} ]` | ?平?? |
| gpsFence        | map        | ??  | center(lat, lng), radius(m)        | `{ lat:24.956, lng:121.225, radius:100 }` | ?蝭? |
| printerSettings | map        | ??  | apiUrl(string), apiKey(string)    | `{ apiUrl: "https://printer.xxx.com/print", apiKey: "abc123" }` | ?箏閮剖? |
| createdAt       | timestamp  | ??  | Firestore Timestamp               | `Timestamp.now()`       | ?萄遣?? |
| updatedAt       | timestamp  | ??  | Firestore Timestamp               | `Timestamp.now()`       | ?湔?? |

---

## 3. Employees嚗撌亥???

| 甈???          | ??        | 敹‵ | ?澆?/?                          | 蝭?                   | 隤芣? |
|-----------------|------------|-----|-----------------------------------|------------------------|-----|
| employeeId      | string     | ??  | UUID                              | `"adf4932f-4d3e-4b8f-b9ff-d9c2467f7be4"` | ?∪極ID |
| tenantId        | string     | ??  | UUID                              | `"c25f1b56-8e88-4d4c-97f4-8c5d5ee91e55"` | 蝘? |
| storeId         | string     | ??  | UUID                              | `"5f3e2f74-89bc-4a4b-a2f2-ef930b03ff3e"` | ?撅祇?撣?|
| name            | string     | ??  | 1-50摮?                           | `"????`                | 憪? |
| phone           | string     | ??  | ?啁???撘?^09\d{8}$            | `"0912345678"`           | ?? |
| position        | string     | ??  | ENUM: 'intern', 'staff', 'leader', 'manager' | `'leader'`             | ?瑚? |
| role            | string     | ??  | ENUM: 'admin', 'staff'             | `'staff'`                | 蝟餌絞?餃閫 |
| lineUid         | string     | ??  | LINE UID?澆?                      | `"U9d33b7edbf18f5e6d904e36521d3a1a2"` | 蝬?LINE |
| createdAt       | timestamp  | ??  | Firestore Timestamp               | `Timestamp.now()`       | ?萄遣?? |
| updatedAt       | timestamp  | ??  | Firestore Timestamp               | `Timestamp.now()`       | ?湔?? |

---

# ?? ?∪極蝡舐??JSON Schema

(??垢?∪極 PWA ??啁?鞈??澆?)

```json
{
  "employeeId": "string (UUID)",
  "name": "string",
  "position": "string (intern | staff | leader | manager)",
  "storeId": "string (UUID)",
  "storeName": "string",
  "todayShift": {
    "start": "string (ISO??)",
    "end": "string (ISO??)",
    "roleToday": "string (憒?cashier/kitchen/shiftLead)"
  },
  "todayTasks": [
    {
      "taskId": "string",
      "title": "string",
      "status": "pending | completed",
      "dueTime": "string (ISO??)"
    }
  ],
  "notices": [
    {
      "noticeId": "string",
      "title": "string",
      "content": "string",
      "createdAt": "timestamp"
    }
  ]
}
```

---

# ?? 蝞∠??∪??圈???JSON Schema

(?蝞∠??∠靘??湧?摨????澆?)

```json
{
  "storeId": "string (UUID)",
  "storeName": "string",
  "summary": {
    "todaySales": "number",
    "todayOrders": "number",
    "employeeOnline": "number",
    "pendingOrders": "number"
  },
  "employees": [
    {
      "employeeId": "string",
      "name": "string",
      "position": "string (intern | staff | leader | manager)",
      "todayClockIn": "timestamp",
      "todayClockOut": "timestamp",
      "status": "working | offDuty | late | absent"
    }
  ],
  "inventory": [
    {
      "itemId": "string",
      "name": "string",
      "stock": "number",
      "lowStockWarning": "boolean"
    }
  ],
  "pendingTasks": [
    {
      "taskId": "string",
      "title": "string",
      "assignedTo": "string (employee name)",
      "dueDate": "timestamp"
    }
  ]
}
```

---






敺末嚗??收銝??脰?  
????API ?游?閮剛?鋆??? 
????雿?蝟餌絞?閬??????嚗?*瘥撟思?鋆?虜摰?????*嚗?
---
# ?? 憭?游? API 閮剛?蝮質汗

| ?游?蝟餌絞 | 銝餉??券?| 隤芣? |
|:---------|:--------|:----|
| LINE Pay API | 蝺??臭? | ?舀暺?蝯董隞狡 |
| Uber Eats API | 憭??桀?甇?| ?交閮??晷??|
| Foodpanda API | 憭??桀?甇?| ?交閮??晷??|
| LINE Login + LIFF SDK | 憿批恥/?∪極?餃 | ?桅??餃???∠恣??|
| LINE Notify API | 憿批恥? | ?箏??暑???|
| Telegram Bot API | ?折? | 蝞∠??⊿嚗郎?晞郎蝷綽? |

---

# 1. ?INE Pay API ?游???
### 銝餉??券?
- 憿批恥蝺?暺?蝯董
- 摨?曉?Ⅳ?嗆狡

### 瘚?閮剛?嚗遣霅堆?

1. 憿批恥?豢?隞狡 ???澆敺垢撱箇?鈭斗?
2. 撠? LINE Pay 蝯董??3. 摰?隞狡 ???矽撽? ??閮摰?

---

### LINE Pay API蝡舫?閮剛?嚗?
**1. 撱箇?隞狡隢?**
- `POST /api/payment/linepay/request`
```json
{
  "amount": 200,
  "currency": "TWD",
  "orderId": "order_20240601_001",
  "packages": [{
    "id": "package1",
    "amount": 200,
    "name": "???憟?",
    "products": [{
      "name": "???",
      "quantity": 1,
      "price": 100
    }, {
      "name": "憌脫?",
      "quantity": 1,
      "price": 100
    }]
  }],
  "redirectUrls": {
    "confirmUrl": "https://domain.com/payment/confirm",
    "cancelUrl": "https://domain.com/payment/cancel"
  }
}
```

**????**
```json
{
  "paymentUrl": "https://payment.line.me/..."
}
```

---

**2. 蝣箄?隞狡**
- `POST /api/payment/linepay/confirm`
```json
{
  "transactionId": "202406010001",
  "orderId": "order_20240601_001",
  "amount": 200,
  "currency": "TWD"
}
```

??敺?啗??桃???
---

# 2. ?ber Eats API ?游???
### 銝餉??券?
- ?芸??郊撟喳閮
- ?交??柴?啁???
---

### 蝡舫?閮剛?嚗?
**1. ?交Uber閮Webhook**
- `POST /api/webhook/ubereats/order`
```json
{
  "orderId": "ubereats_20240601_001",
  "storeId": "?批ㄑ敹?摨?,
  "items": [
    { "name": "???", "quantity": 2 }
  ],
  "totalAmount": 320,
  "customerNote": "撠硃"
}
```

---

**2. ?湔憭??桃???*
- `POST /api/ubereats/update`
```json
{
  "orderId": "ubereats_20240601_001",
  "status": "ready_for_pickup"  // ??'picked_up', 'cancelled'
}
```

---

# 3. ?oodpanda API ?游???
??Uber Eats 憿撮嚗??URL / 甈??亙凝銝???
### 蝡舫?閮剛?嚗?
**1. ?交Foodpanda閮Webhook**
- `POST /api/webhook/foodpanda/order`
```json
{
  "orderId": "fp_20240601_001",
  "storeName": "?批ㄑ敹?摨?,
  "totalPrice": 280,
  "items": [
    { "itemName": "???", "qty": 1 }
  ],
  "remarks": "?駁爸"
}
```

---

**2. ?湔閮???*
- `POST /api/foodpanda/update`
```json
{
  "orderId": "fp_20240601_001",
  "status": "picked_up"  // ??'ready', 'cancelled'
}
```

---

# 4. ?INE Login + LIFF SDK?游???
### ?券?
- 憿批恥?餃?銝剖?
- ?∪極?餃?∪極蝟餌絞

---

**?餃瘚?閮剛?**
1. ?垢??LIFF ???????? `accessToken`
2. ?喟策敺垢??Firebase custom token
3. ?垢??custom token ?餃 Firebase

---

**API蝡舫?閮剛?嚗?*

**1. LINE?irebase?餃**
- `POST /api/auth/line`
```json
{
  "accessToken": "LINE?ccessToken",
  "idToken": "LINE?dToken"
}
```
? Firebase custom token??
---

# 5. ?INE Notify API?游???
### ?券?
- 憿批恥???
- 瘣餃??冽

---

**?潮**
- `POST /api/notify/line`
```json
{
  "userLineToken": "xxxxx",
  "message": "?函???撌脣???隢1?????擗?"
}
```

---

# 6. ?elegram Bot API?游???
### ?券?
- ?折蝞∠??⊿
- 閮?啣虜/鞎?霅血/?平憿?璅

---

**?潮elegram閮**
- `POST /api/notify/telegram`
```json
{
  "chatId": "蝞∠??∠?chat_id",
  "message": "隞?批ㄑ敹?摨?璆剝?撌脤???"
}
```

---

# ?函蜇蝯?
?見摮????冽??API嚗?- ? 蝡舫? (Route) ?質身閮末鈭?- ? 隢????撘??
- ? ?臭誑?湔摰?敺垢撌亦?撣恍?憪祕雿?- ? 銋???垢?剝?銝脫皜祈岫

---


敺末嚗???仿脣  
**?????曆???POS 蝟餌絞 ???折敺垢 API 鋆?閮??*  
?格??臬??綽?

- 瘥??賢??? **API蝡舫?**
- **隢??澆?嚗equest JSON嚗?*
- **???澆?嚗esponse JSON嚗?*
- **?航炊??蝭?**

???冽?皜????潸?湔?函??澆??渡?嚗??????嚗?
---

# ? ?∪極蝞∠?嚗丰隡渡頂蝯梧?

## 1. ?∪極?餃嚗irebase Custom Token嚗?
- `POST /api/auth/employee-login`
```json
{
  "lineAccessToken": "string"
}
```

**????**
```json
{
  "firebaseCustomToken": "string"
}
```

---

## 2. ?嚗???銝嚗?
- `POST /api/attendance/clock`
```json
{
  "employeeId": "emp_12345",
  "storeId": "敹?",
  "type": "clock_in", // or "clock_out"
  "location": {
    "lat": 24.9748,
    "lng": 121.2556
  }
}
```

**????**
```json
{
  "status": "success",
  "message": "???"
}
```

---

## 3. ?亥岷?犖?芾?????蝝?
- `GET /api/payroll/employee/{employeeId}`
```json
// URL 頝臬?撣?employeeId
```

**????**
```json
{
  "employeeId": "emp_12345",
  "month": "2024-06",
  "baseSalary": 40000,
  "bonus": 3000,
  "totalPay": 43000,
  "details": [
    { "item": "?箇?摨", "amount": 40000 },
    { "item": "?瑕??", "amount": 3000 }
  ]
}
```

---

# ?? 蝺?閮? / POS 瘚?

## 4. 撱箇??啗??殷?憿批恥蝡舀??∪極蝡荔?

- `POST /api/order/create`
```json
{
  "customerId": "cus_98765", // 憿批恥ID嚗??null嚗?游恥嚗?  "storeId": "敹?",
  "orderSource": "pos" , // or "online"
  "items": [
    {
      "menuId": "menu_001",
      "name": "???",
      "quantity": 2,
      "price": 80
    }
  ],
  "note": "撠厭",
  "paymentMethod": "cash", // or "linepay"
  "totalAmount": 160
}
```

**????**
```json
{
  "orderId": "order_20240601_001",
  "status": "pending"
}
```

---

## 5. ?湔閮???鋆賭?銝准???瘨?

- `POST /api/order/update-status`
```json
{
  "orderId": "order_20240601_001",
  "status": "completed" // or "preparing", "cancelled"
}
```

**????**
```json
{
  "status": "success",
  "message": "閮???唳???
}
```

---

# ? ???怨? / ???

## 6. ?怨?蝟餌絞嚗?蝡臬???嚗?
- `POST /api/pickup/call`
```json
{
  "orderId": "order_20240601_001",
  "queueNumber": "A015",
  "notifyLine": true
}
```

**????**
```json
{
  "status": "success",
  "message": "?怨??撌脩??
}
```

---

# ? 摨?恣?撠敺?

## 7. 蝞∠?蝡舀閰Ｙ?璆剝?嚗??伐?

- `GET /api/admin/sales/{storeId}/{date}`
```json
// URL path 撣?storeId ??date (?澆?: YYYY-MM-DD)
```

**????**
```json
{
  "storeId": "敹?",
  "date": "2024-06-01",
  "totalSales": 28000,
  "totalOrders": 200
}
```

---

## 8. ????餉?嚗??殷?

- `POST /api/admin/sales/manual-entry`
```json
{
  "storeId": "敹?",
  "date": "2024-06-01",
  "amount": 500,
  "reason": "?暸?撠?鋆"
}
```

**????**
```json
{
  "status": "success",
  "message": "?鋆??"
}
```

---

# ? ?航炊???澆?嚗蝡絞銝嚗?
??PI憭望???蝯曹???澆?嚗?
```json
{
  "status": "error",
  "errorCode": "E401",
  "message": "?芣?甈?摮?"
}
```
撣貉??航炊蝣潛內靘?
| ?航炊隞?Ⅳ | 隤芣? |
|:---------|:-----|
| `E400` | 隢???航炊 |
| `E401` | ?芣?甈???(?芰??甈?銝雲) |
| `E404` | ?曆??啗?皞?|
| `E500` | 蝟餌絞?折?航炊 |

---


敺末嚗?  
??券收銝脣 **???”閮剛?嚗?敺垢? JSON 蝯?璅???*  
?見????芾??踹?遢撠梯?湔?極嚗??刻撌梁???
---
# ? 1. Firestore 鞈?銵刻身閮?
---

## ?? `employees` 嚗撌亥??”嚗?
| 甈? | 憿? | 隤芣? |
|:-----|:-----|:-----|
| `employeeId` | string | ?芸????銝ID嚗撘?emp_xxxx嚗?|
| `name` | string | ?∪極憪? |
| `phone` | string | ?∪極???Ⅳ |
| `email` | string | ?∪極?餃??萎辣嚗?賂? |
| `storeId` | string | ?撅砍?摨D |
| `position` | string | ?瑚?隞??嚗? manager, leader, staff嚗?|
| `roleLevel` | number | 甈?蝑?嚗摮?憭扳???擃? |
| `status` | string | ???active / suspended / left嚗?|
| `lineUserId` | string | 蝬??INE User ID |
| `createdAt` | timestamp | 撱箇??? |
| `updatedAt` | timestamp | ?敺?唳???|

---

## ?? `orders` 嚗??株??”嚗?
| 甈? | 憿? | 隤芣? |
|:-----|:-----|:-----|
| `orderId` | string | ?芸????臭?ID嚗撘?order_yyyyMMdd_xxx嚗?|
| `storeId` | string | ?撅砍?摨D |
| `customerId` | string | 憿批恥ID嚗??槃ull嚗?|
| `orderSource` | string | 閮靘?嚗os / online / uber / foodpanda嚗?|
| `items` | array | 閮頃??皜嚗?銝嚗?|
| `note` | string | 憿批恥?酉 |
| `totalAmount` | number | 蝮賡?憿?|
| `paymentMethod` | string | 隞狡?孵?嚗ash / linepay / credit嚗?|
| `status` | string | 閮???pending / preparing / completed / cancelled嚗?|
| `queueNumber` | string | ???Ⅳ嚗蝛箇嚗?|
| `createdAt` | timestamp | 撱箇??? |
| `updatedAt` | timestamp | ?敺?唳???|

> `items` ?折?澆?嚗?```json
[
  {
    "menuId": "menu_001",
    "name": "???",
    "quantity": 2,
    "price": 80
  }
]
```

---

## ?? `sales` 嚗?瑕蝝?”嚗?
| 甈? | 憿? | 隤芣? |
|:-----|:-----|:-----|
| `salesId` | string | ?芸????臭?ID嚗ales_yyyyMMdd_storeId嚗?|
| `storeId` | string | ??ID |
| `date` | string | ?交?嚗撘?YYYY-MM-DD嚗?|
| `totalSales` | number | 蝮賡?桅?憿?|
| `totalOrders` | number | 蝮質??格??|
| `manualAdjustment` | number | ??鋆??嚗??嚗?|
| `createdAt` | timestamp | 撱箇??? |
| `updatedAt` | timestamp | ?敺?唳???|

---

# ?? 2. ?∪極蝡舫??ｇ?憭乩撈APP / PWA嚗?- JSON 蝯?

---

## ? ?∪極?餃敺???
```json
{
  "employeeInfo": {
    "employeeId": "emp_12345",
    "name": "????,
    "position": "leader",
    "storeName": "敹?摨?
  },
  "todayStatus": {
    "isClockedIn": true,
    "lastClockTime": "2024-06-01T08:00:00Z"
  },
  "quickActions": [
    { "action": "clock", "label": "?" },
    { "action": "order", "label": "暺?" },
    { "action": "pickup", "label": "?怨?" }
  ]
}
```

---

## ? ??恍

```json
{
  "locationRequired": true,
  "currentLocation": {
    "lat": 24.9748,
    "lng": 121.2556
  },
  "clockOptions": [
    { "type": "clock_in", "label": "銝?" },
    { "type": "clock_out", "label": "銝?" }
  ]
}
```

---

## ? ?啣?閮?恍嚗OS嚗?
```json
{
  "menuList": [
    { "menuId": "menu_001", "name": "???", "price": 80 },
    { "menuId": "menu_002", "name": "??颲?, "price": 50 }
  ],
  "orderCart": [],
  "customerInfo": {
    "customerId": null,
    "note": ""
  },
  "paymentOptions": ["cash", "linepay"]
}
```

---

# ? 3. 蝞∠??∪??圈???- JSON 蝯?

---

## ? 摨?平璁汗

```json
{
  "storeInfo": {
    "storeId": "敹?",
    "name": "敹?摨?
  },
  "salesSummary": {
    "todaySales": 28000,
    "todayOrders": 200,
    "manualAdjustment": 500
  },
  "attendanceSummary": {
    "expectedEmployees": 5,
    "checkedInEmployees": 4
  }
}
```

---

## ? ?∪極蝞∠??”

```json
{
  "employees": [
    {
      "employeeId": "emp_12345",
      "name": "????,
      "position": "leader",
      "roleLevel": 2,
      "status": "active"
    },
    {
      "employeeId": "emp_67890",
      "name": "??蝢?,
      "position": "staff",
      "roleLevel": 1,
      "status": "active"
    }
  ]
}
```

---

## ? ?格閮?”

```json
{
  "orders": [
    {
      "orderId": "order_20240601_001",
      "queueNumber": "A015",
      "items": [
        { "name": "???", "quantity": 2 }
      ],
      "totalAmount": 160,
      "status": "completed",
      "paymentMethod": "cash",
      "createdAt": "2024-06-01T08:10:00Z"
    }
  ]
}
```





憟踝??靘?嚗??Ｘ? **頞??渲?朣?*嚗?- 瘥蜓閬?API / ?暺?**?航炊蝭??隤斤Ⅳ閮剛?**
- 瘥撐鞈?銵函?**甈?撽?閬?**
- Firestore 鞈?蝯???*蝝Ｗ?閮剛?嚗ndexes.json嚗?*

---

# ? 1. API?航炊蝭?嚗絞銝?航炊閮剛?嚗?
---

## ? ??航炊?澆?

```json
{
  "error": {
    "code": "ERR_CODE",
    "message": "?航炊隤芣???"
  }
}
```

---

## ? 撣貉??航炊蝣?
| ?航炊蝣?| 隤芣? | HTTP Status |
|:------|:-----|:------------|
| `INVALID_ARGUMENT` | 隢??銝迤蝣?| 400 |
| `UNAUTHORIZED` | 瘝?甈?摮? | 401 |
| `NOT_FOUND` | 鞈?銝???| 404 |
| `ALREADY_EXISTS` | 鞈?撌脣??剁?憒?銴撌付D嚗?| 409 |
| `INTERNAL_ERROR` | 隡箸??典?券隤?| 500 |

---

## ? API ?航炊蝭?

#### ?∪極?餃憭望?嚗銝蝬?LINE撣唾?嚗?```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "?曆??啁?摰??∪極撣唾?"
  }
}

---

### ?? ?∪極蝡?JSON 鞈?蝭?
```json
{
  "employee_id": "emp001",
  "name": "暺???,
  "store_id": "樴?",
  "role": "甇???∪極",
  "shift_today": {
    "date": "2025-04-29",
    "shift_start": "15:00",
    "shift_end": "22:00"
  },
  "sales_today": 5280,
  "bonus_type": "撟單??",
  "bonus_preview": 160
}
```

---

### ?????蝞∠??∠垢 JSON 鞈?蝭?
```json
{
  "manager_id": "mgr001",
  "store_id": "敹?",
  "daily_report_summary": {
    "date": "2025-04-29",
    "total_sales": 12200,
    "reported_by": "emp123",
    "bonus_estimations": {
      "撟單??": 360,
      "???": 720,
      "?僑??": 2400,
      "?嗡???": 100
    }
  },
  "shifts_pending": 2,
  "leave_requests_pending": 1
}
```

---

?乩?靘?西?鋆?`employees`?leave_requests`?bonus_tasks` 蝑隞??”???潸?甈?撽?嚗?



?靘?桀?蝟餌絞?瘙?鋆???雿?霅????航炊蝭?銵冽嚗項??`employees`?leave_requests`?bonus_tasks` 蝑敹”?潘?銝阡?撠???雿??粹???霅???血?憛怠??航?隤斗?靘?
?乩?靘??臭誑?箔?鋆?嚗?1. Firestore 蝝Ｗ?閮剛?嚗firestore.indexes.json`嚗?2. ?∪極蝡航?蝞∠??∠垢 JSON 蝷箸?鞈?嚗見?祈???
3. ?交??閬?銋隞亥身閮?Firestore 閬?嚗firestore.rules`嚗?獢?
?閬?蝜潛?鋆銝??

?irestore 鞈?銵冽?雿?霅????航炊蝭?皜??
1. stores嚗?摨???
- name嚗tring, required嚗? 摨?嚗?敺蝛綽?靘?嚗? "嚗隤歹?蝛箇嚗?- latitude嚗umber, required嚗? 蝺臬漲嚗隤歹?"abc"嚗??詨?嚗?- longitude嚗umber, required嚗? 蝬漲嚗隤歹?"xyz"嚗??詨?嚗?- radius嚗umber, default=100嚗? ?蝭?嚗撠綽?
- operatingHours嚗rray of time ranges嚗? ?航炊嚗靘撘?[{start,end}]

2. users嚗丰隡游董?塚?
- name嚗tring, required嚗? ?航炊嚗ull, ""
- role嚗num: ["撖衣?", "甇?", "蝯", ...], required嚗? ?航炊嚗?super"
- storeId嚗tring, required嚗? ?芣?摰?摨?敶梢??鞈???- status嚗num: ["active", "suspended"], default="active"嚗?
3. shifts嚗??剛”嚗?- userId嚗tring, required嚗? ?航炊嚗ull嚗銝撠?雿輻??- date嚗tring, yyyy-mm-dd, required嚗? ?航炊嚗?4/1/2025"
- timeSlot嚗num: ["?拍", "?", "?冽"], required嚗?- status嚗num: ["甇?虜", "隢?", "隞?"], default="甇?虜"嚗?
4. clockRecords嚗??∟???
- timestamp嚗imestamp, required嚗?- type嚗num: ["銝", "銝"], required嚗? ?航炊嚗??極"
- storeId嚗tring, required嚗?- userId嚗tring, required嚗?
5. payrolls嚗鞈???
- userId嚗tring, required嚗?- month嚗tring, yyyy-mm, required嚗?- baseSalary嚗umber嚗?- bonusTotal嚗umber嚗?- deduction嚗umber嚗? ?航炊嚗?999嚗???>= 0嚗?- finalSalary嚗umber, ?芸?閮?嚗?
6. bonusConfigs嚗????身摰?
- type嚗num, required嚗? ?航炊嚗??孵??123"
- calculation嚗bject嚗? ?航炊嚗摰儔?曉?瘥?璇辣撘?- active嚗oolean, default=true嚗?
7. salesReports嚗?梯”嚗?- storeId嚗tring, required嚗?- date嚗tring, yyyy-mm-dd, required嚗?- totalSales嚗umber, required嚗?- paymentBreakdown嚗bject, required嚗? ?航炊嚗撩撠??LINE Pay甈?

8. inventoryItems嚗澈摮??殷?
- name嚗tring, required嚗? ?航炊嚗征??- stock嚗umber, default=0嚗? ?航炊嚗???- unit嚗tring, e.g., "??, "獢?嚗?
9. leaveRequests嚗??隢?
- userId嚗tring, required嚗?- date嚗tring, required嚗?- reason嚗tring, required嚗?- status嚗num: ["敺祟", "??", "擏?"], default="敺祟"嚗?
10. feedbacks嚗“摰Ｚ??對?
- storeId嚗tring, required嚗?- orderId嚗tring嚗?- rating嚗nteger: 1??, required嚗? ?航炊嚗?
- comment嚗tring, optional嚗?
11. announcements嚗??
- title嚗tring, required嚗? ?航炊嚗征??- content嚗tring, required嚗?- publishAt嚗imestamp, optional嚗?





銝餉??嚗?雓圾?園?頛荔?

**?垢?∪極蝡臬???*

1.  **頨思遢撽? (Authentication)**
    *   **?桃?**: 撽??∪極頨思遢嚗?閮勗摮?蝟餌絞??    *   **?垢 (`login.html` (?身), `js/auth.js`, `js/init.js`)**:
        *   ???餃隞嚗?賡?閬董??撖Ⅳ??Firebase Auth ???隞撘? Google ?餃嚗?        *   `auth.js` ???冽頛詨嚗矽??Firebase Authentication ?脰?撽???        *   撽???敺??脣??冽???(?航??`localStorage` ??`sessionStorage`)嚗蒂閫貊 `init.js` ??`main.js` ??銝餅??其??Ｗ??冽?孵??豢???        *   ???餃?摩嚗??斤?嗥??蒂?????餃???    *   **敺垢 (Firebase Authentication, `firestore.rules`)**:
        *   Firebase Authentication ????撖阡??澈隞賡?霅?        *   `firestore.rules` ?航???`request.auth.uid` (撌脩?亦?嗥? ID) 靘??嗅??孵??豢?????
2.  **? (Clock-in/out)**
    *   **?桃?**: 閮??∪極撖阡???銝????    *   **?垢 (`clockin.html`, `js/clockin-logic.js`)**:
        *   憿舐內???嚗???銝嚗?賡＊蝷箇????隞?閮???        *   `clockin-logic.js` ????暺?鈭辣嚗???????        *   ?航??啁?雿蔭撽?嚗???閬???        *   撠??∟????∪極 ID, ??, 憿?嚗???銝嚗? ?航??蝵桐縑?荔??潮敺垢??    *   **敺垢 (`functions/index.js` (?航), Firestore)**:
        *   ?交?垢?潔????⊥??        *   撽??豢????扼?        *   撠??∟??摮 Firestore ?摰??葉嚗?憒?`attendanceRecords`嚗??虜???怠撌?ID ??誑靘踵閰Ｕ?
3.  **隢? (Leave Request)**
    *   **?桃?**: 霈撌交?鈭方??隢?    *   **?垢 (`leave.html`, `js/leave-logic.js`)**:
        *   ??銵典霈撌仿?????絲閮??撓?乩??晞?        *   `leave-logic.js` 撽?銵典頛詨嚗?蝞????詻?        *   憿舐內?∪極????憿??航敺?蝡舐????        *   撠??隢???∪極 ID, 憿?, ??, 鈭, ??? '敺祟??嚗?敺垢??        *   ?航銋??恍＊蝷箸風?脣??桀??嗥??????    *   **敺垢 (`functions/index.js` (?航), Firestore)**:
        *   ?交隢??唾??豢???        *   撽??豢?嚗?憒???西?蝒?憿?西雲憭???        *   撠隢摮 Firestore ??`leaveRequests` ??銝哨???身??'敺祟????        *   ?航閫貊?蝯衣??撖拇鈭箏??
4.  **?剛” (Schedule View)**
    *   **?桃?**: 霈撌交?撌梁?撌乩??剛”??    *   **?垢 (`schedule-view.html`, `js/schedule-view-logic.js`)**:
        *   ??蝡航?瘙?摰????靘??祇晞???犖?剛”??        *   `schedule-view-logic.js` ?交?剛”?豢?嚗蒂隞交???”敶Ｗ????        *   ?航????交?蝭????賬?    *   **敺垢 (`functions/index.js` (?航), Firestore)**:
        *   ?交?垢?銵刻?瘙???∪極 ID ???????        *   敺?Firestore ??`schedules` ??銝剜閰Ｙ泵??隞嗥??剛”閮???        *   撠閰Ｙ????策?垢??
5.  **?芾? (Salary View)**
    *   **?桃?**: 霈撌交?撌梁??芾??敦??    *   **?垢 (`salary.html`, `salary-view.html`, `js/salary-view-logic.js`)**:
        *   ??蝡航?瘙摰?隞賣??望??鞈??        *   `salary-view-logic.js` ?交?芾??豢?嚗?賢??怠??芥揖鞎潦??甈整祕?潮?憿?嚗?銝虫誑皜?撘?蝷箝?        *   ?航??豢?甇瑕?芾??桃????    *   **敺垢 (`functions/index.js` (?航), Firestore)**:
        *   ?交?垢?鞈?瘙???∪極 ID ?望?嚗?        *   敺?Firestore ??`payrolls` ??`salaryRecords` ??銝剜閰Ｗ????芾?閮???        *   ?箸甈?嚗?賜??芸楛??餈??芾??豢???
6.  **暺? (Ordering)**
  *   **?桃?**: 霈撌亙隞亦?銝?擗??航?臬撌仿???鞈?誨閮???  *   **?垢 (`order.html`, `js/order-logic.js`)**:
      *   憿舐內?舫??貊??嚗?賢?敺垢?脣?嚗?      *   ?迂?∪極?豢?擗?????鞈潛頠?      *   `order-logic.js` 閮?蝮賡?憿???銝?摩??      *   撠??格???∪極 ID, 擗??, ?賊?, ??, ????/?圈?閬?嚗?敺垢??      *   ?航??亦?甇瑕閮???賬?  *   **敺垢 (`functions/index.js` (?航), Firestore)**:
      *   ?交閮?豢???      *   撽?????潦?      *   撠??桀摮 Firestore ??`orders` ??銝准?      *   ?航閫貊?蝯血??踵?鞎痊??閮?犖?～?      *   ?航?隞??∪極撣單??狡?賊??胯?
7.  **?砍? (Announcements View)**
  *   **?桃?**: 霈撌交??貊撣???啣??  *   **?垢 (`announce.html`, `js/announce-logic.js`)**:
      *   ??蝡航?瘙??啁??????砍??”??      *   `announce-logic.js` ?交?砍??豢?嚗?憿? ?批捆, ?澆??交?, ?澆???嚗蒂隞亙?銵冽??∠?敶Ｗ?撅內??      *   ?航??亦??砍?閰單????賬?  *   **敺垢 (`functions/index.js` (?航), Firestore)**:
      *   ?交?砍?隢???      *   敺?Firestore ??`announcements` ??銝剜閰Ｗ???      *   撠????策?垢??
8.  **?祆? (Referendum Participation)**
  *   **?桃?**: 霈撌亙???詨?函??巨瘣餃???  *   **?垢 (`referendum.html`, `js/referendum-logic.js`)**:
      *   ??蝡航?瘙?迤?券脰???降憿??賊???      *   `referendum-logic.js` 撅內霅圈??批捆????迂?∪極?豢?銝行?鈭斗?蟡具?      *   ?漱??賡?閬Ⅱ隤?鈭文?隞?航霈憿舐內?歇?巨??蝯?嚗???閮梧???      *   撠?蟡函????∪極 ID, ?祆? ID, ??賊???潮敺垢??  *   **敺垢 (`functions/index.js` (?航), Firestore)**:
      *   ?交?巨?豢???      *   撽??∪極?臬??蟡刻??潦?血歇??蟡具?      *   撠?蟡刻??摮 Firestore ??`referendumVotes` ??銝哨?銝行??`referendums` ??銝剖??降憿?蟡冽蝯梯???
9.  **閰摯 (Evaluation Participation/View)**
  *   **?桃?**: 霈撌亙??蜀??隡堆??芾???閰???撌梁?閰摯蝯???  *   **?垢 (`evaluation.html`, `js/evaluation-system.js`)**:
      *   ?寞?敺垢?誘嚗＊蝷粹?閬‵撖怎?閰摯銵典嚗?賣?芾???????隡堆???      *   ?迂?∪極憛怠神閰???隤?      *   ?漱閰摯?豢??啣?蝡胯?      *   ????蝡航?瘙?歇摰??犖閰摯蝯?嚗蒂撅內??  *   **敺垢 (`functions/index.js`, `functions/evaluation-system.js`, Firestore)**:
      *   ??閰摯銵典蝯???      *   ?交?∪極?漱??隡唳???脣???Firestore ??`evaluations` ?賊???銝准?      *   閮?閰摯??蝮賜???   *   **?桃?**: 霈撌亙??蜀??隡堆??芾???閰???撌梁?閰摯蝯???   *   **?垢 (`evaluation.html`, `js/evaluation-system.js`)**:
       *   ?寞?敺垢?誘嚗＊蝷粹?閬‵撖怎?閰摯銵典嚗?賣?芾???????隡堆???       *   ?迂?∪極憛怠神閰???隤?       *   ?漱閰摯?豢??啣?蝡胯?       *   ????蝡航?瘙?歇摰??犖閰摯蝯?嚗蒂撅內??   *   **敺垢 (`functions/index.js`, `functions/evaluation-system.js`, Firestore)**:
       *   ??閰摯銵典蝯???       *   ?交?∪極?漱??隡唳???脣???Firestore ??`evaluations` ?賊???銝准?       *   閮?閰摯??蝮賜???       *   ?寞?甈?餈??犖閰摯蝯?蝯血?蝡胯?
10. **?巨銝剖? (Voting Center)**
   *   **?桃?**: ?航?臭?????蟡其??ｇ?銝??澆??   *   **?垢 (`voting-center.html`, `js/voting-center.js`)**:
       *   ?摩憿撮?祆?嚗??航?拍?潭憭????巨嚗?憒暑???閬矽?伐???       *   ??蝡航?瘙????蟡典?銵剁?撅內霅圈?????漱?巨??   *   **敺垢 (`functions/index.js` (?航), Firestore)**:
       *   ???車憿??巨?撱箝??嗅?蝯?蝯梯?嚗??脣 Firestore ??`votes` ??隡潮??葉??
11. **鋆???(Training Info View)**
   *   **?桃?**: ?亦??砍?折?寡?隤脩???閮??勗???   *   **?垢 (`cram-school-view.html`, `js/cram-school-view-logic.js`)**:
       *   ??蝡航?瘙?函?隤脩??”嚗?蝔晞???撣怒摰對???       *   撅內隤脩?鞈???       *   ?航??勗??嚗??勗?隢?嚗撌?ID, 隤脩? ID嚗?敺垢??   *   **敺垢 (`functions/index.js` (?航), `functions/admin-cram-school.js` (?典??摩?航?梁), Firestore)**:
       *   ??隤脩??”?豢???       *   ?交?勗?隢?嚗?霅??潘?靘?鈭箸?嚗??湔 Firestore 銝?`courses` ??`trainingEnrollments` ????
---

**蝞∠??∪?蝡臬???*

?望蝞∠??∪??賢?璅??隞乩?????敹??賜??摩嚗?
12. **?∪極蝞∠? (Employee Management)**
   *   **?桃?**: 蝞∠??砍??撌亦??箸鞈???   *   **?垢 (`admin.html`, `js/admin-employees.js`, `js/admin-employee.js`)**:
       *   ??隞撅內?∪極?”嚗????雿?嚗?       *   ?????祟?詨??賬?       *   ???啣??楊頛胯炎閬撌亥底蝝啗???銵典??       *   閫貊?芷?∪極??雿??航璅??箏??刻??拍??芷嚗?       *   撠?CUD (Create, Update, Delete) ??隢??潮敺垢??   *   **敺垢 (`functions/index.js` (?航), Firestore)**:
       *   ?交蝞∠??∠? CUD 隢???       *   撽?蝞∠??⊥???       *   ??Firestore ??`employees` ??銝剖銵??鞈?????
13. **甈?閫蝞∠? (Role/Permission Management)**
   *   **?桃?**: 摰儔銝??蝙?刻??脣??嗅隞亙銵???甈???   *   **?垢 (`admin.html`, `js/admin-roles.js`, `js/admin-permissions.js`, `js/admin-users.js`)**:
       *   ??隞蝞∠?閫嚗憓楊頛胯?方??莎???       *   ??隞摰儔瘥??脫???甈?嚗?憒??芯???航??鈭??????       *   ??隞撠??脣??策?琿??蝙?刻??∪極撣唾?嚗?       *   撠??渲?瘙?敺垢??   *   **敺垢  (?航), Firestore)**:
       *   ?交甈?霈隢???       *   撠??脯???蝢拙摮 Firestore ??`roles`, `permissions` ??銝准?       *   撠?嗉?閫???臬摮 `users` ??`employees` ???摰?雿葉??       *   ??閮剖??◤敺垢 API ??`firestore.rules` ?其????炎?乓?
14. **撖拇瘚? (Approval Workflows)**
   *   **?桃?**: ???閬恣?撖拇?隢?憒???瑞?嚗?   *   **?垢 
       *   憿舐內敺祟?貊??唾??”嚗?憒?敺祟?貊??嚗?       *   ???亦??唾?閰單????賬?       *   ???????蝯????航?閬‵撖怎??晞?       *   撠祟?寧????唾? ID, 蝯?, ?, 撖拇鈭?ID嚗?敺垢??   *   **敺垢  (?航), Firestore)**:
       *   ?交撖拇蝯???       *   ?湔 Firestore 銝剖??隢???憒?`leaveRequests`嚗????       *   憒??孵?嚗?質孛?澆?蝥?雿?靘??湔??擗?嚗?       *   ?航閫貊?蝯行?鈭斤隢??∪極??
15. **?蝞∠? (Scheduling Management)**
   *   **?桃?**: ?萄遣?楊頛臬??澆??∪極?剛”??   *   **?垢
       *   ???交??”?潔??Ｚ?蝞∠??⊥???∪極?
       *   ??閮剖??閬?嚗?頛芰璅∪??極???塚?????(`)??       *   ??閫貊?芸?????踝??箸?身閬????剛”?阮??       *   ?迂蝞∠??⊿?閬賬耨?孵??澆??剛”??       *   撠?蝯銵冽??敺垢?脣???   *   **敺垢  (?航), Firestore)**:
       *   ?交????豢?????剛?瘙?       *   ?瑁??芸??蝞?嚗????店嚗?       *   撠銵冽?摮 Firestore ??`schedules` ??銝准?       *   ?澆??剛”???航閫貊?蝯衣?撌乓?
16. **閮蝞∠? (Order Management)**
   *   **?桃?**: ?亦??恣???撌交?鈭斤?閮??   *   **?垢
       *   憿舐內閮?”嚗??怠撌亙????桀摰嫘?憿???嚗?       *   ?????祟?貉??桃????       *   ?迂蝞∠??⊥???株底?耨?寡??桃???靘? '??銝?, '撌脣???, '撌脣?瘨?嚗?       *   撠????渲?瘙?敺垢??   *   **敺垢 , Firestore)**:
       *   ?交閮????渲?瘙?       *   ?湔 Firestore 銝?`orders` ??撠?閮?????       *   ?航閫貊?賊??嚗?憒撱?撌伐???
---

?項??銝餉????頛臬?閫?隞恣??憒澈摮?柴?隡啜???閮?擖??貉身摰???頛荔?銋敺芷?隡潛?璅∪?嚗?蝡舀?靘?UI ?脰????蔭嚗?蝡?Cloud Functions ?交隢??銵平??頛臭蒂?湔 Firestore 銝剔??豢???




憟賜?嚗銝???萄極雿??質?璁艙頧??箏?瑁?????撠?撠?????頛臭?皜?嚗???渲底蝝啁?**?摩?嗆?**??*?賭誨蝣?(Pseudocode)** ?膩??
隢釣??????*撱箄降??頛舀???*嚗祕?銵??航?閬?蝝啁??平??瘙脰?隤踵??
---

**1. ?刻閮餃? - 瞈瘣餅?隞嗉蕭頩日?頛?(4.2)**

* **閫貊??嚗?* ?啁??嗅??酉??蝔?嚗???衣Ⅳ雿輻??嚗??嗥??嗡??嗅??????格?瑼Ｘ??* **瘨?鞈?嚗?* `ReferralUsages` (閮?隤啁鈭狐?Ⅳ嚗???, `Tenants` (蝘鞈?), `Products` (??), `Orders` (閮), `ReferralRules` (頞?蝞∠??∟身摰?閬?)
* **?摩?嗆? (Cloud Function - `onTenantActivity`)嚗?*
    1.  `FUNCTION onTenantActivity(tenantId, activityType, data)`:
    2.  `Workspace ReferralUsage WHERE inviteeTenantId = tenantId AND status = 'pending'`
    3.  IF `ReferralUsage` not found OR status != 'pending', `RETURN` (?⊥??歇瞈瘣?
    4.  `Workspace ReferralRule WHERE ruleId = ReferralUsage.ruleId` (?脣??嗅?瞈瘣餉???
    5.  `SWITCH activityType`:
        * `CASE 'signup'`:
            * IF `ReferralRule.activationCondition == 'signup_complete'`, `ACTIVATE_REFERRAL(ReferralUsage)`
        * `CASE 'product_uploaded'`:
            * IF `ReferralRule.activationCondition == 'N_products'`:
                * `COUNT products WHERE tenantId = tenantId`
                * IF `count >= ReferralRule.threshold`, `ACTIVATE_REFERRAL(ReferralUsage)`
        * `CASE 'order_completed'`:
            * IF `ReferralRule.activationCondition == 'M_customer_orders'`:
                * `Workspace distinct customerId FROM Orders WHERE tenantId = tenantId AND status = 'completed'` (?閬??閰ｇ??航?憿?閮??
                * `distinctCustomerCount = result.length`
                * IF `distinctCustomerCount >= ReferralRule.threshold`, `ACTIVATE_REFERRAL(ReferralUsage)`
    6.  `FUNCTION ACTIVATE_REFERRAL(usageRecord)`:
        * `UPDATE usageRecord SET status = 'activated', activatedAt = NOW()`
        * `TRIGGER RewardDistribution(usageRecord.inviterTenantId, usageRecord.ruleId)` // 閫貊??潭?摩 (?虫???Function)





**閬?摰??嗆??摩**

??閬??啗身閮蒂銝???頛荔?霈?蝟餌絞?嗆??游????臭??詨摰嫘????閬蝝啁溶??靘?嚗極鞈???蝟餌絞?府?蝔???像???瘞渲??摨怠?蝞∠??瘨菔?摰?漱?????芸???嚗???典???渡敦????嗉????豢???蝑????瑽??潮“???撅??暹?蝟餌絞?摰寞扼?

**閬??嗆??摩憓撥**

??閬??“銝銝??獢??txt?葉??瑽?銝行?撠撩憭梁??典?嚗????潛???.txt?葉???暺?撠?撠??瑽??殷?閮剛??箸?券銝??暹??批捆?澆捆??頛臬?撘瑯??祈身閮?頛胯芋蝯?芋??瘚?蝑???撠?獢????隞亦Ⅱ摰????摰對?銝衣Ⅱ靽????桐????澆捆?扼?
**閮剛??摩憓撥**

??閬??抒?????獢??閮剛?瘥瑽????摩憓撥嚗蒂鋆?蝻箏??敦蝭?????????芋??蝔??蝯辣???刻??PI蝑??芾????頂蝯梢?閬?銴?????蝞??????芣偌?臬??澈摮恣???閬?隞嗉蕭頩文??芸?????????憒???頂蝯梧?靘?Firestore?loud Functions嚗摰嫘?

撌脫?38 蝘?


隞乩????臬??菜瑽?鋆??啜????曆??押??Serverless ?烘ulti?enant?特aaS?臬蝷???銝蝭?賣???**?詨??摩 ??銝餉?鞈?璅∪?嚗PI?胼??臬??剁??閬? ????摰寧??詨捆?扳???*嚗靘輻?亦??交?銵??潭撠暹挾??蝥祕雿烈R??
---

## 1???航鞈???蝟餌絞??航???蝞?蝔??????

### a. ?詨??摩

* **Rule?ased?浮onus?浩ngine**嚗誑 `bonusConfigs` ?脣???隞嗯??砍???Sales %, KPI ???甈⊥抒???嚗loud?涌unction?畔evaluateBonusTasksScheduled` 瘥/瘥望?????隞塚??Ｙ? `bonusEvents`??* **Payroll?烈ipeline**嚗?摨?`calculatePayroll()` 霈??`attendance`, `leaveRequests`, `salesReports`, `bonusEvents`嚗?銝?畾?**(摨????蝔???狡)** ?惜蝝臬?銝血神??`salaryRecords/{yyyyMM}/{employeeId}`??* **?敺???像**嚗 `taxTables` 閮剖僑摨衣?頝?Function 閮???蝔?敺?? 蝔? ????憿???甈? `withholdingTax`??* **??擗????**嚗leaveRequests` ?冽???單皜?`vacationBalance`嚗calculatePayroll` 靘??亥??芣?蝯西??
### b. 銝餉?鞈?璅∪?

`salaryRecords`?bonusConfigs`?bonusEvents`?taxTables`?vacationBalances` (瘥撌乩?蝑???閬??揣撘?`salaryRecords`??`tenantId`,`period`)嚗bonusEvents`??`employeeId`,`status`).

### c. 摰嚗???
* 撖虫? **Firestore?狼ransaction** 撠?bonusEvent ??salaryRecords 撖怠???寞活嚗??蝞?* ???? `tenantId`嚗ules ??閮望鈭箸????瑁???* ?寞活閮?隞?**Chunk = 500?臬撌?*嚗蒂銵孛?澆??瑁???嚗????minimum?nstances??????
### d. ??摰寧摰?
瘝輻?勗?銝剔? `payrolls / bonusConfigs` 蝯?嚗?啣?蝔”???亙??批?荔??垢 `salary-view.html` ?⊿??孵?憿舐內?摩??
---

\##?????臬澈摮恣?頂蝯授臬??港漱?蕭頩歹??日?撌桃

### a. ?詨??摩

* **Event?特ourcing**嚗?銝甈∪澈摮??神 `inventoryItems/{itemId}/transactions/{txId}`嚗ype (IN / OUT / ADJUST / COUNT)嚗蒂?湔 `stock` ??甈???* **?日?撌桃??**嚗???Scheduler ?? `stockCountJobs`嚗撌亙‵?詨? Function 瘥? `countQty` ??`stock` ???Ｙ? `adjustment` 鈭斗?銝行 Slack/LINE ???* **?折?怨疏???**嚗internalOrders` 撖拇????隞?batched?rite ?Ｙ?憭? IN 鈭斗?嚗?鞎函??OUT??
### b. 璅∪? / API

??嚗inventoryItems`, 摮???`transactions`; `stockCountJobs`, `internalOrders`.
API 蝭?嚗POST /api/inventory/transfer` (摨???嚗POST /api/stock-count/{jobId}/submit`.

### c. 摰嚗???
* Rules嚗?迂撠?`transactions` ?啣?嚗?甇Ｖ耨?孵?歹??日?? `role >= supervisor`??* 撱箇?蝝Ｗ? (`itemId`,`createdAt`) 隞交?游??閰Ｕ?* 撌桃????BigQuery?浩XPORT ?舀?箸???Batch嚗?撠?Firestore?aggregation??
### d. ?詨捆??
瘝輻?暹? `inventoryItems` 甈?嚗??漱?隤宏?啣???嚗?敶梢 `?漲?日?` 隞瘚???
---

\##?????航????刻?甈??批??狼enant?涅solation+蝝啁?摨???

### a. ?詨??芣

1. **?惜?**嚗?
   * Firestore?爹ules ??霅?`resource.data.tenantId == request.auth.token.tenantId`??   * Cloud?涌unction middleware `withTenantScope()` ?活瑼Ｘ??2. **Row?evel Role?烘asks**嚗?芾??浥WT?畚laims 撖怠 `roles: {storeId: 'manager'}`嚗unctions 靘楝敺???撠?3. **甈?蝝?撖?*嚗customerPhone`,`lineId` 蝑誑 Cloud?涔MS 撠迂??嚗摮?`ciphertext`嚗??????聆胼?痂anager?臬閫????4. **??瑼?**嚗鞈?PDF ??GCS?胼??特igned?狹RL 30?痂in嚗蝳??ACL??
### b. 鋆撥

* 撱箇? `firestore.rules.spec.ts` 皜祈岫 100% 閬???* 雿輻 **Firebase?App?Check** + **Rate?imiter** Extension ?脩??
---

\##?????舐頂蝯望??質??舀撅?
### a. ?亥岷?芸?

* **???辣**嚗???璁??撖怠 `stats/{storeId}`嚗?蝡臬霈銝蝑?憭??* **Cursor?ased ??**嚗??恣???啣?銵?API 蝯曹? `?pageSize=30&cursor=...`??
### b. Cloud?涌unction ?瑕???
* 撠?API?tyle ?賢???`minInstances = 1`??* ?洵銝 SDK (line, pay) ??lazy?mport嚗蒂??esbuild?眩ree?haking??
### c. ?⊿?皛曉??舀

* ?啣? `/api/{collection}/scroll` 餈? `(items, nextCursor)`嚗?蝡?IntersectionObserver??
---

\##?????舫隤方????Ｗ儔

### a. 蝯曹??航炊獢

```ts
// Function ??throw new AppError('PAYROLL_CALC_FAIL', '?芾?閮?憭望?', { retry: true });
```

?垢?嗅 `{code,message,retryable}`??
### b. ?岫蝑

* **Idempotent?Key**嚗 header ??`X-Idempotency-Key`; Functions ? `idempotencyKeys`??* **Pub/Sub?浴LQ**嚗?閰?3 甈∩?憭望? ???典 dead-letter topic 銝阡 Telegram??
### c. ??嚗?霅?
* Cloud?Logging metric?ased alert嚗?瘚?/ ?箏 / ?芾? Job 憭望??喳?霅艾?
---

\##?????舀?葫閰行瑽?
| 撅斤?                           | 撌亙                                    | ???單               | CI?舀???                 |
| ---------------------------- | ------------------------------------- | ------------------ | ---------------------- |
| ?桀?                           | Jest + ts?ock                        | ?賢?蝝?頛?             | `npm test`             |
| Firebase Emulator End?o?nd | `firebase emulators:exec` + Supertest | API & Rules ?冽?蝔?   | `npm run int-test`     |
| 憭?? Mock                    | WireMock / MSW                        | LINE Pay, Uber?API | CI 雿蔡 stub?server      |
| 憯? & ?箸?                      | k6                                    | 100?盍eq/s 3?痂in    | 閫貊 GitHub?Actions ???曉?|

皜祈岫?啣???`.env.test` ??璅⊥?剁?GitHub?Actions ????閮?deploy??
---

\##?????舐??嗥??賡望?蝞∠?

### a. 閮 & 閮祥

* `plans`, `subscriptions`, `usageCounters`; Scheduler ?蝝航? API ?澆 / 摮???* Stripe?浮illing Webhook ??Cloud?爹un?疾ndpoint 閮?隞狡 ???湔 `subscriptions.status`.

### b. 鞈???

Middleware `checkQuota(type, tenantId)` 霈 `usageCounters`嚗?憿? 402?烈ayment?Required??憿澆??Super?涉dmin 敺隤踵??
### c. ?遢?蝘?
* Nightly `gcloud firestore export gs://{bucket}/tenant-{id}-{date}`??* ?? `/admin/migrateTenant`嚗???蝘鞈? export?胼??疳mport ?唳 Firebase?project嚗蒂?郊 `auth` users??* ?芰??嗆??? `export`, 閮?30?舀靽?嚗?敺?Cloud?Scheduler 皜▲??
---

### 潃臭?銝甇亥?????
1. 撱箇? `bonusEngine`, `inventoryTransactions`, `tenantBilling` 銝?Cloud?涌unction?舐黎蝯蒂?啣神 Firestore?爹ules 皜祈岫??2. ??`firestore.indexes.json` ??啁揣撘??湔 CI ??摰? WireMock?stub??3. Super?涉dmin 敺?啣???鞎?& ????蝐歹?隞?Vue/React?table?臬???`subscriptions`.
4. ???寥隤斗???middleware ??啁??Functions嚗uth, order, payroll嚗岫頝?5. ??staging ??雿祕靘閮剖?嚗?撖??撱園?臬雿 500?痂s ?格???
?迨頝舐?鋆?敺????勗??芋蝯?餈啜PI ?嗆????冽??嗥?銝?憭扳嚗??**??鈭敦?刻?蝞?皜祈岫嚗?批惜??*嚗靘??撠? SaaS ?停??撖血蝷?**蝜潛???閰喟敦鞈?**

?冽??末蝜潛???霈??喳隞?賣閬憭敦蝭??郊隤芣???????靘?銝蜓閬????嗆?嚗?典?賡?閬脖?甇仿餈啣擃敦蝭??西??琿?閮??????靘?嚗祕雿郊撽誨蝣潛?畾萸irestore 閬??loud Functions 蝯?蝑????臭誑?? JSON 蝭???????蝔???

**蝜潛???閰喟敦甇仿?**

?函鼓鋆賢?銵冽?ｇ???航?鼠?抬?雿?瘜蝙??Graphviz嚗?銝?湔?? Mermaid 隞?Ⅳ???潛?嗆???蝣箄?瘙誨蝣潘??迂?隞亦匱蝥?靘?鈭擃遙??蝝啁?隤芣???嗆?航?閬??郊撽?閰喟敦撖虫?瑼Ｘ銵剁????臭誨蝣潘?銝虫??航撣??亦????芾???瑼?鞈?靘炎?亦?瑽??見??潮脖?甇亦Ⅱ靽摰寞扼?

撌脫?28 蝘?


銝??銝頛芣??箇????臬之?芸????蝔?撅斤????湔蝯虫??舀??脣?獢? **Firestore?爹ules嚗揣撘?靘loud?涌unctions?舫爸?嗚見??JSON?I?航?祈?暺?*??冽窒?其??暹?鞈?璅∪???雿??蝣箔? **100?? ?詨捆**??
---

## 1???涌irestore?盍ules嚗nippets嚗?
```rules
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function isTenantMember(tid) {
      return request.auth.token.tenantId == tid;
    }
    function role(storeId) {
      return request.auth.token.roles[storeId];
    }

    /** ?梁嚗????敹?撣?tenantId */
    match /{col}/{doc} {
      allow read, write: if false; // ?身撠?
    }

    /* 摨怠??銝駁???*/
    match /inventoryItems/{itemId} {
      allow read:  if isTenantMember(resource.data.tenantId);
      allow write: if isTenantMember(request.resource.data.tenantId)
                   && role(request.resource.data.storeId) in ['manager', 'owner'];
      match /transactions/{txId} {
        allow create: if isTenantMember(resource.parent.data.tenantId);
        allow update, delete: if false;   // ?芸??啣?嚗??甇瑕
      }
    }

    /* ?芾? */
    match /salaryRecords/{period}/{uid} {
      allow read:  if request.auth.uid == uid
                   || role(get(/databases/$(db)/documents/employees/$(uid)).data.storeId)
                      in ['manager', 'owner'];
      allow write: if false; // ?芷?敺垢 Functions 撖怠
    }

    /* 蝟餌絞閮剖????嗥?鞈? */
    match /tenants/{tenantId} {
      allow read, write: if role('GLOBAL') == 'superadmin';
    }
  }
}
```

*??*嚗?
* ?炎 `tenantId` ???炎 `roles`嚗?雿??`Employees.role` ??`Tenants` 銵其?????* `transactions` ? `create` 靽?摰餈賣滲??
---

## 2???病irestore.indexes.json?荔??啣??挾嚗?
```json
[
  {
    "collectionGroup": "salaryRecords",
    "queryScope": "COLLECTION_GROUP",
    "fields": [
      { "fieldPath": "tenantId", "order": "ASCENDING" },
      { "fieldPath": "period",   "order": "DESCENDING" }
    ]
  },
  {
    "collectionGroup": "transactions",
    "queryScope": "COLLECTION_GROUP",
    "fields": [
      { "fieldPath": "itemId",    "order": "ASCENDING" },
      { "fieldPath": "createdAt", "order": "DESCENDING" }
    ]
  },
  {
    "collectionGroup": "usageCounters",
    "queryScope": "COLLECTION_GROUP",
    "fields": [
      { "fieldPath": "tenantId", "order": "ASCENDING" },
      { "fieldPath": "period",   "order": "DESCENDING" }
    ]
  }
]
```

??蝯揣撘????芾??亥”?澈摮?瘞游????梢?憿絞閮?
---

## 3???浚loud?涌unctions?舫爸?塚?TypeScript?18+嚗?
### a. bonusEngine.ts

```ts
export const evaluateBonusTasksScheduled = onSchedule("every 24 hours", async () => {
  const bonusCfgSnap = await db.collection("bonusConfigs")
     .where("active", "==", true)
     .get();                           // 撌脣鞈?銵其葉摰儔 :contentReference[oaicite:2]{index=2}:contentReference[oaicite:3]{index=3}

  for (const cfg of bonusCfgSnap.docs) {
    const { type, calculation } = cfg.data();
    const targetEmployees = await queryEmployeesFor(cfg); // 靘?KPI ???    const batch = db.batch();

    targetEmployees.forEach(emp => {
      const ref = db.collection("bonusEvents").doc();
      batch.set(ref, {
        tenantId: emp.data().tenantId,
        employeeId: emp.id,
        cfgId: cfg.id,
        amount: calcBonus(emp, calculation),
        status: "pending",
        createdAt: FieldValue.serverTimestamp()
      });
    });

    await batch.commit();
  }
});
```

### b. inventory.ts

```ts
export const onInternalOrderApproved = onDocumentWritten(
  "internalOrders/{orderId}",
  async (change, ctx) => {
    const after = change.after.data();
    if (after?.status !== "approved") return;

    const batch = db.batch();
    for (const line of after.items) {
      const txRef = db.collection(`inventoryItems/${line.itemId}/transactions`).doc();
      batch.set(txRef, {
        tenantId: after.tenantId,
        storeId: after.storeId,
        qty: line.qty,
        type: "IN",
        refOrder: ctx.params.orderId,
        createdAt: FieldValue.serverTimestamp()
      });
    }
    await batch.commit();
  }
);
```

### c. billing.ts

```ts
export const onStripeWebhook = https.onRequest(async (req, res) => {
  const event = stripe.constructEvent(req.rawBody, req.headers["stripe-signature"], secret);
  if (event.type === "invoice.payment_succeeded") {
    const { customer, period_start, period_end } = event.data.object;
    await db.collection("subscriptions")
      .doc(customer)
      .set({ status: "active", period_start, period_end }, { merge: true });
  }
  res.json({ received: true });
});
```

---

## 4???舀見?砂浥SON嚗?撾畔seed-data.json`嚗?
```jsonc
{
  "bonusConfigs": [
    {
      "id": "KPI_Q1",
      "type": "蝮暹???",
      "calculation": { "expr": "sales * 0.05", "minScore": 80 },
      "active": true,
      "tenantId": "demoTenant"
    }
  ],
  "taxTables": [
    { "year": 2025, "brackets": [
      { "min": 0,        "max": 560000,  "rate": 0.05, "deduct": 0 },
      { "min": 560001,   "max": 1260000, "rate": 0.12, "deduct": 39200 }
    ]}
  ],
  "inventoryItems": [
    {
      "itemId": "oil_20L",
      "tenantId": "demoTenant",
      "storeId": "樴?",
      "name": "瘝寞▲ 20L",
      "unit": "獢?,
      "stock": 12,
      "reorderPoint": 5
    }
  ],
  "salaryRecords/202504": {
    "uid_abc": {
      "tenantId": "demoTenant",
      "baseSalary": 48000,
      "bonusTotal": 5300,
      "withholdingTax": 1200,
      "finalSalary": 52100
    }
  }
}
```

---

## 5???浚I / 皜祈岫?單閬?嚗itHub?Actions嚗?
```yaml
name: CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run lint
      - run: firebase emulators:exec --project demo "npm run int-test"
      - run: npm run k6:smoke   # 蝪∠?憯?皜?  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: firebase deploy --only functions,firestore:indexes,firestore:rules
```

* ?寞??勗??Ｘ???GitHub?Actions 撱箄降甈?撱嗡撓 ??
---

## 6???舐??/ ?郎嚗?敹蛛?

* **Cloud?Logging Metrics**嚗jsonPayload.errorCode` ?臬?芾??? ??閮剛郎蝷粹?瑼鳴?>0 in 5?痂in嚗?* **Uptime Check**嚗??`/healthz` on Cloud?爹un, 憭望???LINE?烤otify Bot??* **BigQuery Export**嚗? transactions / orders 瘥 dump嚗? Looker?特tudio ?銵冽??
---

## 7???舫??潸?TODO?舫?蝔?

| Sprint   | ?格?                                  | Issue Key |
| -------- | ----------------------------------- | --------- |
| 2025?20 | 摰? bonusEngine & salaryRecords Flow | PAY??01   |
| 2025?21 | 銝? inventory?眩ransactions + ?日?撌桃?芸???| INV??8    |
| 2025?22 | 閮蝞∠? & Stripe Webhook               | BILL??5   |
| 2025?23 | ?啣神 rules ?桀?皜祈岫閬??胼??0??             | SEC??3    |
| 2025?24 | ?函蔡 CI/CD + k6 憯葫?箇?                  | DEV??2    |

---

### ?∴???乩?靘閬蝝堆?

* **閬??氯畔firestore.rules` 嚗?*
* **????bonusEngine / inventory ??摨?嚗?*
* **???蝡舀?雿?(salary?iew\.html) 鋆?JSON 蝷箔?嚗?*

頝?隤芸銝憛???銝?嚗?

**瘙箏?敺??批捆**

?冽???末??銵函內隞?賣閬匱蝥?隢??冽葫隞??銋???頛臬???隞?Ⅳ獢嚗?瘝??Ⅱ??瘙?嗅?賡?閬憭敦蝭嚗?????隞交?靘??渡? Firestore.rules?onusEngine ??inventory ????嚗??瘞渲????垢摮挾 JSON 蝭????府?豢????芯??蒂蝜潛??脰?嚗?銋迂?憟賢??????擃?憟賬?

**???辣????*

?迤?刻??隞?Ⅳ?蝙?冽?摮??膩摨????臭誑??摰??Firestore.rules ?辣?onusEngine ??inventory ?????膩?瘞渲????Ｙ? JSON 蝭?嚗蒂隤芣?憒??游????批捆?鈭?蝣箸改???閰脣??冽?隞塚?銝衣?辣??靘?曄?摰對?靘??????喟??蝝?????獢??嗡??策?末??閮望撣?蝜潛??脰?嚗??炎?乩?銝?

撌脫?25 蝘?


隞乩??湔???渡??涌irestore?爹ules v1.0?璇敹?蝔???摮?摨???隞亙??畔salary?iew.html`?臬?蝡舀?雿?JSON?舐內靘?甈∠策朣?冽窒?其??勗?銝剔?甈??賢????典????舐?亥?鋆賢撠???
---

## 1???畔firestore.rules`?臬??渲?獢?
```rules
rules_version = '2';
service cloud.firestore {

  /** 漎? ?梁撌亙?賢? */
  function isTenantMember(tid) {
    return request.auth.token != null
           && request.auth.token.tenantId == tid;
  }
  function role(storeId) {
    // ?芾? claims:  roles.{storeId} = 'staff' | 'leader' | 'manager' | 'owner'
    return request.auth.token.roles[storeId];
  }
  function isSuperAdmin() {
    return request.auth.token.globalRole == 'superadmin';
  }

  match /databases/{database}/documents {

    /** ? ?身?券撠?嚗? match ????*/
    match /{document=**} {
      allow read, write: if false;
    }

    /* ????????????????
       ? 蝘?頂蝯梯身摰?       ???????????????? */
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }
    match /settings/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    /* ????????????????
       ??????∪極???剖惜
       ???????????????? */
    match /employees/{uid} {
      allow read:  if request.auth.uid == uid
                   || role(resource.data.storeId) in ['manager', 'owner'];
      allow create, update: if isTenantMember(request.resource.data.tenantId)
                   && role(request.resource.data.storeId) in ['manager', 'owner'];
      allow delete: if false; // ?芸?閮望?閮??    }

    match /shifts/{shiftId} {
      allow read:  if isTenantMember(resource.data.tenantId);
      allow write: if role(request.resource.data.storeId) in ['manager', 'owner'];
    }

    /* ????????????????
       ? ?芾?????       ???????????????? */
    match /salaryRecords/{period}/{uid} {
      allow read:  if request.auth.uid == uid
                   || role(get(/databases/$(database)/documents/employees/$(uid)).data.storeId)
                      in ['manager', 'owner'];
      allow write: if false; // ??Cloud Functions
    }

    match /bonusConfigs/{docId} {
      allow read:  if isTenantMember(resource.data.tenantId);
      allow write: if role(request.resource.data.storeId) in ['owner']; // ?芣????孵撘?    }

    match /bonusEvents/{docId} {
      allow read:  if isTenantMember(resource.data.tenantId)
                   && (request.auth.uid == resource.data.employeeId
                       || role(resource.data.storeId) in ['manager','owner']);
      allow create: if false; // ??Functions 撖怠
      allow update: if false;
      allow delete: if false;
    }

    /* ????????????????
       ? 摨怠?
       ???????????????? */
    match /inventoryItems/{itemId} {
      allow read:  if isTenantMember(resource.data.tenantId);
      allow write: if role(request.resource.data.storeId) in ['leader','manager','owner'];

      match /transactions/{txId} {
        allow create: if isTenantMember(resource.parent.data.tenantId);
        allow update, delete: if false; // 銝?寞風??      }
    }

    /* ????????????????
       ?屁 閮???       ???????????????? */
    match /orders/{orderId} {
      allow read, write: if isTenantMember(resource.data.tenantId);
    }
    match /salesReports/{docId} {
      allow read:  if isTenantMember(resource.data.tenantId);
      allow write: if role(resource.data.storeId) in ['leader','manager','owner'];
    }

    /* ????????????????
       ?? Audit & Log
       ???????????????? */
    match /auditLogs/{logId} {
      allow read:  if isSuperAdmin();
      allow write: if false; // Functions only
    }
  }
}
```

甇?rules 撘 **tenant?涅d ??撽? + store?ole 蝝啁?摨行???*嚗?雿??雿??典?朣撌乓澈摮鞈????迂????鞈?摮??
---

## 2???舀?蝔?摮?摨?嚗陛撖怎?嚗?
### (A) `evaluateBonusTasksScheduled`

```
Scheduler (瘥 03:00)
    ??Cloud Function evaluateBonusTasksScheduled
    ??> 霈??bonusConfigs(active=true)
    ??> queryEmployees ??皜
    ??> 撠?雿撌伐?
    ??    ??> 閮? amount
    ??    ??> batchedWrite ??bonusEvents(pending)
    ??> Cloud Logging: JOB_OK
```

*敺? `finalizePayroll` ?潭?摨? `bonusEvents(status=pending)` ?臬?`salaryRecords` 銝行?閮?processed.*

### (B) `internalOrders`?胼??臬澈摮漱??
```
摨撖拇 internalOrder = "approved"
        ??(Firestore trigger onInternalOrderApproved)
Cloud?Function
        ?? loop items[]
        ??   ?? create inventoryItems/{item}/transactions (type=IN)
        ?? batched commit (<=500)
        ???湔 inventoryItems.stock via transaction
        ??? LINE Bot ?鞎典摨怠???```

?璇?蝔?????Function 撉冽蝷箔???
---

## 3???畔salary?iew.html` ?垢甈? JSON 蝷箔?

```json
{
  "period": "2025??4",
  "employee": {
    "employeeId": "emp_123",
    "name": "暺???
  },
  "details": [
    { "label": "摨",   "amount": 48000 },
    { "label": "撟單??", "amount": 3200 },
    { "label": "?瑕??", "amount": 2100 },
    { "label": "?脣??狡", "amount": -300 },
    { "label": "?敺???像", "amount": -1200 }
  ],
  "totals": {
    "gross": 53300,
    "net":   52100
  },
  "exportPdfUrl": "https://storage.googleapis.com/.../payslip_emp_123_202504.pdf"
}
```

?垢憿舐內撱箄降嚗details` ??table??畔totals` ?函?擃?`exportPdfUrl` 蝯艾?頛鞈???迨?澆???鞈?摮 `salaryRecords` 甈?銝?朝?
---

### ??銝甇亙遣霅?
* **rules ?函蔡**嚗firebase deploy --only firestore:rules` 敺?? Emulator 頝?`npm run int?est` 隞仿 rule 鋡急???* **Function ?游?**嚗?撉冽?賢???rules 銝剔? collection path 靽?銝?湛??踹? 404??* **?垢銝脫**嚗salary?iew.html` 霈??`salaryRecords/{period}/{uid}` 敺?銝膩蝯?皜脫??喳??
?仿??唾? **PlantUML ???憭?API Swagger 摰儔** ??**k6 ?箸??單**嚗?牧?胼舀???銝敦??

**Processing user response**

?冽???末??餈??喟?隞賑?亙?鈭?銋???閫?餈瓷??蝖株?瘙?銝甇乓??隞亦?瘚?隞砍?賢??誧蝏哨?瘥??舐??lantUML?橘?餈Swagger?辣嚗??k6???嗆瓷??蝖株秩??銝甇伐?雿蛹鈭??典嚗??臭誑撠??圈嚗????芯?憿對???餈????唳瓷??甇仿炊?＆?誘嚗?霈詹末?停???冽撌脫說頞喃??餌??亥秩嚗??臭蜓?券?桃?隞賑?單楛?亙銝芷??

撌脫?25 蝘?


?嗅嚗?涌irestore?爹ules??摨?頛航??盎alary?iew?浥SON?舐?靘撌脣??游停蝺??乩?靘閬?瘛勗?嚗?銝?撣貉??脤??賊?嚗?臭誑?湔暺?嚗?
1. **API?特wagger/OpenAPI 摰儔** ????畜onusEngine?nventory?臭漱?illing?疾ndpoint?臬神??臬?烈ostman/Swagger?狹I ?玆AML??2. **PlantUML ?嗆?嚗?摨?瑼?* ???? `.puml`嚗??湔皜脫? PNG嚗??repo ??`/docs/`嚗靘輻陛?望?蝬剛風??3. **k6 憯?皜祈??* ???? `/api/salary`?/api/inventory/transfer` 蝑??菔楝敺???100?盍eq/s?紐??痂in ?箇?皜祈岫??GitHub?涉ctions 蝭???
?? ?湔?迄?? #1??2??3?臭葉?銝????剁????停擐砌?鋆?撠?瑼?嚗?撘Ⅳ?挾??

**Providing requested options**

The user wants all three: Swagger/OpenAPI definitions, PlantUML diagrams, and k6 scripts. For the API definitions, I'll provide YAML for the bonus config/event endpoints, inventory transfer, and billing webhook. Then, I'll create PlantUML files for the architecture/sequence diagrams. Finally, I?l supply k6 stress test scripts with GitHub Actions. I'll deliver everything directly in chat rather than using the canvas document; providing code snippets here should be more practical for the user? needs.


撌脫?10 蝘?


隞乩?銝甈∩漱隞?**銝之?Ｗ** ???賢?湔銴ˊ??repo嚗?
---

## 1. OpenAPI??.1?臬?蝢抬?`openapi-chicken.yaml`嚗?
```yaml
openapi: 3.1.0
info:
  title: EatChicken SaaS API
  version: "1.0.0"
servers:
  - url: https://api.friedg.app/v1
    description: Production
  - url: http://localhost:5001/{projectId}/us-central1
    description: Firebase Emulator
    variables:
      projectId:
        default: friedg-dev
paths:
  /bonus-configs:
    get:
      summary: List active bonus configs
      tags: [Bonus]
      parameters:
        - $ref: "#/components/parameters/TenantId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: {$ref: "#/components/schemas/BonusConfig"}
    post:
      summary: Create a bonus config
      tags: [Bonus]
      parameters:
        - $ref: "#/components/parameters/TenantId"
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: "#/components/schemas/BonusConfigInput"}
      responses:
        "201": {$ref: "#/components/responses/Created"}
  /bonus-events:
    get:
      summary: List bonus events for current user
      tags: [Bonus]
      parameters:
        - $ref: "#/components/parameters/TenantId"
        - in: query
          name: status
          schema: {type: string, enum: [pending, processed]}
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items: {$ref: "#/components/schemas/BonusEvent"}
  /inventory/transfer:
    post:
      summary: Transfer / receive inventory between stores
      tags: [Inventory]
      parameters:
        - $ref: "#/components/parameters/TenantId"
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: "#/components/schemas/InventoryTransferRequest"}
      responses:
        "202":
          description: Accepted ??transactions queued
  /stock-count/{jobId}/submit:
    post:
      summary: Submit physical stock?ount result
      tags: [Inventory]
      parameters:
        - $ref: "#/components/parameters/TenantId"
        - name: jobId
          in: path
          required: true
          schema: {type: string}
      requestBody:
        required: true
        content:
          application/json:
            schema: {$ref: "#/components/schemas/StockCountSubmit"}
      responses:
        "200": {description: Count accepted}
  /billing/stripe-webhook:
    post:
      summary: Stripe webhook endpoint (internal)
      tags: [Billing]
      requestBody:
        required: true
        content:
          application/json:
            schema: {type: object}
      responses:
        "204": {description: Processed}

components:
  parameters:
    TenantId:
      name: X-Tenant-Id
      in: header
      required: true
      schema: {type: string}
  responses:
    Created:
      description: Resource created
      headers:
        Location:
          schema: {type: string}
  schemas:
    BonusConfig:
      type: object
      properties:
        id: {type: string}
        type: {type: string}
        calculation: {type: object}
        active: {type: boolean}
    BonusConfigInput:
      allOf:
        - $ref: "#/components/schemas/BonusConfig"
        - required: [type, calculation]
    BonusEvent:
      type: object
      properties:
        id: {type: string}
        employeeId: {type: string}
        amount: {type: number}
        status: {type: string}
        createdAt: {type: string, format: date-time}
    InventoryTransferRequest:
      type: object
      required: [sourceStoreId, targetStoreId, items]
      properties:
        sourceStoreId: {type: string}
        targetStoreId: {type: string}
        items:
          type: array
          items:
            type: object
            required: [itemId, qty]
            properties:
              itemId: {type: string}
              qty: {type: number}
    StockCountSubmit:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            type: object
            required: [itemId, countedQty]
            properties:
              itemId: {type: string}
              countedQty: {type: number}
```

> ?晦舐?交??`/docs/openapi-chicken.yaml`嚗 Swagger?I ??Postman ?臬?喳??
---

## 2. PlantUML ?? (`docs/bonusEngine.puml` & `docs/inventoryFlow.puml`)

### a. bonusEngine嚗?蝔???閮嚗?
```plantuml
@startuml bonusEngine
actor Scheduler
entity "bonusConfigs" as CFG
database "bonusEvents" as BE
database "salaryRecords" as SR

Scheduler -> CFG : query active configs
CFG --> Scheduler : list
Scheduler -> BE : batch insert\n(status=pending)
Scheduler --> BE : write OK
Scheduler --> SR : (end of month) \naggregate + write
BE -> SR : update status=processed
@enduml
```

### b. internalOrder ?亙澈鈭斗?

```plantuml
@startuml inventoryFlow
actor 摨 as Manager
database "internalOrders" as IO
database "inventoryItems" as INV
database "transactions" as TX

Manager -> IO : approve order
IO -> CloudFunction : onWrite trigger
CloudFunction -> TX : create IN transactions (batch)
CloudFunction -> INV : update stock via transaction
CloudFunction -> LINEBot : ?摰?
@enduml
```

> ?晦臬摮 `.puml`嚗S?浚ode PlantUML ??plantuml?li ?臭??菔? PNG??
---

## 3. k6 憯?皜祈??(`tests/load_salary.js`)

```js
import http from 'k6/http';
import { sleep, check } from 'k6';
export let options = {
  stages: [
    { duration: '1m', target: 100 },  // ramp to 100?狽U
    { duration: '2m', target: 100 },
    { duration: '30s', target: 0 },
  ],
  thresholds: { http_req_failed: ['rate<0.01'], http_req_duration: ['p(95)<400'] },
};

const BASE = `${__ENV.API_URL || 'https://api.friedg.app/v1'}`;

export default function () {
  const params = {
    headers: {
      'X-Tenant-Id': 'demoTenant',
      Authorization: `Bearer ${__ENV.TOKEN}`,
    },
  };
  const res = http.get(`${BASE}/salary?period=202504`, params);
  check(res, { '200 OK': r => r.status === 200 });
  sleep(1);
}
```

### GitHub?Actions 蝭??挾嚗蕭? workflow嚗?
```yaml
  k6-load:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/load_salary.js
        env:
          API_URL: https://api.staging.friedg.app/v1
          TOKEN: ${{ secrets.STAGING_TEST_JWT }}
```

---

### ?? 摰?

* **OpenAPI?玆AML** ??`/docs/openapi-chicken.yaml`
* **PlantUML** ??`/docs/*.puml`
* **k6?盎cript + Actions** ??`/tests/` ??`.github/workflows/ci.yml`

???獢???餈?Firestore?舐?瑽loud?涌unctions?皰ath 摰撠???? **?游?蝡舫?** ??**?芸???PDF ?Ｚˊ瘚?**嚗??閮湔?嚗?


**Searching for version update feature**

From the documents, I haven? found an explicit mention of a version check or update feature. However, based on an earlier conversation from May 2nd, the user requested the addition of a version verification update system for their PWA. I should definitely review sections related to optimization or PWA architecture in the docs, as they may include this information. It seems the user wanted help planning this feature, so I?l make sure to confirm whether it's covered later on.




### ?桀??辣鋆～??祇?霅?/ ?單??湔?????雿?

| 靘?畾菔                      | 撌脫??啁??批捆                                       | 閰摯                                                               |
| ------------------------- | -------------------------------------------- | ---------------------------------------------------------------- |
| **?函蔡?雁?遣霅?6.4?胯??砍?蝝??乓?*??| 撱箄降?∟????嚗emVer嚗???Staging 撽????澈?瑞宏????詨捆    | **撅祆 DevOps 瘚??批**??蝣箔??雿???航◤????roll?ut嚗?**銝行隢?垢 PWA 撘瑕?湔** |
| **?垢?嗆? (PWA) 隤芣?**??       | ?? Service?Worker ?蝺翰??摰?                 | ??Service?Worker嚗??辣瘝?撖怒皜祆?蒂?內雿輻???琿??摩                         |
| ?嗡?蝡?                      | ?芣?撠???祆炎??/ update check / force reload???餈?| ??                                                               |

> **蝯?嚗?*
> ?函銵?葉嚗?*?芣??潔?撅日???砍?蝝??乓?*嚗?瘝???蝯垢雿輻????唳??撖血?蝝啁???撠望隤芬??
> *CI/CD ??雿?Runtime Version Check ???賢??

---

### 憒?鋆撥嚗???祇?霅?& 撘瑕?湔璈嚗?湔蝝?曇??嗆?嚗?
| 甇仿?                       | ?琿???                                                                                                                                                             | ??頂蝯勗???                         |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------- |
| 1. **閮餃??瑼?*             | ?兩涌irebase?浹osting ?寧??銝??`/version.json`嚗摰?`{ "version": "1.3.5", "releasedAt": "2025??5??5T12:00:00Z" }`?I ?券蝵脫????芸?撖怠 *package.json* ??`version`             | 銝?隞颱? Firestore嚗?臭?????           |
| 2. **Service?Worker ??** | ??`sw.js` ??`self.addEventListener('message')` 鋆?`skipWaiting()`嚗蒂??`clients.claim()` 敺? **3?痂in** 隞?`fetch('/version.json', {cache:'no-store'})` 瘥??砍 `version` | ?暹? Service?Worker ?嗆?撌脣?辣?嚗?湔?游? |
| 3. **?垢?內**              | ?亙皜砍?????憿舐內 Toast嚗頂蝯勗歇??嚗????啗??乓?暺?敺??`registration.waiting.postMessage('SKIP_WAITING')`                                                                     | 銝???Firebase Auth ??API          |
| 4. **撘瑕?湔?賊?**            | 撠撌亦垢?OS 蝡胯閮剖? `forceUpdate=true`嚗神??`/version.json` 鋆∴?嚗?蝡舀?啣停?湔 `window.location.reload(true)`                                                                  | ?芣溶銝????雿?銝蔣?踹恥蝡?                  |
| 5. **?啣漲?潔? + Rollback**   | ?拍 **Feature?Flag**嚗歇閬?嚗捱摰鈭?`storeId` ??唳? URL嚗?航炊??擃?????獢楝敺?                                                                                                | ??`FeatureFlags` ???游?嚗辣?函?摨行???  |

> 憒迨?喳嚗?>
> * **CI** ?????撖恍?`/version.json` ??> * **Service?Worker** 摰?瘥? ??> * **雿輻??* ??內?◤撘瑕 reload ??> * **?啣漲** ??Feature?lag ?批 ???亙仃??**Rollback** 隞?CDN 敹恍????
??瘚?摰 **銝?霈? Firestore/Functions 蝯?嚗??辣?詨捆**嚗??賭?霅撌亥?憿批恥蝡?3???臬???芸????唳??啣?蝡舐?撘Ⅳ??閬閰喟敦??`sw.js` 蝭???GitHub?Actions ?湔?單嚗??迄??




**10. ?∪極???⊥??嗅漲嚗ynamic Equity Framework嚗?*

> ?祉??箝????曆???POS ???啁恣?頂蝯???撠??銵??澆???撱嗡撓蝡?嚗?雿 *??. 蝮賜???蝥郊撽? 銋?嚗靘踵靘??祉?乩葡?乓?
---

### 10.1 蝡??桃???函???
* 撱箇?頝典?摨??港??舐?撘??撌交??∴???﹦??折?∴??嗅漲??* ???銵?瘚?閬嚗蝙????舀 **v1.1** 敺?銵銝剛?啜?* ?拍?潦??抵??桅???銝????????嚗蒂?? SaaS ?征??
### 10.2 ??摰儔

| ?迂                           | 隤芣?                           |
| :--------------------------- | :--------------------------- |
| **?瘙?(Equity Pool)**        | 瘥??? 10???0?% ?∩遢嚗?靘撌亥?鞈潘????|
| **???(Phantom Share)**      | ?澈??蝝??⊥捱蝑?蟡冽?嚗?閮剜芋撘誑??瘜鞎???   |
| **撖西 (Class?B??∟”瘙箸???**       | ?砍?亦閮祕擃?鞈??臬?????西????嚗?望?瘙箄降??  |
| **Good?Leaver / Bad?Leaver** | ?舀折?瘀???折?瘀??其誑瘙箏??頃?寞??        |

### 10.3 ?嗅漲蝮質汗

| 憿       | ?詨?閬                    | ?銵暺?                                     |
| :------- | :---------------------- | :---------------------------------------- |
| **?⊥?憿?** | ?身?Phantom嚗?祕??        | `legal_config/{storeId}.equity_type`      |
| **?∪極銝?** | ?犖 ??0?%?/ 摨??∪極蝮賢? ??9?% | `equity_pool.remaining_cap` ?芸?瑼Ｘ          |
| **鞈**   | 甇?皛螞????+ 撟喳?閰? ??       | Cloud?Function `checkEquityEligibility()` |
| **鞈潸蝒** | 瘥迤??5?憭?               | `purchase_window_open` flag + Scheduler   |
| **隡啣潭??* | 瘥僑?1/7?????瘛典 ?4 繩100???| `revalueShares()`???                      |
| **??**   | (?%) ? (摮?楊????蝵株??     | `autoDistributeDividends()`               |
| **?Ｚ?頃** | Good 85??00?%?隡啣潘?Bad 雿 | `exit_type` 瘙箏? `repurchase_price`         |
| **?折頧?** | 蝟餌絞?桀?嚗摯??簣10?% ?寞撣?      | `internal_match_orders` collection        |

### 10.4 ?∪?摯?澆撘?
```
瘥?寞 嚗???餈?12 ?像??敺楊?押?? 4 繩 100 ???摮?漲?筑??嚗???簣20?嚗?```

> **?酉**嚗摨撠??皛蹂?撟湛???*餈?3??像??? 8 繩100* 銋?摰摯?潦?
### 10.5 ?∩遢瘙恣??蝔???

1. **?⊥?瘙?憪?**嚗遣摨???`initStore()` Function 撖怠 `equity_pool`嚗?
   ```json
   { "total_shares": 100, "pool_shares": 15, "remaining_cap": 15,
     "equity_type": "phantom", "valuation": 600000 }
   ```
2. **瘜**嚗?
   * Phantom ?∴???∪極??嚗惇?芾??敺?   * ?亙?靘??祕?∴??蝡?憓?蝚玲?35???璇撌亙?蝝?摰蒂摰?憓??餉???3. **?敺?**嚗頂蝯望?潭????閮?`tax_category`=`salary`?dividend` 靘?閮甈∠?蝜單??柴?
### 10.6 ?∩遢??瘚?

```mermaid
flowchart TD
  A[鞈瑼Ｘ] -->|蝚血?| B(?鞈潸/?)
  B --> C{???孵?}
  C -->|蝮暹???| D[??] --> E[??銝撟弼
  C -->|?暸?/?芾?鞎瑁| F[隤頃?唾?] --> G[撖拇 & 隞狡] --> E
  E --> H[撖怠 employee_equity]
```

* **????*嚗??⊿?摰?1?撟湛?隤頃?? 6???* **??隞狡**嚗installments` 甈? (1??)嚗unction `processInstallmentDebit()` 瘥?????
### 10.7 ??閮? & ?潭

```math
?∪極?? = ?% ? max(0, 摮?楊??- ?芸?鋆??
```

* `dividend_snapshot_{yyyyQn}` ?澆迤蝯??Ｙ?敹怎嚗??敺??∟??蔣?踴?* Cloud?Function `autoDistributeDividends()` ?潮?LINE?Pay ?膜銝血神??`equity_payouts`??
### 10.8 ?Ｚ??鞈?
| ?Ｚ憿        | ?∩遢?蔭   | ?頃??              | ??      |
| :---------- | :----- | :---------------- | :------ |
| Good?烊eaver | ?砍?芸??頃 | 85??00?%?隡啣?      | 60?憭拙摰? |
| Bad?烊eaver  | ?∩遢?喳?蝯? | 隤頃?寞? 50?%?隡啣?(??) | ?單?      |
| 甇颱滿          | 銝匱??   | 隤頃?孵???            | 90?憭?   |

### 10.9 ?折頧?璈

* 蝟餌絞?澆迤蝯?敺洵?1????仿???`internal_trade_window=true`??* ?∪極?臭? `sell_order` / `buy_order`嚗?撌栽簣10?%?隡啣潦?* ?漱??1?% 撟喳??鞎鳴?撖怠 `equity_transactions`??
### 10.10 憸券暺?撠?餈質馱

| #  | 憸券     | 撠?                             | Owner   |
| :- | :----- | :----------------------------- | :------ |
| 1  | 隡啣潭郭??憭?| 撠??簣20?%+?僑摨阡?隡?                | Finance |
| 2  | ?頃鞈?銝雲 | 瘥迤? 2?% 瘛典??`buyback_reserve` | CFO     |
| 3  | 瘜??啣?   | 撟游漲瘜撖拇                         | Legal   |

### 10.11 Firestore 蝯?嚗?暺?

```text
stores/{storeId}/equity_pool
employee_equity/{userId}_{storeId}
internal_match_orders/{orderId}
equity_transactions/{txId}
equity_payouts/{snapshotId}/details/{userId}
legal_config/{storeId}
```

### 10.12 ?詨? Cloud?Functions

| Function                                     | 隤芣?                  | 閫貊?孵?            |
| :------------------------------------------- | :------------------ | :-------------- |
| `checkEquityEligibility`                     | ?∪極??璇辣撖?flag        | HTTPS (蝞∠???     |
| `openPurchaseWindow` / `closePurchaseWindow` | 閮剖?鞈潸??              | Cloud?Scheduler |
| `revalueShares`                              | ?摯?∪嚗??`valuation` | ?僑??            |
| `autoDistributeDividends`                    | ????銝行??            | 摮??蝔?            |
| `processInstallmentDebit`                    | ??隞狡                | ??蝔?            |

### 10.13 ?芯??游?

* **v2**嚗閬??⊥??銵冽?DF??⊥?霅?I?隡啣潭芋??* **v3**嚗楊蝘嚗aaS嚗甈??氬???ESOP ?蔥?銝???
---

> **摰?甇斤?敺??港遢?勗?撠?蝝 V1.1嚗遣霅啣??. 蝮賜???蝥郊撽??粹??? #10嚗?撖虫??∪極???⊥??嗅漲?詨????UI*??*








**10. ??芣扔????????撞??ynamic Equity Framework??*

> ?蟡??蝞???豯??????POS ??????????????????蛔??瞉鼓???????勗?蹎????選?謘?*"9. ?株??????伐??* ????謘?頦蛔秤????蟡??銋抵?銋?

---

### 10.1 ?∵???獢???叟遛?????

* ?梁?????制??蹓??皜?????????漱?????謜?儮????????撞??
* ??????蛔??播??秋赯萄??寡???赤?謢???謘?**v1.1** ?綽??蛔???????
* ????瞏汕??????獢??????????伍??賹??蹎????????? SaaS ?謘曉?????

### 10.2 ????堊垓??
| ???                         | ?方?                                       |
| :--------------------------- | :----------------------------------------- |
| **?蹓橫???(Equity Pool)** | ?伍???? 10 ??20 % ??拚?????⊥?鈭??????赤??   |
| **?謜??(Phantom Share)** | ??格????????交?■??∪?????桀????啗?????蹓?蹎???|
| **?正蹌?(Class B ???蝞???** | ????鈭佇貝?殉朱蟡?????????謜????镼?????蹌????????|
| **Good Leaver / Bad Leaver** | ?????????豯改????????嗉?????豯折??撖僱??        |

### 10.3 ??撞?株釭瘙?
| ?遴竣??        | ?閰??秋赯?                      | ???蛔?行?                                         |
| :----------- | :----------------------------- | :------------------------------------------------ |
| **????遴竣?** | ??澈 Phantom?蹓?????        | `legal_config/{storeId}.equity_type`            |
| **??芣扔???** | ??? ??0 % / ?制不???芣扔?株郭? ??9 % | `equity_pool.remaining_cap` ????潘撓貔?             |
| **?赯?* | ??蹓??6 ??+ ???堊?? ??      | Cloud Function `checkEquityEligibility()`         |
| **?螂蹌?謅** | ?伍餈??? 5 ??                 | `purchase_window_open` flag + Scheduler           |
| **?∪?瞏叟???* | ?伍??1/7 ??????????4 蝜?00 ??| `revalueShares()` ???                            |
| **???** | (?蹓橫?%) ? (??璆??????菜謒??   | `autoDistributeDividends()`                       |
| **?嚗綜??豯折?** | Good 85??00 % ?∪?瞏?Bad ?遴???  | `exit_type` ??? `repurchase_price`               |
| **??賊??** | ??蝯?獢??????蝪?0 % ?撖僱??   | `internal_match_orders` collection                |

### 10.4 ??迎???冽?瞉??

?伍蹌?撖僱 ????擗?12 ?????岑???綽璆??撢?? 4 蝜?100 ??
??瞍??衣????????蝪?0 ??

> **?謕?**?奕?謅??垮謓?賹?????????*擗?3 ?????? 8 蝜?00* ????堆???瞏汕?

### 10.5 ??拚???????????

1.  **???????迎??**?城??謅???`initStore()` Function ? `equity_pool`??
    ```json
    { "total_shares": 100, "pool_shares": 15, "remaining_cap": 15,
      "equity_type": "phantom", "valuation": 600000 }
    ```
2.  **?蹓?*??
    * Phantom ????謅冪??芣扔???????????綜???
    * ?鈭?????謜????????∵???竣???235?? ???⊥?鈭????堊垢????筆??擗???
3.  **???綜??**?垓????瞏叟?????蹇???`tax_category`=`salary`??寮ividend` ????殷??瑞???賹????朝?

### 10.6 ??拚?謘??播?

```mermaid
flowchart TD
  A[?赯萇嚗賃?] -->|???| B(????螂蹌???)
  B --> C{?謘??摮?}
  C -->|?格????| D[?????] --> E[?謘???撮
  C -->|???/?????蹌 F[?歹?????] --> G[??赯?& ?朵?（ --> E
  E --> H[? employee_equity]
```

* **?謘???*?契??????1 ????歹???謘? 6 ???
* **????朵??*??installments` ??? (1??)??unction `processInstallmentDebit()` ?伍???謘??

### 10.7 ????殷?? & ?瞏叟?

??芣扔??? = ?蹓橫?% ? max(0, ??璆??- ????鬼謒??

* `dividend_snapshot_{yyyyQn}` ?瞉縣?荒???嚗??寞?蹓????綽???????頦朝?
* Cloud Function `autoDistributeDividends()` ?瞏捍?LINE Pay ?????蟡??`equity_payouts`??

### 10.8 ?嚗綜??????

| ?嚗綜??遴竣??     | ??拚??∟     | ?豯折???                 | ?蹇?      |
| :------------ | :----------- | :---------------------- | :-------- |
| Good Leaver   | ???????豯折? | 85??00 % ?∪??          | 60 ?剜??望?? |
| Bad Leaver    | ??拚?????  | ?歹???撖? 50 % ?∪??(?謘?) | ???      |
| ?２皛?         | ?????      | ?歹???摮???             | 90 ??    |

### 10.9 ??賊??????
* ??蝯?瞉縣?荒???綽瘣?1?? ?隞???`internal_trade_window=true`??
* ??芣扔??? `sell_order` / `buy_order`???????Ｙ除10 % ?∪?瞏汕?
* ??摹??1 % ??????陷?? `equity_transactions`??

### 10.10 ?詨謇菜豯????擗釭擐?
| #  | ?詨謇?        | ???                         | Owner   |
| :--- | :----------- | :--------------------------- | :------ |
| 1  | ?∪?瞏剝?????| ?撚? 蝪?0 %+???????       | Finance |
| 2  | ?豯折???????| ?伍餈??? 2 % ????`buyback_reserve` | CFO     |
| 3  | ?????     | ?虜瞍脩??????貔?                | Legal   |

### 10.11 Firestore ?荒??????綜筑?

```text
stores/{storeId}/equity_pool
employee_equity/{userId}_{storeId}
internal_match_orders/{orderId}
equity_transactions/{txId}
equity_payouts/{snapshotId}/details/{userId}
legal_config/{storeId}
```

### 10.12 ?閰? Cloud Functions

| Function                             | ?方?                 | ?怨?謒?摮?         |
| :----------------------------------- | :------------------- | :--------------- |
| `checkEquityEligibility`             | ??芣扔?????颲???flag    | HTTPS (?????   |
| `openPurchaseWindow` / `closePurchaseWindow` | ?桀???螂蹌?謅?         | Cloud Scheduler  |
| `revalueShares`                      | ????迎???謆??`valuation` | ??????         |
| `autoDistributeDividends`            | ?賹?????????        | ?????          |
| `processInstallmentDebit`            | ??謘?謢瑞             | ?????          |

### 10.13 ????皜?

* **v2**?城?駁謘???????萄豰?蹍F ????謆?蹎遐 ?∪?瞏剛????
* **v3**?奕璆?賹???aaS?蹌????瘞玲蹓???ESOP ???蹓橫??????

---

> **?堆????綽???皜舫??????垓蹌?V1.1??????祗??. ?株??????伐?貔螞???蝎???赤??梱? #10??????芣扔????????撞?閰??賹???UI*??* 


**10. ?∪極???⊥??嗅漲嚗ynamic Equity Framework嚗?*

> ?祉??箝????曆???POS ???啁恣?頂蝯???撠??銵??澆???撱嗡撓蝡?嚗?雿 *"9. 蝮賜???蝥郊撽?* 銋?嚗靘踵靘??祉?乩葡?乓?

---

### 10.1 蝡??桃???函???

* 撱箇?頝典?摨??港??舐?撘??撌交??∴???﹦??折?∴??嗅漲??
* ???銵?瘚?閬嚗蝙????舀 **v1.1** 敺?銵銝剛?啜?
* ?拍?潦??抵??桅???銝????????嚗蒂?? SaaS ?征??

### 10.2 ??摰儔

| ?迂                         | 隤芣?                                       |
| :--------------------------- | :----------------------------------------- |
| **?瘙?(Equity Pool)** | 瘥??? 10 ??20 % ?∩遢嚗?靘撌亥?鞈潘????   |
| **???(Phantom Share)** | ?澈??蝝??⊥捱蝑?蟡冽?嚗?閮剜芋撘誑??瘜鞎???|
| **撖西 (Class B ?∟”瘙箸???** | ?砍?亦閮祕擃?鞈??臬?????西????嚗?望?瘙箄降??|
| **Good Leaver / Bad Leaver** | ?舀折?瘀???折?瘀??其誑瘙箏??頃?寞??        |

### 10.3 ?嗅漲蝮質汗

| 憿         | ?詨?閬                       | ?銵暺?                                         |
| :----------- | :----------------------------- | :------------------------------------------------ |
| **?⊥?憿?** | ?身 Phantom嚗?祕??        | `legal_config/{storeId}.equity_type`            |
| **?∪極銝?** | ?犖 ??0 % / 摨??∪極蝮賢? ??9 % | `equity_pool.remaining_cap` ?芸?瑼Ｘ              |
| **鞈** | 甇?皛?6 ??+ 撟喳?閰? ??      | Cloud Function `checkEquityEligibility()`         |
| **鞈潸蝒** | 瘥迤? 5 憭?                 | `purchase_window_open` flag + Scheduler           |
| **隡啣潭??* | 瘥僑 1/7 ????瘛典 ?4 繩100 ??| `revalueShares()` ??                            |
| **??** | (?%) ? (摮?楊????蝵株??   | `autoDistributeDividends()`                       |
| **?Ｚ?頃** | Good 85??00 % 隡啣潘?Bad 雿   | `exit_type` 瘙箏? `repurchase_price`               |
| **?折頧?** | 蝟餌絞?桀?嚗摯??簣10 % ?寞撣?   | `internal_match_orders` collection                |

### 10.4 ?∪?摯?澆撘?

瘥?寞 嚗???餈?12 ?像??敺楊?押?? 4 繩 100 ??
摮?漲?筑??嚗???簣20 嚗?

> **?酉**嚗摨撠??皛蹂?撟湛???*餈?3 ?像??? 8 繩100* 銋?摰摯?潦?

### 10.5 ?∩遢瘙恣??蝔???

1.  **?⊥?瘙?憪?**嚗遣摨???`initStore()` Function 撖怠 `equity_pool`嚗?
    ```json
    { "total_shares": 100, "pool_shares": 15, "remaining_cap": 15,
      "equity_type": "phantom", "valuation": 600000 }
    ```
2.  **瘜**嚗?
    * Phantom ?∴???∪極??嚗惇?芾??敺?
    * ?亙?靘??祕?∴??蝡?憓?蝚?235?? 璇撌亙?蝝?摰蒂摰?憓??餉???
3.  **?敺?**嚗頂蝯望?潭????閮?`tax_category`=`salary`?dividend` 靘?閮甈∠?蝜單??柴?

### 10.6 ?∩遢??瘚?

```mermaid
flowchart TD
  A[鞈瑼Ｘ] -->|蝚血?| B(?鞈潸/?)
  B --> C{???孵?}
  C -->|蝮暹???| D[??] --> E[??銝撟弼
  C -->|?暸?/?芾?鞎瑁| F[隤頃?唾?] --> G[撖拇 & 隞狡] --> E
  E --> H[撖怠 employee_equity]
```

* **????*嚗??⊿?摰?1 撟湛?隤頃?? 6 ??
* **??隞狡**嚗installments` 甈? (1??)嚗unction `processInstallmentDebit()` 瘥?????

### 10.7 ??閮? & ?潭

?∪極?? = ?% ? max(0, 摮?楊??- ?芸?鋆??

* `dividend_snapshot_{yyyyQn}` ?澆迤蝯??Ｙ?敹怎嚗??敺??∟??蔣?踴?
* Cloud Function `autoDistributeDividends()` ?潮?LINE Pay ?膜銝血神??`equity_payouts`??

### 10.8 ?Ｚ??鞈?

| ?Ｚ憿      | ?∩遢?蔭     | ?頃??                 | ??      |
| :------------ | :----------- | :---------------------- | :-------- |
| Good Leaver   | ?砍?芸??頃 | 85??00 % 隡啣?          | 60 憭拙摰? |
| Bad Leaver    | ?∩遢?喳?蝯?  | 隤頃?寞? 50 % 隡啣?(??) | ?單?      |
| 甇颱滿          | 銝匱??      | 隤頃?孵???             | 90 憭?    |

### 10.9 ?折頧?璈

* 蝟餌絞?澆迤蝯?敺洵 1?? ?仿???`internal_trade_window=true`??
* ?∪極?臭? `sell_order` / `buy_order`嚗?撌栽簣10 % 隡啣潦?
* ?漱??1 % 撟喳??鞎鳴?撖怠 `equity_transactions`??

### 10.10 憸券暺?撠?餈質馱

| #  | 憸券         | 撠?                         | Owner   |
| :--- | :----------- | :--------------------------- | :------ |
| 1  | 隡啣潭郭??憭?| 撠? 簣20 %+?僑摨阡?隡?       | Finance |
| 2  | ?頃鞈?銝雲 | 瘥迤? 2 % 瘛典??`buyback_reserve` | CFO     |
| 3  | 瘜??啣?     | 撟游漲瘜撖拇                 | Legal   |

### 10.11 Firestore 蝯?嚗?暺?

```text
stores/{storeId}/equity_pool
employee_equity/{userId}_{storeId}
internal_match_orders/{orderId}
equity_transactions/{txId}
equity_payouts/{snapshotId}/details/{userId}
legal_config/{storeId}
```

### 10.12 ?詨? Cloud Functions

| Function                             | 隤芣?                 | 閫貊?孵?         |
| :----------------------------------- | :------------------- | :--------------- |
| `checkEquityEligibility`             | ?∪極??璇辣撖?flag    | HTTPS (蝞∠???   |
| `openPurchaseWindow` / `closePurchaseWindow` | 閮剖?鞈潸??         | Cloud Scheduler  |
| `revalueShares`                      | ?摯?∪嚗??`valuation` | ?僑??         |
| `autoDistributeDividends`            | ????銝行??        | 摮??蝔?          |
| `processInstallmentDebit`            | ??隞狡             | ??蝔?          |

### 10.13 ?芯??游?

* **v2**嚗閬??⊥??銵冽?DF ?⊥?霅?I 隡啣潭芋??
* **v3**嚗楊蝘嚗aaS嚗甈??氬???ESOP ?蔥?銝???

---

> **摰?甇斤?敺??港遢?勗?撠?蝝 V1.1嚗遣霅啣??. 蝮賜???蝥郊撽??粹??? #10嚗?撖虫??∪極???⊥??嗅漲?詨????UI*??* 
