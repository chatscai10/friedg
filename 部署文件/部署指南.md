# 專案部署指南

本指南提供了部署「吃雞排找不早」POS系統各個組件的詳細步驟。

## 0. 前置準備

1.  **獲取最新代碼**:
    ```bash
    git clone <your-repository-url>
    cd friedg # 或者您的專案根目錄名稱
    git pull origin main # 或者您的主要分支
    ```
2.  **安裝 Firebase CLI**:
    如果您尚未安裝 Firebase CLI，請按照官方指南進行安裝：
    [https://firebase.google.com/docs/cli#setup_update_cli](https://firebase.google.com/docs/cli#setup_update_cli)
    ```bash
    npm install -g firebase-tools
    ```
3.  **登入 Firebase**:
    ```bash
    firebase login
    ```
4.  **選擇 Firebase 專案**:
    確保您已在本地 Firebase CLI 中選擇了正確的 Firebase 專案。
    ```bash
    firebase use <your-project-id>
    ```
    您可以通過 `firebase projects:list` 查看可用的專案。
5.  **配置環境變量**:
    *   **Cloud Functions**: 根據 `部署文件/環境變量說明.md` 中的指示，為您的 Cloud Functions 配置環境變量。這通常通過 Firebase Functions Config 來完成：
        ```bash
        firebase functions:config:set someservice.key="THE API KEY" someservice.id="THE CLIENT ID"
        # 例如 LINE Pay:
        firebase functions:config:set linepay.channel_id="YOUR_LINE_PAY_CHANNEL_ID"
        firebase functions:config:set linepay.channel_secret_key="YOUR_LINE_PAY_SECRET_KEY"
        firebase functions:config:set linepay.api_url="https://sandbox-api-pay.line.me" # 或生產環境URL
        firebase functions:config:set linepay.cloud_function_base_url="YOUR_FUNCTIONS_BASE_URL_FOR_CALLBACKS"
        firebase functions:config:set linepay.customer_pwa_base_url="YOUR_CUSTOMER_PWA_URL_FOR_REDIRECTS"
        # 其他必要的環境變量，如 SMTP 服務器、API 金鑰等
        firebase functions:config:set nodemailer.user="your-email@example.com"
        firebase functions:config:set nodemailer.pass="your-email-password"
        # ... 更多配置 ...
        ```
        獲取當前配置：`firebase functions:config:get > .runtimeconfig.json` (注意不要提交此文件到版本控制)
    *   **前端應用 (PWA)**: `ceg-customer-pwa` 和 `web-admin` 中的 Firebase SDK 初始化通常使用專案根目錄下的 `.firebaserc` 和 `firebase.json` 中的配置自動處理，或者在構建時通過環境變量（例如 VITE_FIREBASE_API_KEY）注入。請參考 `部署文件/環境變量說明.md` 確保前端構建時能獲取到正確的 Firebase 配置。

## 1. Firebase Cloud Functions 部署

### 1.1. 安裝依賴
在部署 Functions 之前，確保 `functions` 目錄下的依賴已安裝：
```bash
cd functions
npm install
cd ..
```

### 1.2. 部署所有 Cloud Functions
此命令將部署 `functions/src/index.ts` (或 `index.js`) 中導出的所有 v1 和 v2 HTTP 函數、Callable 函數以及背景觸發器。
```bash
firebase deploy --only functions
```

### 1.3. 選擇性部署特定 Cloud Functions (推薦用於更新)
如果您只想更新特定的函數組，可以使用更細粒度的部署命令。這可以加快部署速度並減少對其他函數的影響。

**部署所有 v2 HTTPs Endpoints (Express Apps):**
(假設它們在 `firebase.json` 中有 `region` 和 `source` 屬性，或Firebase CLI能自動檢測)
```bash
# 部署在 firebase.json -> functions 下定義的特定函數，例如 Express Apps
firebase deploy --only functions:adminApiV2
firebase deploy --only functions:storesApiV2
firebase deploy --only functions:ordersApiV2
firebase deploy --only functions:paymentsApiV2
firebase deploy --only functions:inventoryApiV2 # 如果 inventoryApiV2 被導出並配置
```

**部署特定的 Callable Functions:**
```bash
firebase deploy --only functions:setUserRoleV2
firebase deploy --only functions:deductStockCallable # 假設有這個Callable版本
# ... 其他 Callable Functions
```

**部署所有 v1 Functions (如果還有):**
如果 `firebase.json` 中 functions 列表包含 v1 函數的定義，它們會被 `firebase deploy --only functions` 一起部署。
如果只想部署特定的 v1 函數，例如：
```bash
# firebase deploy --only functions:yourV1FunctionName
```

**注意事項**:
*   首次部署時，建議部署所有函數以確保所有端點都已建立。
*   後續更新時，優先使用細粒度部署。
*   檢查 Firebase Console 中的 Functions 日誌以確認部署成功和函數運行狀況。
*   如果您的函數有 `runtime` 選項 (如 Node.js 16, 18, 20)，請確保在 `firebase.json` 或函數代碼中指定。

## 2. Firestore 數據庫部署

### 2.1. 部署 Firestore 安全規則
此命令將部署位於專案根目錄下 `firestore.rules` 文件中定義的安全規則。
```bash
firebase deploy --only firestore:rules
```
或者，如果您的規則文件名不同或路徑不同，請在 `firebase.json` 的 `firestore.rules` 字段中指定。

### 2.2. 部署 Firestore 索引
此命令將部署位於專案根目錄下 `firestore.indexes.json` 文件中定義的複合索引。
```bash
firebase deploy --only firestore:indexes
```
**注意事項**:
*   索引的創建可能需要一些時間，具體取決於數據庫的大小。您可以在 Firebase Console 的 Firestore > Indexes 標籤頁中監控索引的構建狀態。
*   在本地開發和測試期間，Firebase Emulator Suite 可以幫助您生成所需的索引配置。

## 3. Firebase Storage 部署

### 3.1. 部署 Storage 安全規則
此命令將部署位於專案根目錄下 `storage.rules` 文件中定義的 Firebase Storage 安全規則。
```bash
firebase deploy --only storage
```
或者，如果您的規則文件名不同或路徑不同，請在 `firebase.json` 的 `storage.rules` 字段中指定。

## 4. 顧客點餐PWA (`ceg-customer-pwa`) 部署

假設您在 `firebase.json` 的 `hosting` 配置中，為顧客PWA定義了一個名為 `customer-pwa-site` (或其他您選擇的名稱) 的 site。

```json
// firebase.json 示例片段
{
  "hosting": [
    {
      "target": "customer-pwa-site", // 用您的 site target 名稱替換
      "public": "ceg-customer-pwa/dist", // Vite 默認構建輸出目錄
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        // ... PWA 的 rewrites，例如 API 代理和 SPA fallback
        {
          "source": "/api/**", // 代理到 Cloud Functions
          "function": "yourApiFunctionOrApp" // 例如 ordersApiV2
        },
        {
          "source": "**", // SPA fallback
          "destination": "/index.html"
        }
      ]
    },
    // ... 其他 hosting sites
  ]
}
```

**部署步驟**:
1.  **進入 PWA 目錄**:
    ```bash
    cd ceg-customer-pwa
    ```
2.  **安裝依賴**:
    ```bash
    npm install
    ```
3.  **構建 PWA**:
    此命令通常會執行 `vite build` (根據 `package.json` 中的 `build` 腳本)。
    ```bash
    npm run build
    ```
4.  **返回專案根目錄 (可選，取決於您的部署習慣)**:
    ```bash
    cd ..
    ```
5.  **部署到 Firebase Hosting**:
    確保 `<your-customer-pwa-site-target>` 與 `firebase.json` 中 `hosting`數組裏該 PWA 的 `target` 名稱一致。如果只有一個 hosting site，可以省略 `--only hosting:<target>` 直接使用 `firebase deploy --only hosting`。
    ```bash
    firebase deploy --only hosting:customer-pwa-site 
    # 或者，如果您在 ceg-customer-pwa 目錄下執行，並且 firebase.json 配置正確，也可以直接：
    # firebase deploy --only hosting
    # (前提是 firebase.json 中只有一個 hosting site，或者默認 site 是顧客PWA)
    ```

## 5. 管理後台 (`web-admin`) 部署

假設您在 `firebase.json` 的 `hosting` 配置中，為管理後台定義了一個名為 `admin-site` (或其他您選擇的名稱) 的 site。

```json
// firebase.json 示例片段
{
  "hosting": [
    // ... customer PWA site ...
    {
      "target": "admin-site", // 用您的 site target 名稱替換
      "public": "web-admin/dist", // Vite 默認構建輸出目錄
      "ignore": [
        "firebase.json",
        "**/.*",
        "**/node_modules/**"
      ],
      "rewrites": [
        // ... 管理後台的 rewrites，例如 API 代理和 SPA fallback
         {
          "source": "/api/**", // 代理到 Cloud Functions
          "function": "yourApiFunctionOrApp" // 例如 adminApiV2
        },
        {
          "source": "**", // SPA fallback
          "destination": "/index.html"
        }
      ]
    }
  ]
}
```

**部署步驟**:
1.  **進入管理後台目錄**:
    ```bash
    cd web-admin
    ```
2.  **安裝依賴**:
    ```bash
    npm install
    ```
3.  **構建管理後台**:
    此命令通常會執行 `vite build` (根據 `package.json` 中的 `build` 腳本)。
    ```bash
    npm run build
    ```
4.  **返回專案根目錄 (可選)**:
    ```bash
    cd ..
    ```
5.  **部署到 Firebase Hosting**:
    確保 `<your-admin-site-target>` 與 `firebase.json` 中 `hosting`數組裏該 PWA 的 `target` 名稱一致。
    ```bash
    firebase deploy --only hosting:admin-site
    ```

## 6. 總體部署 (不推薦用於生產環境的首次部署或重大更新)

如果您想一次性部署所有 Firebase 服務的更改（Functions, Firestore rules, Hosting 等）：
```bash
firebase deploy
```
**警告**: 除非您清楚所有更改的影響，否則不建議對生產環境使用此命令進行首次部署或重大更新。建議分階段、按服務進行部署，並密切監控。

## 7. 部署後檢查

*   訪問您部署的 PWA 和管理後台的 URL，確保它們按預期運行。
*   檢查 Firebase Console 中的 Functions 日誌，確保沒有運行時錯誤。
*   測試核心功能，如用戶認證、下單、支付、庫存更新等。

---

**請根據您 `firebase.json` 中的實際 `target` 名稱和函數名稱調整上述指令中的佔位符。** 